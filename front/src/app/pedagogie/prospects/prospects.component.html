  <!-- Partie ajout de documents -->
  <div class="col-12" *ngIf="showUploadFile!=null">
    <div class="card">
        <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="showUploadFile = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showUploadFile.user_id && users[showUploadFile.user_id]" class="text-center"
            style="font-weight: bold;">Ajouter un document à : {{
            users[showUploadFile.user_id]?.firstname }} {{
            users[showUploadFile.user_id]?.lastname | uppercase }}</h3>
        <form class="col-8 col-offset-2">
            <div class="p-grid">
                <div style="margin-left: 32%;">
                    <p-fileUpload (uploadHandler)="FileUpload($event)" mode="basic"
                        chooseLabel="Ajouter un Document" customUpload="true" fileLimit="1"
                        accept=".docx,.pdf,.doc,.jpg,.png,.jpeg" maxFileSize="10000000" [auto]="true" #fileInput>
                    </p-fileUpload>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- partie Assignation à un Groupe -->
<div class="col-12" *ngIf="showAssignForm!=null">
    <div class="card">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showAssignForm = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showAssignForm.user_id && users[showAssignForm.user_id]" class="text-center"
            style="font-weight: bold;">Assignation de : {{
            users[showAssignForm.user_id]?.firstname }} {{
            users[showAssignForm.user_id]?.lastname | uppercase }}
        </h3>

        <form class="p-fluid p-formgrid grid" [formGroup]="AssignForm" (ngSubmit)="onAddEtudiant()">
            <div class="field col-12 md:col-6">
                <label>Groupe</label>
                <p-dropdown [options]="groupeList" emptyFilterMessage="Pas de groupe trouvé" filterPlaceholder="Groupe"
                    filter="true" formControlName="groupe"></p-dropdown>
            </div>
            <div class="field col-12 md:col-6">
                <label>Statut</label>
                <p-dropdown [options]="statutList" formControlName="statut" optionLabel="value"></p-dropdown>
            </div>

            <!-- Si c'est un alternant -->
            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="ine">Numéro INE</label>
                <input pInputText type="text" formControlName="numero_ine" placeholder="Numéro INE">
            </div>

            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="nir">Numéro NIR</label>
                <input pInputText type="text" formControlName="numero_nir" placeholder="Numéro NIR">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="sos_email">Email d'urgence</label>
                <input pInputText type="email" formControlName="sos_email" placeholder="Adresse email d'un proche">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="sos_phone">Téléphone d'urgence</label>
                <input pInputText type="text" formControlName="sos_phone" placeholder="Numéro de téléphone d'un proche">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="entreprise">Entreprise</label>
                <input pInputText type="text" formControlName="entreprise"
                    placeholder="Veuillez saisir le nom de l'entreprise">
            </div>

            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="nom_tuteur">Nom du tuteur</label>
                <input pInputText type="text" formControlName="nom_tuteur" placeholder="Nom du tuteur d'alternance">
            </div>

            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="prenom_tuteur">Prenom du tuteur</label>
                <input pInputText type="text" formControlName="prenom_tuteur"
                    placeholder="Prenom du tuteur d'alternance">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="adresse_tuteur">Adresse du tuteur</label>
                <textarea pInputText type="text" formControlName="adresse_tuteur"
                    placeholder="Adresse du tuteur d'alternance"></textarea>
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="email_tuteur">Adresse email du tuteur</label>
                <input pInputText type="email" formControlName="email_tuteur"
                    placeholder="Adresse email du tuteur d'alternance">
            </div>

            <div class="field col-4 md:col-3" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="indicatif_tuteur">Indicatif</label>
                <input pInputText type="text" formControlName="indicatif_tuteur" placeholder="Exemple: 00223">
            </div>

            <div class="field col-8 md:col-9" *ngIf="AssignForm.value.statut.value == 'Alternant'">
                <label for="phone_tuteur">Numéro de téléphone du tuteur</label>
                <input pInputText type="text" formControlName="phone_tuteur" placeholder="Exemple: 667717326">
            </div>
            <!-- End -->


            <!-- Si c'est un étudiant -->
            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Etudiant'">
                <label for="sos_email">Email d'urgence</label>
                <input pInputText type="text" formControlName="sos_email" placeholder="Adresse email d'un proche">
            </div>

            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Etudiant'">
                <label for="sos_phone">Téléphone d'urgence</label>
                <input pInputText type="text" formControlName="sos_phone" placeholder="Numéro de téléphone d'un proche">
            </div>

            <!-- Si c'est un étudiant mineur -->
            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Etudiant' && onIsMinor()">
                <label for="nom_rl">Nom du répresentant légal</label>
                <input pInputText type="text" formControlName="nom_rl" placeholder="Nom du répresentant légal">
            </div>

            <div class="field col-6" *ngIf="AssignForm.value.statut.value == 'Etudiant' && onIsMinor()">
                <label for="prenom_rl">Prénom du répresentant légal</label>
                <input pInputText type="text" formControlName="prenom_rl" placeholder="Prénom du répresentant légal">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Etudiant' && onIsMinor()">
                <label for="phone_rl">Numéro de téléphone du répresentant légal</label>
                <input pInputText type="text" formControlName="phone_rl"
                    placeholder="Numéro de téléphone du répresentant légal">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Etudiant' && onIsMinor()">
                <label for="email_rl">Email du répresentant légal</label>
                <input pInputText type="text" formControlName="email_rl" placeholder="Email du répresentant légal">
            </div>

            <div class="field col-12" *ngIf="AssignForm.value.statut.value == 'Etudiant' && onIsMinor()">
                <label for="adresse_rl">Email du répresentant légal</label>
                <textarea pInputTextarea formControlName="adresse_rl"
                    placeholder="Adresse du répresentant légal"></textarea>
            </div>
            <!-- End -->

            <div>
                <button pButton label="Ajouter l'étudiant" type="submit" [disabled]="AssignForm.invalid"></button>
            </div>
        </form>
    </div>
</div>

<!-- Liste des prospects en attente d'une assignation de groupe-->
<div class="col-12">
    <div class="card">
        <h5>Liste des prospects en attente d'assignation</h5>
        <p-toast></p-toast>
        <p-table #dt1 dataKey="_id" [rows]="10" [rowHover]="true" [paginator]="true" rowExpandMode="single"
            [value]="prospects" [paginator]="true" [pageLinks]="5"
            [globalFilterFields]="['type_form', 'statut_actuel', 'validated_academic_level', 'programme','lastname','firstname','formation','statut_dossier','campus_choix_1','campus_choix_2','campus_choix_3','customid']"
            responsiveLayout="scroll" styleClass="p-datatable-gridlines">

            <ng-template pTemplate="caption">
                <span class="p-input-icon-left mb-2">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Recherche" class="w-full" />
                </span>
                <p-dropdown filter="true" placeholder="Tous" [options]="dropdownDecision"
                    (onChange)="dt1.filter($event.value, 'decision_admission', 'equals')"
                    emptyFilterMessage="Pas de decision trouvé" filterPlaceholder="decision" [style]="{'margin':'5px'}">
                </p-dropdown>
                <button pButton icon="pi pi-file" label="Exporter" (click)="exportExcel()" type="button"
                    style="float: right;margin-left:2%" *ngIf="!code">
                </button>
                <div class="flex table-header">
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3rem" scope="col"></th>
                    <th pSortableColumn="customid" scope="col">
                        ID Etudiant <p-sortIcon field="customid"></p-sortIcon>
                    </th>
                    <th pSortableColumn="lastname" scope="col">
                        Nom & Prénom <p-sortIcon field="lastname"></p-sortIcon>
                    </th>
                    <th pSortableColumn="type_form" scope="col">
                        Etablissement <p-sortIcon field="type_form"></p-sortIcon>
                    </th>
                    <th pSortableColumn="formation" scope="col">
                        Formation <p-sortIcon field="formation"></p-sortIcon>
                    </th>
                    <th pSortableColumn="campus_choix_1" scope="col">
                        Campus Choix 1 <p-sortIcon field="campus_choix_1"></p-sortIcon>
                    </th>
                    <th pSortableColumn="nbDoc" scope="col">
                        Nombre de documents <p-sortIcon field="nbDoc"></p-sortIcon>
                    </th>
                    <th pSortableColumn="statut_dossier" scope="col">
                        Statut Dossier <p-sortIcon field="statut_dossier"></p-sortIcon>
                    </th>
                    <th pSortableColumn="action" scope="col">
                        Action
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect let-expanded="expanded">
                <tr>
                    <td>
                        <button type="button" pButton pRipple [pRowToggler]="prospect"
                            class="p-button-text p-button-rounded p-button-plain"
                            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                            (click)="expandRow(prospect)"></button>
                    </td>
                    <td>
                        {{ prospect.customid }}
                    </td>
                    <td
                        *ngIf="prospect.user_id && users[prospect.user_id] && users[prospect.user_id].lastname && users[prospect.user_id].firstname">
                        {{ users[prospect.user_id].lastname | uppercase }}
                        {{ users[prospect.user_id].firstname | titlecase }}
                    </td>
                    <td>
                        {{ prospect.type_form | titlecase }}
                    </td>
                    <td>
                        {{ prospect.formation }}
                    </td>
                    <td>
                        {{ prospect.campus_choix_1 }}
                    </td>
                    <td>
                        {{ prospect.nbDoc }}
                    </td>
                    <td>
                        {{ prospect.statut_dossier }}
                    </td>
                    <td>
                        <i pTooltip="Assigner à un groupe" tooltipPosition="bottom" class="pi pi-bookmark"
                            (click)="showAssignForm=prospect;showUploadFile=null" aria-hidden="true"></i>
                        <i pTooltip="Ajouter un document" tooltipPosition="bottom" class="pi pi-file-pdf"
                            (click)="showUploadFile=prospect" aria-hidden="true"></i>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-prospect>
                <tr>
                    <td colspan="9">
                        <div class="p-3">
                            <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
                                <ng-template pTemplate="header">
                <tr>
                    <th>Date de naissance</th>
                    <th>Nationnalité</th>
                    <th>Pays de résidence</th>
                    <th>Email</th>
                    <th>Statut Pro</th>
                    <th>Téléphone</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect>

            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td>{{ prospect.date_naissance | date: 'dd/MM/yyyy'}}</td>
                    <td>{{users[prospect.user_id].nationnalite}}</td>
                    <td>{{users[prospect.user_id].pays_adresse}}</td>
                    <td>{{users[prospect.user_id].email}}</td>
                    <td>{{prospect.statut_actuel}}</td>
                    <td>
                        {{ users[prospect.user_id].indicatif }}
                        {{ users[prospect.user_id].phone }}
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <br>

        <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
                <tr>
                    <th>Numéro whatsapp</th>
                    <th>Langues</th>
                    <th>Expériences pro</th>
                    <th>Programme choisi</th>
                    <th>Rythme</th>
                    <th>Niveau Académique</th>
                    <th>Statut actuel</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect>

            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td>{{ prospect.indicatif_whatsapp }} {{ prospect.numero_whatsapp }}</td>
                    <td>{{ prospect.languages }}</td>
                    <td>{{ prospect.professional_experience }}</td>
                    <td>{{ prospect.programme }}</td>
                    <td>{{ prospect.rythme_formation}}</td>
                    <td>{{ prospect.validated_academic_level }}</td>
                    <td>{{ prospect.statut_actuel }}</td>
                </tr>
            </ng-template>
        </p-table>


        <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
                <tr>
                    <th>Campus Choix 1</th>
                    <th>Campus Choix 2</th>
                    <th>Campus Choix 3</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect>

            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td>{{ prospect.campus_choix_1 }}</td>
                    <td>{{ prospect.campus_choix_2 }}</td>
                    <td>{{ prospect.campus_choix_3 }}</td>
                </tr>
            </ng-template>
        </p-table>

        <h5 style="text-align: center; color: red;">Service Eduhorizon</h5>
        <ul *ngIf="prospect.servicesEh.includes(true)">
            <li *ngIf="prospect.servicesEh[0]">Orientation et accompagnement à l'admission</li>
            <li *ngIf="prospect.servicesEh[1]">
                Prépa internationale : formation de 3 mois pour augmenter vos chances de
                réussite de votre orientation
            </li>
            <li *ngIf="prospect.servicesEh[2]">
                Accompagnement dossier visa
            </li>
            <li *ngIf="prospect.servicesEh[3]">Logement</li>
            <li *ngIf="prospect.servicesEh[4]">
                Attestation de virement irrévocable (AVI)
            </li>
        </ul>
        <p *ngIf="!prospect.servicesEh.includes(true)">Aucun service EH choisis</p>

        <h5 style="text-align: center; color: red;">Garant</h5>
        <p *ngIf="prospect.nomGarant">{{ prospect.nomGarant }} {{ prospect.prenomGarant }}</p>
        <p *ngIf="!prospect.nomGarant"><strong>Aucun garant declaré</strong></p>

        <h5 style="text-align: center; color: red;">Commercial</h5>

        <p-table responsiveLayout="scroll" *ngIf="prospect.code_commercial" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
                <tr>
                    <th>Code commercial</th>
                    <th>Commercial</th>
                    <th>Agence</th>
                    <th>Date de la demande</th>

                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect>

            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td>{{ prospect.code_commercial }}</td>
                    <td
                        *ngIf="infoCommercialExpand && infoCommercialExpand.user_id && users[infoCommercialExpand.user_id]">
                        {{ users[infoCommercialExpand.user_id].civilite }}
                        {{ users[infoCommercialExpand.user_id].lastname | titlecase | uppercase }}
                        {{ users[infoCommercialExpand.user_id].firstname | titlecase }}
                    </td>
                    <td *ngIf="!infoCommercialExpand"></td>
                    <td *ngIf="prospect.nomAgence">{{ prospect.nomAgence }}</td>
                    <td *ngIf="!prospect.nomAgence" style="color: red;">Ce prospect ne vient pas d'une agence</td>
                    <td><strong>{{ prospect.date_creation | date: 'dd/MM/yyyy' }}</strong></td>

                </tr>
            </ng-template>
        </p-table>

        <p *ngIf="prospect.donneePerso">
            <strong>Ce prospect <span style="color: green;">accepte</span> que ses données personnelles soient
                utilisées</strong>
        </p>

        <p *ngIf="!prospect.donneePerso">
            <strong>Ce prospect <span style="color: red;">réfuse</span> que ses données personnelles soient
                utilisées</strong>
        </p>

        <h5 style="text-align: center; color: red;" *ngIf="prospect.date_traitement">Traitement du dossier</h5>

        <p-table responsiveLayout="scroll" *ngIf="prospect.date_traitement" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="header">
                <tr>
                    <th>Date du dernier traitement</th>
                    <th>Désignation du TCF</th>
                    <th>Agent</th>
                    <th>Phase complémentaire</th>
                    <th>Statut Payement</th>
                    <th>Attestation traité par</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-prospect>

            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td>{{ prospect.date_traitement | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ prospect.tcf }}</td>
                    <td *ngIf="prospect.agent_id && users[prospect.agent_id] && users[prospect.agent_id]">
                        {{ users[prospect.agent_id].civilite }}
                        {{ users[prospect.agent_id].lastname | titlecase | uppercase}}
                        {{ users[prospect.agent_id].firstname | titlecase }}
                    </td>
                    <td>{{prospect.phase_complementaire}}</td>
                    <td>{{prospect.statut_payement}}</td>
                    <td>{{prospect.traited_by}}</td>
                </tr>
            </ng-template>
        </p-table>

        <h5 style="color: red; text-align: center;">Documents</h5>
        <div class="col-12">


            <div *ngIf="ListDocuments==null || ListDocuments.length==0" style="margin: 0 auto;
                                    width: auto;">
                <h4>Aucun document n'a été chargé !</h4>
            </div>


            <div *ngFor="let file of ListDocuments; index as i" class="grid">

                <div class="field col-10 " style="border-style: 2;border: 2em;border-bottom: red;">
                    <i class="pi pi-file-pdf " style="font-size: 20px;cursor: pointer;"
                        pTooltip="Visualiser dans un nouvel onglet" (click)="VisualiserFichier(prospect._id,i)"></i>
                    <em (click)="VisualiserFichier(prospect._id,i)" [id]="i" style="cursor: pointer;"
                        pTooltip=" Visualiser dans un nouvel onglet">
                        {{ ListDocuments[i] }}
                    </em>
                </div>
                <div class="field col-1">
                    <i class="pi pi-download" pTooltip="Télécharger le fichier"
                        style=" float:right;cursor: pointer;font-size: 15px;color: rgb(3, 54, 237);"
                        (click)="downloadFile(prospect._id,i)"></i>
                </div>
                <div class="field col-1">
                    <i class="pi pi-times" style=" float:left;font-size: 15px;cursor:pointer;color: red;"
                        pTooltip="Supprimer le fichier du dossier" (click)="deleteFile(prospect._id,i)"
                        aria-hidden="true"> </i>
                </div>

            </div>
        </div>
    </div>
    </td>
    </tr>
    </ng-template>
    </p-table>
</div>
 