<p-toast></p-toast>
<!-- FORMULAIRE DINSERTION -->
<div class="grid" *ngIf="showFormAddTuteur">
    <div class="col-12">
        <div class="card">
            <i class="pi pi-times-circle"
                style="float:right; margin-right: 30px; font-size: 20px; color: red; cursor: pointer;" pTooltip="Fermer"
                (click)="showFormAddTuteur = false;" aria-hidden="true"> </i>

            <h4 class="col-12" style="text-align: center;">Ajoutez un tuteur à {{entrepriseSelected.r_sociale}}</h4>
            <small>Tous les champs marqués d'un astérix sont obligatoires</small>

            <form class="p-fluid p-formgrid grid" [formGroup]="formAddTuteur" (ngSubmit)="onAddTuteur()">
                <div class="field col-12 md:col-2">
                    <label For="civilite">Civilité</label>
                    <p-dropdown [options]="civiliteList" optionLabel="value" optionDisabled="actif"
                        formControlName="civilite"></p-dropdown>
                </div>
                <div class="field col-12 md:col-5">
                    <label For="prenom">Prénom <span style="color: red">*</span></label>
                    <input pInputText id="firstname" type="text" placeholder="John" formControlName="firstname" />
                </div>

                <div class="field col-12 md:col-5">
                    <label For="nom">Nom  <span style="color: red">*</span></label>
                    <input pInputText id="lastname" type="text" placeholder="Smith" formControlName="lastname" />
                </div>


                <div class="field col-12 md:col-6">
                    <label For="Indicatif">Indicatif </label>
                    <input pInputText id="indicatif" type="text" placeholder="+33" formControlName="indicatif" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Téléphone">Téléphone </label>
                    <input pInputText id="phone" type="text" placeholder="0683838383" name="phone"
                        formControlName="phone" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Fonction">Fonction </label>
                    <input pInputText id="fonction" type="text" placeholder="Chef Marketing"
                        formControlName="fonction" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Ancienneté">Ancienneté </label>
                    <input pInputText id="anciennete" type="text" placeholder="5 ans" formControlName="anciennete" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="niveau_formation">Niveau de formation </label>
                    <input pInputText id="niveau_formation" type="text" placeholder="BAC +5"
                        formControlName="niveau_formation" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Email">Email <span style="color: red">*</span></label>
                    <input pInputText id="email_perso" type="text" placeholder="email@email.com"
                        formControlName="email_perso" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Numéro de l'adresse">Numéro de la rue</label>
                    <input pInputText id="numero_adresse" type="text" placeholder="55"
                        formControlName="numero_adresse" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="rue_adresse">Nom de la rue</label>
                    <input pInputText id="rue_adresse" type="text" placeholder="Rue du Faubourg Saint-Honoré"
                        formControlName="rue_adresse" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Code postale">Code postale</label>
                    <input pInputText id="postal_adresse" type="text" placeholder="75008"
                        formControlName="postal_adresse" />
                </div>
                <div class="field col-12 md:col-6">
                    <label For="Ville">Ville</label>
                    <input pInputText id="ville_adresse" type="text" placeholder="Paris"
                        formControlName="ville_adresse" />
                </div>
                <div class="field col-12 md:col-6">
                    <label For="Pays">Pays</label>
                    <p-dropdown formControlName="pays_adresse" [options]="paysList" optionLabel="viewValue"
                        emptyFilterMessage="Pas de nationalité trouvé" filterPlaceholder="Pays" filter="true">
                    </p-dropdown>
                </div>
                <div class="field col-12 md:col-6">
                    <label For="nationalite">Nationalité</label>
                    <p-dropdown formControlName="nationnalite" [options]="nationList" optionLabel="viewValue"
                        emptyFilterMessage="Pas de nationalité trouvé" filterPlaceholder="Nationalité" filter="true">
                    </p-dropdown>

                </div>

                <div class="field col-12">
                    <label for="date_naissance">Date de naissance </label>
                    <p-calendar formControlName="date_naissance" dateFormat="dd/mm/yy" [minDate]="minDateCalendar"
                        [maxDate]="maxDateCalendar" [readonlyInput]="true" [locale]="fr" [monthNavigator]="true"
                        [yearNavigator]="true" [yearRange]="rangeYear"></p-calendar>
                </div>

                <button pButton label="Ajouter le tuteur" type="submit" [disabled]="formAddTuteur.invalid"></button>
            </form>
        </div>
    </div>
</div>


<!-- FORMULAIRE DE MODIFICATION -->
<div class="grid" *ngIf="showFormUpdateTuteur">
    <div class="col-12 ">
        <div class="card p-fluid">
            <i class="pi pi-times-circle"
                style="float:right; margin-right: 30px; font-size: 20px; color: red; cursor: pointer;" pTooltip="Fermer"
                (click)="showFormUpdateTuteur = false;" aria-hidden="true"> </i>
            <form class="grid" [formGroup]="formUpdateTuteur" (ngSubmit)="onUpdateTuteur()">
                <h5 class="col-12">Modifier un tuteur</h5>
                <div class="field col-12 md:col-6">
                    <label For="Fonction">Fonction </label>
                    <input pInputText id="fonction" type="text" placeholder="Entrez la fonction du tuteur"
                        formControlName="fonction" />
                </div>

                <div class="field col-12 md:col-6">
                    <label For="Ancienneté">Ancienneté </label>
                    <input pInputText id="anciennete" type="text" placeholder="Entrez la fonction du tuteur"
                        formControlName="anciennete" />
                </div>

                <div class="field col-12">
                    <label For="niveau_formation">Niveau de formation </label>
                    <input pInputText id="niveau_formation" type="text" placeholder="Entrez la fonction du tuteur"
                        formControlName="niveau_formation" />
                </div>
                <button pButton label="Modifier" type="submit" [disabled]="formUpdateTuteur.invalid"></button>

            </form>
        </div>
    </div>
</div>

<div class="grid">
    <!-- Liste des tuteurs de l'entreprise -->
    <div class="col-12" *ngIf="showTuteursForEnterprise">
		<div class="card">
			<i class="pi pi-times-circle"
                style="float:right; margin-right: 30px; font-size: 20px; color: red; cursor: pointer;" pTooltip="Fermer"
                (click)="showTuteursForEnterprise = false;" aria-hidden="true"> </i>

            <h5>Liste des tuteurs de {{ entrepriseSelected.r_sociale }}</h5>
			<p-table #dt1 rowExpandMode="single" [value]="tuteurs" dataKey="_id" [rows]="5" [rowHover]="true"
                    styleClass="p-datatable-gridlines" [paginator]="true" [pageLinks]="5" responsiveLayout="scroll">
				
                <ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
                        <span class="p-input-icon-left mb-2">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                placeholder="Recherche" class="w-full" />
                        </span>
                    </div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
                        <th></th>
						<th style="text-align:center">Nom</th>
                        <th style="text-align:center">Prénom</th>
                        <th style="text-align:center">Téléphone</th>
                        <th style="text-align:center">Email</th>
                        <th style="text-align:center">Action</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-tuteur let-expanded="expanded">
					<tr>
						<td>
							<button type="button" pButton pRipple [pRowToggler]="tuteur" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
						</td>
						<td style="min-width: 12rem;" *ngIf="tuteur?.user_id">
                            {{ tuteur.user_id?.lastname }}
                        </td>
                        <td style="min-width: 12rem;">
                            {{ tuteur.user_id?.firstname }}
                        </td>
                        <td>
                            {{ tuteur.user_id?.indicatif }} {{ tuteur.user_id?.phone }}
                        </td>
                        <td>
                            {{ tuteur.user_id?.email_perso}}
                        </td>
    
                        <td style="text-align: center;">
                            <i pTooltip="Modifier" tooltipPosition="bottom" class="pi pi-pencil"
                                (click)="showFormUpdateTuteur = true; onFillForm(tuteur);"
                                aria-hidden="true"></i>
                            <i pTooltip="Lister les alternants du tuteur" tooltipPosition="bottom" class="pi pi-align-justify"
                                [routerLink]="['/liste-contrats/'+tuteur._id]" aria-hidden="true" style="cursor: pointer; color: green; margin-left: 3px;"></i>
                        </td>
					</tr>
				</ng-template>
				<ng-template pTemplate="rowexpansion" let-tuteur>
					<tr>
						<td colspan="6">
							<div class="p-3">
								<p-table responsiveLayout="scroll">
									<ng-template pTemplate="header">
                                        <tr>
                                            <th>Anciennete</th>
                                            <th>Niveau de formation</th>
                                            <th>Fonction</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body">
                                        <tr>
                                            <td colspan="6">Aucun tuteurs sur cette entreprise.</td>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td>{{tuteur.anciennete}}</td>
                                            <td>{{tuteur.niveau_formation}}</td>
                                            <td>{{tuteur.fonction}}</td>
                                        </tr>
                                    </ng-template>
                                </p-table>
		                    </div>
		                </td>
		            </tr>
                </ng-template>
		    </p-table>
	    </div>
	</div>



    


    <!-- Table d'affichage de la liste des entreprises -->
    <div class="col-12">
        <div class="card">
            <h5>Liste des entreprises</h5>
            <small style="color: red;">Pour voir les tuteurs sur une entreprise et acceder aux contrats sous sa tutelle, veuillez choisir une entreprise</small>
			<p-table #dt1 [value]="entreprises" dataKey="_id" [rows]="5" [loading]="loading" [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true" [globalFilterFields]="['r_sociale','fm_juridique','nb_salarie','ville_ent']" responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Rechercher une entreprise" class="w-full"/>
						</span>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th>
							<div class="flex justify-content-between align-items-center">
								Raison sociale
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Forme juridique
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Nombre de salarié
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Ville
							</div>
						</th>
						<th style="width: 8rem">
                        </th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-entreprise>
					<tr>
						<td style="min-width: 12rem;">
							{{entreprise?.r_sociale}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.fm_juridique}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.nb_salarie}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.ville_ent}}
						</td>
						<td class="text-center" style="min-width: 8rem;">
							<i class="pi pi-briefcase" title="Voir les tuteurs sur cette entreprise" style="cursor: pointer; color: blue;" (click)="onLoadTuteurs(entreprise);"></i>
							<i class="pi pi-plus-circle" title="Ajouter un tuteur sur cette entreprise" style="margin-left: 3px; cursor: pointer; color: red;" (click)="entrepriseSelected = entreprise; showFormAddTuteur = true;"></i>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="5">Aucune entreprises trouvés.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="5">Chargement des données...</td>
					</tr>
				</ng-template>
    		</p-table>
        </div>
    </div>
</div>