<p-toast></p-toast>
<div class="grid">
	<!-- To see all contracts for an enterprise -->
	<div class="col-12">
		<div class="card">
			<h5>Liste des contrats de l'entreprise</h5>
			<p-table #dt1 [value]="contracts" dataKey="_id" responsiveLayout="scroll" [rowHover]="true" [paginator]="true" [globalFilterFields]="['_id', 'code_commercial.lastname','code_commercial.firstname','statut','classification','alternant_id.user_id.firstname','alternant_id.user_id.lastname']">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Recherche" class="w-full"/>
						</span>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th style="width: 3rem"></th>
						<th>Prénom &amp; NOM</th>
						<th>Poste</th>
						<th>Statut</th>
						<th>Formation</th>
						<th>Ecole</th>
						<th>Date du contrat</th>
						<th>Action</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-contract let-expanded="expanded">
					<tr>
						<td>
							<button type="button" pButton pRipple [pRowToggler]="product" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
						</td>
						<td style="min-width: 12rem;">
							{{ contrat.alternant_id?.user_id?.firstname }}
                            {{ contrat.alternant_id?.user_id?.lastname }}
						</td>
						<td style="min-width: 8rem;">{{ contrat.intitule != '' ? contrat.intitule: 'Alternant' }}</td>
						<td style="min-width: 10rem;">
							<p-tag *ngIf="contrat.statut=='créé'" icon="pi pi-exclamation-triangle" severity="info"
                                [value]="contrat.statut">
                            </p-tag>
                            <p-tag *ngIf="contrat.statut =='signé'" icon="pi pi-chevron-right" severity="success"
                                [value]="contrat.statut">
                            </p-tag>
						</td>
						<td>{{ contrat.formation.titre_long }}</td>
                        <td>{{ contrat.ecole?.libelle }}</td>
                        <td>{{contrat.debut_contrat | date:
                            'dd/MM/yyyy'}}-{{contrat.fin_contrat | date: 'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <i class="pi pi-chart-pie" pTooltip="Voir Assiduité" aria-hidden="true"
                                (click)="showPresence(contrat.alternant_id._id)" style="text-align: center; color: red;"></i>
                            <i class="pi pi-pencil" pTooltip="Modifier" aria-hidden="true"
                                (click)="onFillFormUpdate(contrat); showFormUpdateCa = true;"
                                style="text-align: center; margin-left: 3px; color: blue" *ngIf="token.type != 'CEO Entreprise'"></i>
                        </td>
					</tr>
				</ng-template>
				<ng-template pTemplate="rowexpansion" let-contract>
					<tr>
						<td colspan="8">
							<div class="p-3">
								<p-table responsiveLayout="scroll">
									<ng-template pTemplate="header">
										<tr>
											<th>Horaire</th>
											<th>Classification</th>
											<th>Niveau de la formation</th>
											<th>Coeff hierachique</th>
											<th>Commercial</th>
											<th>Tuteur</th>
											<th>Année-scolaires</th>
										</tr>
									</ng-template>
									<ng-template pTemplate="body" let-order>
										<tr>
											<td>{{contract.horaire}}</td>
											<td>{{contract.classification}}</td>
											<td>{{contract.niveau_formation}}</td>
											<td>{{contrat.coeff_hierachique}}</td>
											<td>{{ contrat.code_commercial?.lastname }} {{ contrat.code_commercial?.firstname }}</td>
											<td *ngIf="contrat.tuteur_id != null">
												{{ contrat.tuteur_id?.user_id?.lastname }} 
												{{ contrat.tuteur_id?.user_id?.firstname }}
											</td>
											<td *ngIf="contrat.directeur_id != null">
												{{ contrat.directeur_id?.lastname }} 
												{{ contrat.directeur_id?.firstname }}
											</td>
											<td>
												<ul>
													<li *ngFor="let annee of contrat.anne_scolaire; let i = index">{{ annee }}</li>
												</ul>
											</td>
										</tr>
									</ng-template>
									<ng-template pTemplate="emptymessage">
										<tr>
											<td colspan="8">Aucun contrat n' été inseré pour cette entreprise</td>
										</tr>
									</ng-template>
								</p-table>
							</div>
						</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>

    <div class="col-12">
        <div class="card">
            <!-- Table d'affichage de la liste des entreprises -->
            <h5>Liste des entreprises</h5>
			<p-table #dt1 [value]="entreprises" dataKey="_id" [rows]="10" [loading]="loading" [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true" [globalFilterFields]="['r_sociale','fm_juridique','nb_salarie','ville_ent']" responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Rechercher une entreprise" class="w-full"/>
						</span>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th>
							<div class="flex justify-content-between align-items-center">
								Raison sociale
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Forme juridique
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Nombre de salarié
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Ville
							</div>
						</th>
						<th style="width: 8rem">
                        </th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-entreprise>
					<tr>
						<td style="min-width: 12rem;">
							{{entreprise?.r_sociale}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.fm_juridique}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.nb_salarie}}
						</td>
						<td style="min-width: 12rem;">
							{{entreprise?.ville_ent}}
						</td>
						<td class="text-center" style="min-width: 8rem;">
							<i class="pi pi-user" title="Voir les alternants sur cette entreprise" style="cursor: pointer; color: blue;" (click)="onLoadContracts(entreprise._id);"></i>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="5">Aucune entreprises trouvés.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="5">Chargement des données...</td>
					</tr>
				</ng-template>
    		</p-table>
        </div>
    </div>
</div>