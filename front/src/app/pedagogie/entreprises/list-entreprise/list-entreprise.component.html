<p-toast></p-toast>
<div class="grid">
    <!-- Formulaire de modification d'une entreprise -->
    <div class="col-12" *ngIf="showFormUpdateEntreprise!=null">
        <div class="card">
            <h4 style="text-align: center;">Modifier une entreprise </h4>
            <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
				(click)="showFormUpdateEntreprise = null;" aria-hidden="true">
			</i>
            <p style="text-align: center; font-size: 12px;">Tous les champs marqués d'un astérix <span
                    style="color: red;"> * </span> sont obligatoires</p>
            <br>
            <div>
                <p-steps [model]="formSteps" [activeIndex]="ActiveIndex"></p-steps>
            </div>
            <br>
            <form [formGroup]="formUpdateEntreprise" (ngSubmit)="onUpdateEntreprise()">
                <div *ngIf="ActiveIndex==0">
                    <div style="color: black; font-weight: normal">
                        <div class="p-fluid p-formgrid grid">
                            <div class="field col-12 md:col-6">
                                <label for="raison_sociale"> Raison sociale <span style="color: red;"> * </span></label>
                                <input pInputText id="raison_sociale" type="text" formControlName="r_sociale" placeholder="Nom de l'entreprise " />
                            </div>
                            <div class="field col-12 md:col-6">
                                <label For="forme_juridique">Forme juridique </label>
                                <input pInputText id="forme_juridique" type="text" formControlName="fm_juridique" placeholder="Forme juridique" />
                            </div>

                            <div class="field col-12 md:col-12">
                                <label For="activite">Activité de l'entreprise</label>
                                <textarea pInputTextarea autoResize="autoResize" id="activite" type="text"  formControlName="activite" placeholder="Description des activités de l'entreprise"></textarea>
                            </div>

                            <div class="field col-12 md:col-4">
                                <label For="type_entreprise">Type d'entreprise </label>
                                <input pInputText id="type_entreprise" type="text" formControlName="type_ent" placeholder="Type d'entreprise" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="categorie">Catégorie </label>
                                <p-multiSelect [options]="categorieList" defaultLabel="Choisissez la catégorie" formControlName="categorie"></p-multiSelect>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="isInterne">Entreprise Interne ?</label>
                                <p-selectButton [options]="choiceList" formControlName="isInterne"></p-selectButton>
                            </div>

                            <div class="field col-12 md:col-8">
                                <label For="crc">Caisse de retraite complémentaire :</label>
                                <input pInputText id="crc" type="text" formControlName="crc" placeholder="KLESIA" />
                            </div>

                            <div class="field col-12 md:col-4">
                                <label For="nb_salarie">Nombre de salariés:</label>
                                <input pInputText type="number" formControlName="nb_salarie" placeholder="100" />
                            </div>

                            <div class="field col-12 md:col-8">
                                <label For="convention">Convention collective :</label>
                                <input pInputText id="convention" type="text" formControlName="convention" placeholder="Bureaux d'études techniques, cabinets d'ingénieurs-conseils et sociétés de conseils" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="idcc">Code IDCC:</label>
                                <input pInputText type="number" formControlName="idcc" placeholder="0000" />
                            </div>
                            <div class="field col-4 md:col-4">
                                <label For="indicatif_ent">Indicatif</label>
                                <input pInputText type="number" formControlName="indicatif_ent" placeholder="+33" />
                            </div>
                            <div class="field col-8 md:col-8">
                                <label For="phone_ent">Téléphone <small>(entreprise)</small></label>
                                <input pInputText type="tel" formControlName="phone_ent" placeholder="0188008800"/>
                            </div>

                            <!--Adresse du siège social-->
                            <h3 class="field col-12">Adresse du siège social</h3>
                            <div class="field col-12 md:col-6">
                                <label For="adresse_ss">Adresse du siège sociale</label>
                                <input pInputText id="adresse_ss" type="text" formControlName="adresse_ent" placeholder="Numero et Nom de la rue" />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label For="postal_ss">Code postal du siège sociale</label>
                                <input pInputText id="postal_ss" type="text" formControlName="code_postale_ent" placeholder="75001"/>
                            </div>
                            <div class="field col-12 md:col-3">
                                <label For="ville_ss">Ville du siège sociale</label>
                                <input pInputText id="ville_ss" type="text" formControlName="ville_ent" placeholder="Paris" />
                            </div>

                            <!--Adresse d’exécution du contrat -->
                            <h3 class="field col-12"> Adresse d’exécution du contrat </h3>
                            <div class="field col-12 md:col-6">
                                <label For="adresse_ec">Adresse de l’exécution du contrat</label>
                                <input pInputText id="adresse_ec" type="text" formControlName="adresse_ec" placeholder="15 Rue du Louvre" formControlName="adresse_ec" />
                            </div>
                            <div class="field col-12 md:col-3">
                                <label For="postal_ec">Code postal</label>
                                <input pInputText id="postal_ec" type="text" formControlName="postal_ec" placeholder="75001" />    
                            </div>
                            <div class="field col-12 md:col-3">
                                <label For="ville_ec">Ville de l’exécution du contrat</label>
                                <input pInputText id="ville_ec" type="text" formControlName="ville_ec" placeholder="Paris" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="siret">SIRET</label>
                                <input pInputText id="siret" maxlength=15 minlength=15 type="number"  formControlName="siret" placeholder="XXXX-XXXX-XXXX-XXX" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="ape_naf">Code NAF</label>
                                <input pInputText id="ape_naf" type="text" formControlName="code_ape_naf" placeholder="CODE NAF" />
                            </div>

                            <div class="field col-12 md:col-4">
                                <label For="tva">Numéro TVA </label>
                                <input pInputText id="tva" type="text" formControlName="num_tva" placeholder="Numéro TVA" />
                            </div>  

                            <div class="field col-12 md:col-6">
                                <label For="lastname">Télécopie</label>
                                <input pInputText id="telecopie" type="text" formControlName="telecopie" placeholder="Télécopie" />
                            </div>

                            <div class="field col-12 md:col-6">
                                <label For="OPCO">OPCO</label>
                                <input pInputText id="OPCO" type="text" formControlName="OPCO" placeholder="OPCO" />
                            </div>
                            <div class="field col-12 ">
                                <label For="organisme_prevoyance">Organisme de prevoyance</label>
                                <input pInputText id="organisme_prevoyance" type="text" formControlName="organisme_prevoyance" placeholder="Organisme de prevoyance"/>
                            </div>

                            <div class="field col-6">
                                <button pButton type="button" label="Suivant"
                                    (click)="nextPage();"></button>
                            </div>
                        </div>
                    </div>
                </div> 

                <div *ngIf="ActiveIndex==1">
                    <div style="color: black;font-weight:normal">
                        <div class="p-fluid p-formgrid grid">
                            <div class="field col-12 md:col-4">
                                <label For="civilite">Civilité</label>
                                <p-dropdown [options]="civiliteList" optionLabel="value" formControlName="civilite_rep" optionDisabled="actif"></p-dropdown>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="lastname">Nom </label>
                                <input pInputText id="lastname" type="text" formControlName="nom_rep" placeholder="Nom du dirigeant" />
                            </div>
                            <div class="field col-12 md:col-4">
                                <label For="firstname">Prénom </label>
                                <input pInputText id="firstname" type="text" formControlName="prenom_rep" placeholder="Prenom du dirigeant" />
                            </div>
                            <div class="field col-12 md:col-12">
                                <label For="email">Email du représentant </label>
                                <input pInputText id="email" type="email" formControlName="email_rep" placeholder="Email du dirigeant"/>
                            </div>
                            <div class="field col-3 md:col-4">
                                <label For="indicatif">Indicatif </label>
                                <input pInputText id="indicatif" type="number" formControlName="indicatif_rep" placeholder="+01"/>
                            </div>
                            <div class="field col-9 md:col-8">
                                <label For="phone">Téléphone </label>
                                <input pInputText id="phone" type="tel" formControlName="phone_rep" placeholder="0188880050" />
                            </div>
                            <div class="field col-6">
                                <button pButton type="button" label="Précedent" style="float: left;" (click)="previousPage()"></button>
                            </div>
                            <div class="field col-6">
                                <button pButton type="submit" label="Terminer" style="float: right;"></button>
                            </div>
                        </div>
                    </div>
                </div>   
            </form>
        </div>
    </div>


    <div class="col-12">
        <div class="card">
            <div style="float: right;">
                <button pButton icon="pi pi-plus" label="Ajouter" (click)="onRedirect();"></button>
            </div>
            <h5>Liste des entreprises</h5>
            <p-toast></p-toast>
            <p-table #dt1 [globalFilterFields]="['r_sociale', 'fm_juridique', 'siret',]"
                [pageLinks]="5" [paginator]="true" rowExpandMode="single" [value]="entreprises" dataKey="_id"
                responsiveLayout="scroll" [rows]="10" styleClass="p-datatable-gridlines">
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between flex-column sm:flex-row">
                        <span class="p-input-icon-left mb-2">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                placeholder="Recherche" class="w-full" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem;"></th>
                        <th pSortableColumn="raison_sociale"> Raison sociale <p-sortIcon field="raison_sociale">
                            </p-sortIcon>
                        </th>
                        <th pSortableColumn="forme_juridique"> Forme juridique <p-sortIcon field="forme_juridique">
                            </p-sortIcon>
                        </th>
                        <th pSortableColumn="activite"> Activité <p-sortIcon field="activite"></p-sortIcon>
                        </th>
                        <th pSortableColumn="type_ent"> Type d'entreprise <p-sortIcon field="type_ent"></p-sortIcon>
                        </th>
                        <th pSortableColumn="categorie"> Catégorie <p-sortIcon field="categorie"></p-sortIcon>
                        </th>
                        <th pSortableColumn="isInterne"> Interne/Externe <p-sortIcon field="isInterne"></p-sortIcon>
                        </th>
                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-entreprise let-expanded="expanded">
                    <tr>
                        <td>
                            <button type="button" pButton pRipple [pRowToggler]="entreprise" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        </td>
                        <td style="min-width: 8rem;">{{ entreprise.r_sociale }}</td>
                        <td style="min-width: 8rem;">{{ entreprise.fm_juridique }}</td>
                        <td style="min-width: 8rem;">{{ entreprise.activite }}</td>
                        <td style="min-width: 8rem;">{{ entreprise.type_ent }}</td>
                        <td style="min-width: 8rem;">{{ entreprise.categorie }}</td>
                        <td *ngIf="entreprise.isInterne">Interne</td>
                        <td *ngIf="!entreprise.isInterne">Externe</td>
                        <td>
                            <i style="margin-left: 2%; cursor: pointer" class="pi pi-pencil"
                                (click)="representantToUpdate = users[entreprise.directeur_id]; initFormUpdateEntreprise(entreprise);" aria-hidden="true"></i>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-entreprise>
                    <tr>
                        <td colspan="8">
                            <div class="p-3">
                                <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
                                    <ng-template pTemplate="header">
                    <tr>
                        <th>Caisse de retraite complémentaire</th>
                        <th>Nombre de salarié</th>
                        <th>Convention collective</th>
                        <th>Code IDCC</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{entreprise.crc}}</td>
                        <td>{{entreprise.nb_salarie}}</td>
                        <td>{{entreprise.convention}}</td>
                        <td>{{entreprise.idcc}}</td>
                    </tr>
                </ng-template>
            </p-table>
            <h5 *ngIf="entreprise" style="text-align:center;">Information de l'entreprise</h5>
            <p-table responsiveLayout="scroll" *ngIf="entreprise" styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Indicatif entreprise</th>
                        <th>Téléphone entreprise</th>
                        <th>Adresse entreprise</th>
                        <th>SIRET</th>
                        <th>Code APE NAF</th>
                        <th>Numéro TVA</th>
                        <th>Télécopie</th>
                        <th>OPCO</th>
                        <th>Organisme de prévoyance</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-entreprise>

                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{entreprise.indicatif_ent}}</td>
                        <td>{{entreprise.phone_ent}}</td>
                        <td>{{entreprise.adresse_ent}} {{entreprise.code_postale_ent}} {{entreprise.ville_ent}}</td>
                        <td>{{entreprise.siret}}</td>
                        <td>{{entreprise.code_ape_naf}}</td>
                        <td>{{entreprise.num_tva}}</td>
                        <td>{{entreprise.telecopie}}</td>
                        <td>{{entreprise.OPCO}}</td>
                        <td>{{entreprise.organisme_prevoyance}}</td>
                    </tr>
                </ng-template>
            </p-table>
            <h5  style="text-align:center;">Information du représentant</h5>
            <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Civilité du représentant</th>
                        <th>Nom et prénom du représentant</th>
                        <th>Email du représentant</th>
                        <th>Téléphone du représentant</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-entreprise>

                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{users[entreprise.directeur_id]?.civilite}}</td>
                        <td>{{users[entreprise.directeur_id]?.lastname | uppercase}} {{users[entreprise.directeur_id]?.firstname | titlecase}}</td>
                        <td>{{users[entreprise.directeur_id]?.email_perso}}</td>
                        <td>{{users[entreprise.directeur_id]?.indicatif}} {{users[entreprise.directeur_id]?.phone}}</td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- <h5 *ngIf="entreprise.nom_contact || entreprise.prenom_contact" style="text-align:center;">Informations du
                1er contact</h5>
            <p-table responsiveLayout="scroll" *ngIf="entreprise.nom_contact || entreprise.prenom_contact"
                styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Fonction</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{entreprise.nom_contact}}</td>
                        <td>{{entreprise.prenom_contact}}</td>
                        <td>{{entreprise.fc_contact}}</td>
                        <td>{{entreprise.email_contact}}</td>
                        <td>{{entreprise.phone_contact}}</td>
                    </tr>
                </ng-template>
            </p-table> -->
            <!-- <h5 *ngIf="entreprise.nom_contact_2nd || entreprise.prenom_contact_2nd" style="text-align:center;">
                Informations du 2ème contact</h5>
            <p-table responsiveLayout="scroll" *ngIf="entreprise.nom_contact_2nd || entreprise.prenom_contact_2nd"
                styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Fonction</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-entreprise>

                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{entreprise.nom_contact_2nd}}</td>
                        <td>{{entreprise.prenom_contact_2nd}}</td>
                        <td>{{entreprise.fc_contact_2nd}}</td>
                        <td>{{entreprise.email_contact_2nd}}</td>
                        <td>{{entreprise.phone_contact_2nd}}</td>
                    </tr>
                </ng-template>
            </p-table> -->

            <h5 *ngIf="entreprise.categorie.includes('Alternant')" style="text-align:center;">
                Informations Alternance</h5>
            <p-table responsiveLayout="scroll" *ngIf="entreprise.categorie.includes('Alternant')"
                styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Activité</th>
                        <th>Adresse de l'exécution du contrat</th>
                        <th>Ville</th>
                        <th>Code postale</th>
                        <th>Caisse de retraite complémentaire </th>
                        <th>Nombre de Salariés </th>
                        <th>Convention Collective </th>
                        <th>IDCC</th>
                        <th>Télécopie</th>
                        <th>OPCO</th>
                        <th>Organisme de prevoyance</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-order>

                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{entreprise.activite}}</td>
                        <td>{{entreprise.adresse_ec}}</td>
                        <td>{{entreprise.ville_ec}}</td>
                        <td>{{entreprise.postal_ec}}</td>
                        <td>{{entreprise.crc}}</td>
                        <td>{{entreprise.nb_salarie}}</td>
                        <td>{{entreprise.convention}}</td>
                        <td>{{entreprise.idcc}}</td>
                        <td>{{entreprise.telecopie}}</td>
                        <td>{{entreprise.OPCO}}</td>
                        <td>{{entreprise.organisme_prevoyance}}</td>
                    </tr>
                </ng-template>
            </p-table>

        </div>
        </td>
        </tr>
        </ng-template>
        </p-table>
    </div>
</div>
</div>