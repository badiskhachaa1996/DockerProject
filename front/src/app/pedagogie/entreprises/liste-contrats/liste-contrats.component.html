<div class="grid">
    <div class="col-12">
        <!-- Formulaire d'ajout d'un nouveau contrat -->
        <div class="card" *ngIf="formAddNewCA">
            <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
                (click)="formAddNewCA = false;" aria-hidden="true"></i>

            <h4 style="text-align: center;">Nouveau contrat</h4>

            <form [formGroup]="RegisterNewCA" (ngSubmit)="createNewCA()">
                <div style="color: black;font-weight:normal">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field col-12 md:col-12">
                            <label For="TypeCOntrat">Type de contrat<span style="color: red;">
                                </span></label>
                            <p-selectButton optionValue="value" formControlName="professionnalisation"
                                (onChange)="afficherProsChamp()"
                                [options]="[{label:'Apprentissage',value:false},{label:'Professionnalisation',value:true}]">
                            </p-selectButton>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="entreprise_id">Entreprise<span style="color: red;"> *
                                </span></label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false [options]="EntrepriseList"
                                dataKey="_id" filter="true" formControlName="entreprise_id"
                                [disabled]="token.type == 'CEO Entreprise'"
                                (onChange)="loadTuteur(entreprise_id.value)">
                            </p-dropdown>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="tuteur_id">Tuteur <span style="color: red;"> *
                                </span></label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropdownTuteurList" dataKey="_id" filter="true" id="alternant"
                                formControlName="tuteur_id">
                            </p-dropdown>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="alternant">Alternant<span style="color: red;"> *
                                </span> </label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="listAlternantDD" dataKey="_id" filter="true" id="alternant"
                                formControlName="alternant">
                            </p-dropdown>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="debut_contrat">Date de debut du contrat<span style="color: red;"> *
                                </span></label>
                            <p-calendar formControlName="debut_contrat" [monthNavigator]="true" [yearNavigator]="true"
                                [required]="true" [showOnFocus]="false" [showIcon]="true" placeHolder="26/05/1998"
                                dateFormat="dd/mm/yy">
                            </p-calendar>
                            <div *ngIf="debut_contrat.invalid && (debut_contrat.touched || debut_contrat.dirty)">
                                <span style="color: red;" class="error" *ngIf="debut_contrat.errors?.required">*
                                    Le champs est vide ou n'est pas dans le format JJ/MM/AAAA</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="fin_contrat">Date de fin du contrat<span style="color: red;"> *
                                </span></label>
                            <p-calendar formControlName="fin_contrat" [monthNavigator]="true" [yearNavigator]="true"
                                [required]="true" [showOnFocus]="false" [showIcon]="true" placeHolder="26/05/1998"
                                dateFormat="dd/mm/yy">
                            </p-calendar>
                            <div *ngIf="fin_contrat.invalid && (fin_contrat.touched || fin_contrat.dirty)">
                                <span style="color: red;" class="error" *ngIf="fin_contrat.errors?.required">*
                                    Le champs est vide ou n'est pas dans le format JJ/MM/AAAA</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="horaire">Horaires par semaine</label>
                            <input pInputText id="horaire" type="text" placeholder="35 h/semaine"
                                formControlName="horaire" />
                            <div *ngIf="horaire.invalid && (horaire.touched || horaire.dirty)">
                                <span style="color: red;" class="error" *ngIf="horaire.errors?.required">
                                    *Le champs est obligatoire.
                                </span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="classification">Classification<span style="color: red;"> *
                                </span></label>
                            <input pInputText id="classification" type="text" placeholder="Classe A"
                                formControlName="classification" />
                            <div *ngIf="classification.invalid && (classification.touched || classification.dirty)">
                                <span style="color: red;" class="error" *ngIf="classification.errors?.required">
                                    * Le champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="intitule">Intitulé<span style="color: red;">
                                </span></label>
                            <input pInputText id="intitule" type="text" placeholder="Intitulé du poste"
                                formControlName="intitule" />
                            <div *ngIf="intitule.invalid && (intitule.touched || intitule.dirty)">
                                <span style="color: red;" class="error" *ngIf="intitule.errors?.required">
                                    *Le champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="niv">Niveau de la formation<span style="color: red;"> *</span></label>
                            <input pInputText id="niv" type="text" placeholder="Bac+3" formControlName="niv" />
                            <div *ngIf="niv.invalid && (niv.touched || niv.dirty)">
                                <span style="color: red;" class="error" *ngIf="niv.errors?.required">
                                    *Le champs est obligatoire.
                                </span>
                            </div>
                        </div>

                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="coeff_hier">Coefficient hiérarchique<span style="color: red;"> *
                                </span></label>
                            <input pInputText id="coeff_hier" type="text" placeholder="5.2"
                                formControlName="coeff_hier" />
                            <div *ngIf="coeff_hier.invalid && (coeff_hier.touched || coeff_hier.dirty)">
                                <span style="color: red;" class="error" *ngIf="coeff_hier.errors?.required">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>

                        <div class="field col-12 md:col-6">
                            <label For="form">Formation<span style="color: red;"> *
                                </span></label>

                            <p-dropdown [options]="formationList" id="form" formControlName="form" filter="true"
                                emptyFilterMessage="Pas de formation trouvé" filterPlaceholder="Filtrer">
                            </p-dropdown>
                            <div *ngIf="form.invalid && (form.touched || form.dirty)">
                                <span style="color: red;" class="error" *ngIf="form.errors?.required">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="code_commercial">Commercial référent</label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropDownCommecialList" dataKey="_id" filter="true"
                                formControlName="code_commercial">
                            </p-dropdown>
                            <div *ngIf="code_commercial.invalid && (code_commercial.touched || code_commercial.dirty)">
                                <span style="color: red;" class="error">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-6">
                            <label>Année scolaire</label>
                            <p-multiSelect class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropDownAnneeList" optionLabel="label" filter="true"
                                formControlName="anne_scolaire">
                            </p-multiSelect>
                        </div>
                        <div class="field col-6">
                            <label>CFA <span style="color: red;"> *
                                </span></label>
                            <p-dropdown placeholder="Choississez le CFA" [options]="dropdownCFA" filter="true"
                                formControlName="ecole">
                            </p-dropdown>
                        </div>
                        <div classe="field">
                            <button pButton type="submit" label="Ajouter" style="float: right;"
                                [disabled]="RegisterNewCA.invalid|| (Professionnalisation.value == true && classification.invalid)">
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Formulaire de modification d'un contrat -->
        <div class="card" *ngIf="showFormUpdateCa">
            <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
                (click)="showFormUpdateCa = false;" aria-hidden="true"></i>
            <h4 style="text-align: center;">Modifier ce contrat</h4>

            <form [formGroup]="formUpdateCa" (ngSubmit)="onUpdateCa()">
                <div style="color: black;font-weight:normal">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field col-12 md:col-12">
                            <label For="TypeCOntrat">Type de contrat<span style="color: red;">
                                </span></label>
                            <p-selectButton optionValue="value" formControlName="professionnalisation"
                                (onChange)="afficherProsChamp()"
                                [options]="[{label:'Apprentissage',value:false},{label:'Professionnalisation',value:true}]">
                            </p-selectButton>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="entreprise_id">Entreprise<span style="color: red;"> *
                                </span></label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false [options]="EntrepriseList"
                                dataKey="_id" filter="true" formControlName="entreprise_id"
                                [disabled]="token.type == 'CEO Entreprise'"
                                (onChange)="loadTuteur(entreprise_id_m.value)">
                            </p-dropdown>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="tuteur_id">Tuteur <span style="color: red;"> *
                                </span></label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropdownTuteurList" dataKey="_id" filter="true" id="alternant"
                                formControlName="tuteur_id">
                            </p-dropdown>
                        </div>
                        <!--<div class="field col-12 md:col-6">
                            <label For="alternant">Alternant<span style="color: red;"> *
                                </span> </label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="listAlternantDD" dataKey="_id" filter="true" id="alternant" formControlName="alternant">
                            </p-dropdown>
                        </div>-->
                        <div class="field col-12 md:col-6">
                            <label For="debut_contrat">Date de debut du contrat<span style="color: red;"> *
                                </span></label>
                            <p-calendar formControlName="debut_contrat" [monthNavigator]="true" [yearNavigator]="true"
                                [required]="true" [showOnFocus]="false" [showIcon]="true" placeHolder="26/05/1998"
                                dateFormat="dd/mm/yy">
                            </p-calendar>
                            <div *ngIf="debut_contrat_m.invalid && (debut_contrat_m.touched || debut_contrat_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="debut_contrat_m.errors?.required">*
                                    Le champs est vide ou n'est pas dans le format JJ/MM/AAAA</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="fin_contrat">Date de fin du contrat<span style="color: red;"> *
                                </span></label>
                            <p-calendar formControlName="fin_contrat" [monthNavigator]="true" [yearNavigator]="true"
                                [required]="true" [showOnFocus]="false" [showIcon]="true" placeHolder="26/05/1998"
                                dateFormat="dd/mm/yy">
                            </p-calendar>
                            <div *ngIf="fin_contrat_m.invalid && (fin_contrat_m.touched || fin_contrat_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="fin_contrat_m.errors?.required">*
                                    Le champs est vide ou n'est pas dans le format JJ/MM/AAAA</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="horaire">Horaires par semaine</label>
                            <input pInputText id="horaire" type="text" placeholder="35 h/semaine"
                                formControlName="horaire" />
                            <div *ngIf="horaire_m.invalid && (horaire_m.touched || horaire_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="horaire_m.errors?.required">
                                    *Le champs est obligatoire.
                                </span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="classification">Classification<span style="color: red;"> *
                                </span></label>
                            <input pInputText id="classification" type="text" placeholder="Classe A"
                                formControlName="classification" />
                            <div
                                *ngIf="classification_m.invalid && (classification_m.touched || classification_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="classification_m.errors?.required">
                                    * Le champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="intitule">Intitulé<span style="color: red;">
                                </span></label>
                            <input pInputText id="intitule" type="text" placeholder="Intitulé du poste"
                                formControlName="intitule" />
                            <div *ngIf="intitule_m.invalid && (intitule_m.touched || intitule_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="intitule_m.errors?.required">
                                    *Le champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="niv">Niveau de la formation<span style="color: red;"> *</span></label>
                            <input pInputText id="niv" type="text" placeholder="Bac+3" formControlName="niv" />
                            <div *ngIf="niv_m.invalid && (niv_m.touched || niv_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="niv_m.errors?.required">
                                    *Le champs est obligatoire.
                                </span>
                            </div>
                        </div>

                        <div class="field col-12 md:col-6" *ngIf="Professionnalisation">
                            <label For="coeff_hier">Coefficient hiérarchique<span style="color: red;"> *
                                </span></label>
                            <input pInputText id="coeff_hier" type="text" placeholder="5.2"
                                formControlName="coeff_hier" />
                            <div *ngIf="coeff_hier_m.invalid && (coeff_hier_m.touched || coeff_hier_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="coeff_hier_m.errors?.required">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>

                        <div class="field col-12 md:col-6">
                            <label >Formation<span style="color: red;"> *
                                </span></label>
                            <p-dropdown [options]="formationList" id="form" formControlName="form" filter="true"
                                emptyFilterMessage="Pas de formation trouvé" filterPlaceholder="Filtrer">
                            </p-dropdown>
                            <div *ngIf="form_m.invalid && (form_m.touched || form_m.dirty)">
                                <span style="color: red;" class="error" *ngIf="form_m.errors?.required">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-12 md:col-12">
                            <label For="code_commercial">Commercial référent<span style="color: red;"> *
                                </span></label>
                            <p-dropdown class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropDownCommecialList" dataKey="_id" filter="true"
                                formControlName="code_commercial">
                            </p-dropdown>
                            <div
                                *ngIf="code_commercial_m.invalid && (code_commercial_m.touched || code_commercial_m.dirty)">
                                <span style="color: red;" class="error">*
                                    Le
                                    champs est obligatoire.</span>
                            </div>
                        </div>
                        <div class="field col-6">
                            <label>Année scolaire</label>
                            <p-multiSelect class="p-dropdown-clearable" [autoDisplayFirst]=false
                                [options]="dropDownAnneeList" optionLabel="label" filter="true"
                                formControlName="anne_scolaire">
                            </p-multiSelect>
                        </div>
                        <div class="field col-6">
                            <label>CFA <span style="color: red;"> *
                                </span></label>
                            <p-dropdown placeholder="Choississez le CFA" [options]="dropdownCFA" filter="true"
                                formControlName="ecole">
                            </p-dropdown>
                        </div>
                        <div classe="field">
                            <button pButton type="submit" label="Modifier" style="float: right;"
                                [disabled]="formUpdateCa.invalid|| (professionnalisation_m.value == true && classification_m.invalid)">
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-12" *ngIf="token.type == 'CEO Entreprise'">
            <div class="card">
                <p-panel header="Notice" [toggleable]="true" class="line-height-3 m-0">
                    Si vous rencontrez une incohérence sur un contrat n'hésitez pas créer un ticket au service commercial via le module ticketing.
                </p-panel>
            </div>
        </div>

        <div class="card">
            <button *ngIf="token.type != 'CEO Entreprise'" pButton label="Nouveau contrat d'alternance" (click)="ShowAddNewCA()"
                style="float: right;"></button>

            <h5>Liste des contrats</h5>

            <p-toast></p-toast>
            <p-table #dt1 [value]="ListeContrats"
                [globalFilterFields]="['_id', 'code_commercial.lastname','code_commercial.firstname','statut','classification','alternant_id.user_id.firstname','alternant_id.user_id.lastname']"
                [pageLinks]="5" [paginator]="true" rowExpandMode="single" dataKey="_id" responsiveLayout="scroll"
                [rows]="10">
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between flex-column sm:flex-row">
                        <span class="p-input-icon-left mb-2">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                placeholder="Recherche" class="w-full" />

                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 8rem;"></th>
                        <th>Prenom &amp; Nom</th>
                        <th>Poste</th>
                        <th>Statut</th>
                        <th>Formation</th>
                        <th>Ecole</th>
                        <th>Dates du contrat</th>
                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-contrat let-expanded="expanded">
                    <tr>
                        <td>
                            <button type="button" pButton pRipple [pRowToggler]="contrat"
                                class="p-button-text p-button-rounded p-button-plain"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        </td>
                        <td style="min-width: 11rem;">
                            {{ contrat.alternant_id?.user_id?.firstname }}
                            {{ contrat.alternant_id?.user_id?.lastname }}
                        </td>
                        <td>{{ contrat.intitule != '' ? contrat.intitule: 'Alternant' }}</td>
                        <td>
                            <p-tag *ngIf="contrat.statut=='créé'" icon="pi pi-exclamation-triangle" severity="info"
                                [value]="contrat.statut">
                            </p-tag>
                            <p-tag *ngIf="contrat.statut =='signé'" icon="pi pi-chevron-right" severity="success"
                                [value]="contrat.statut">
                            </p-tag>
                        </td>

                        <td>{{ contrat.formation.titre_long }}</td>
                        <td>{{ contrat.ecole?.libelle }}</td>
                        <td>{{contrat.debut_contrat | date:
                            'dd/MM/yyyy'}}-{{contrat.fin_contrat | date: 'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <i class="pi pi-chart-pie" pTooltip="Voir Assiduité" aria-hidden="true"
                                (click)="showPresence(contrat.alternant_id._id)" style="text-align: center; color: red;"></i>
                            <i class="pi pi-pencil" pTooltip="Modifier" aria-hidden="true"
                                (click)="onFillFormUpdate(contrat); showFormUpdateCa = true;"
                                style="text-align: center; margin-left: 3px; color: blue" *ngIf="token.type != 'CEO Entreprise'"></i>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="rowexpansion" let-contrat>
                    <tr>
                        <td colspan="8">
                            <div class="p-3">
                                <p-table responsiveLayout="scroll" styleClass="p-datatable-gridlines">
                                    <ng-template pTemplate="header">
                    <tr>
                        <th>Horaire</th>
                        <th>Classification</th>
                        <th>Niveau de la formation</th>
                        <th *ngIf="token.type != 'CEO Entreprise'">Entreprise</th>
                        <th>Coeff hierachique</th>
                        <th>Commercial</th>
                        <th>Tuteur</th>
                        <th>Année-scolaires</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{contrat.horaire}}</td>
                        <td>{{contrat.classification}}</td>
                        <td>{{contrat.niveau_formation}}</td>
                        <td style="min-width: 5rem;" *ngIf="token.type != 'CEO Entreprise'">
                            {{ contrat.entreprise_id?.r_sociale }}
                        </td>
                        <td>{{contrat.coeff_hierachique}}</td>
                        <td>{{ contrat.code_commercial?.lastname }} {{ contrat.code_commercial?.firstname }}</td>
                        
                        <td *ngIf="contrat.tuteur_id != null">
                            {{ contrat.tuteur_id?.user_id?.lastname }} 
                            {{ contrat.tuteur_id?.user_id?.firstname }}
                        </td>
                        <td *ngIf="contrat.directeur_id != null">
                            {{ contrat.directeur_id?.lastname }} 
                            {{ contrat.directeur_id?.firstname }}
                        </td>

                        <td>
                            <ul>
                                <li *ngFor="let annee of contrat.anne_scolaire; let i = index">{{ annee }}</li>
                            </ul>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        </td>
        </tr>
        </ng-template>
        </p-table>
    </div>
</div>
</div>