<div class="grid" *ngIf="showCanvas || (presence && presence.allowedByFormateur && presence.signature==false)">
    <div class="col-12 card shadow-lg">
        <h3 *ngIf="seance">Signature de la séance: {{seance.libelle}} du {{seance.date_debut | date : "dd/MM"}}</h3>
        <div class="col-12">
            <i class="pi pi-times" style="font-size: 20px;" (click)="clearCanvas()" aria-hidden="true"
                pTooltip="Effacer la signature" tooltipPosition="bottom"></i><br>
            <canvas class="card" #canva></canvas><br>
            <button pButton class="ui-button-raised ui-button-success" label="Envoyer"
                (click)="getSignature();"></button>
        </div>
    </div>
</div>
<div class="card" *ngIf="showUploadFile">
    <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="showUploadFile = false" aria-hidden="true">
    </i>
    <h3 *ngIf="seance" class="text-center" style="font-weight: bold;">
        Ajouter un document à : {{ seance.libelle }}</h3>
    <form class="col-12" [formGroup]="formUploadFile">
        <div class="grid">
            <div class="col-12 sm:col-6">
                <label>Autorisez les étudiants à consulter ce fichier ?</label>
                <p-selectButton [options]="[{value:true,label:'Oui'},{value:false,label:'Non'}]" formControlName="etat">
                </p-selectButton>
            </div>
            <div class="col-12 sm:col-6">
                <p-fileUpload (uploadHandler)="FileUpload($event)" mode="basic" chooseLabel="Ajouter un Document"
                    customUpload="true" fileLimit="1" maxFileSize="10000000" [auto]="true" #fileInput>
                </p-fileUpload>
            </div>
        </div>
    </form>
</div>
<div class="card" *ngIf="presence && seance " [ngStyle]="{'background-color': presence.isPresent ? 'green' : 'tomato'}">
    <div class="grid">
        <div class="col-8 col-offset-2 flex justify-content-center flex-wrap card-container">
            <h5 *ngIf="seance">Signature de la séance: {{seance.libelle}} du {{seance.date_debut | date : "dd/MM/yyyy"}}</h5>
        </div>
        <div class="col-12">
            <small><span style="font-weight: bold;"> Etat :</span></small><br><br>
            <div *ngIf="!presence.isPresent">
                <small> Vous avez été noté absent lors de cette séance</small>
                <p *ngIf="presence.justificatif && presence.isPresent">Votre justificatif a été accepté</p>
            </div>
            <div *ngIf="presence.isPresent">
                <small>Vous avez été noté présent lors de cette séance</small>
                <button pButton class="ui-button-raised ui-button-success" label="Envoyer un document"
                    (click)="showUploadFile=true"></button>
            </div>
        </div>    
        <div class="col-12">
            <small> <span style="font-weight: bold;"> Documents : </span></small><br>
            <ul>
                <li *ngFor="let file of seance.fileRight; index as i">
                    <i *ngIf="token.role!='user' || formateurInfo" class="pi pi-times"
                        style="float:right; font-size: 20px;cursor:pointer" (click)="deleteFile(file)"
                        aria-hidden="true"> </i>
                    <i *ngIf="token.role!='user' || file.right || formateurInfo" class="pi pi-file-pdf "
                        style="font-size: 2rem" (click)="downloadFileCours(file)"></i>
                    <em *ngIf="token.role!='user' || file.right || formateurInfo" (click)="downloadFileCours(file)"
                        [id]="i" style="cursor: pointer;">
                        {{ file.name }}
                    </em>
                </li>
            </ul>
            <small *ngIf="seance.fileRight==null || seance.fileRight.length==0">Aucun document n'a été chargé !</small>
        </div>
    </div>
</div>
<div class="card" *ngIf="presence==null || !presence.isPresent">
    <div class="p-grid">
        <h4>Fournir un justificatif d'absence</h4>
        <div class="col-12">
            <div class="md:col-offset-5 col-12">
                <p-fileUpload #justificatif (uploadHandler)="onFileChange($event)" mode="basic"
                    chooseLabel="Joindre un fichier" customUpload="true" fileLimit="1" accept=".pdf,.jpg,.png,.jpeg"
                    maxFileSize="20000000" [auto]="true">
                </p-fileUpload>
            </div>
            <i *ngIf="uploadFile" class="pi pi-spin pi-spinner col-2" style="font-size: 2rem"
            aria-hidden="true"></i><br>
        <i *ngIf="loadingFile" class="pi pi-spin pi-spinner" style="font-size: 2rem" aria-hidden="true"></i>
        <button [disabled]="justif_file_value==null || justif_file_value>20000000 || uploadFile" pButton
             label="Envoyer le justificatif"
            (click)="sendJustif();"></button>
        <button *ngIf="presence && presence.justificatif" [disabled]="loadingFile" pButton
             label="Télécharger votre justificatif"
            (click)="downloadFile(presence);"></button>
        </div>
    </div>
</div>
<div class="grid">
    <p-fieldset class="col-12" *ngIf="seance" legend="{{seance.libelle}}">
        <div class="p-fluid grid" style="color: black;font-weight:normal;">
            <div class="col-12 md:col-6 grid"
                *ngIf="userList && userList[seance.formateur_id] && dataRole.type!='Formateur'">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Formateur :</strong>
                </div>
                <div class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;">
                        {{userList[seance.formateur_id].lastname | uppercase}}
                        {{userList[seance.formateur_id].firstname
                        | titlecase}}
                    </span>
                </div>
            </div>
            <div class="col-12 md:col-6 grid" *ngIf="seance.classe_id && diplomeList">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Diplome :</strong>
                </div>
                <div class="col-6 md:col-6" style="text-align:left !important;">
                    {{affichageDiplome}}
                </div>
            </div>
            <div class="col-12 md:col-6 grid" *ngIf="classeList && seance.classe_id">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Groupe :</strong>
                </div>
                <div class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;" *ngFor="let cid of seance.classe_id; let index = index">
                        <span *ngIf="classeList[cid] && classeList[cid].nom && index==0">{{classeList[cid].nom}}</span>
                        <span
                            *ngIf="classeList[cid] && classeList[cid].nom && index!=0">,<br>{{classeList[cid].nom}}</span>
                    </span>
                </div>
            </div>
            <div class="col-12 md:col-6 grid" *ngIf="matiereList && matiereList[seance.matiere_id]">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Module :</strong>
                </div>
                <div class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;">
                        {{matiereList[seance.matiere_id].nom}}
                    </span>
                </div>
            </div>
            <div class="col-12 md:col-6 grid">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Numéro de Salle :</strong>
                </div>
                <div *ngIf="seance.isPresentiel" class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;">
                        {{seance.salle_name}}
                    </span>
                </div>
                <div *ngIf="!seance.isPresentiel" class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;">
                        Distanciel
                    </span>
                </div>
            </div>
            <div class="col-12 md:col-6 grid" *ngIf="seance.date_debut && seance.date_fin">
                <div class="col-6 md:col-6">
                    <strong style="text-align:left !important;">Date :</strong>
                </div>
                <div class="col-6 md:col-6" style="text-align:left !important;">
                    <span style="color: black;">
                        {{seance.date_debut | date:'dd/MM HH:mm'}} - {{seance.date_fin | date:'dd/MM HH:mm'}}
                    </span>
                    <span style="color: black;">
                        {{seance.date_debut | date:'dd/MM HH:mm':'+2'}} - {{seance.date_fin | date:'dd/MM HH:mm':'+2'}}
                    </span>
                </div>
            </div>
        </div>
    </p-fieldset>
</div>
<p-toast></p-toast>
<div class="card" *ngIf="showAddEtudiant">
    <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="showAddEtudiant = false" aria-hidden="true">
    </i>
    <h3 class="text-center" style="font-weight: bold;">
        Ajouter un étudiant à : {{ seance.libelle }}</h3>
    <form class="col-12" [formGroup]="formAddEtudiant">
        <div class="grid">
            <div class="col-12">
                <p-dropdown [options]="dropdownEtudiant" formControlName="etudiant_id"></p-dropdown>
            </div>
            <div class="col-12">
                <button pButton class="ui-button-raised ui-button-success" label="Autorisez cette étudiant"
                    (click)="addEtudiant();"></button>
            </div>
        </div>
    </form>
</div>

<div class="col-12" *ngIf="token.role!='user'  || formateurInfo">
    <div class="grid col-12 card" *ngIf="showPdf">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showPdf = false"
            aria-hidden="true"> </i>
        <h5 class="col-12 text-center">Générer la feuille d'emergement du groupe:</h5>
        <div class="col-6 md:col-4" *ngFor="let cid of seance.classe_id; i as index">
            <button pButton (click)="getPDF(cid)" label="{{classeList[cid].abbrv}} - {{campusDic[cid]}}"> </button>
        </div>
    </div>
    <div class="card">
        <button pButton class="ui-button-raised ui-button-success" label="Export en PDF" style="float:right;"
            (click)="showPdf=true"></button>
        <button pButton class="ui-button-raised ui-button-success" label="Ajouter un étudiant"
            style="float:right;margin-right: 2px;" (click)="showAddEtudiant=true"></button>
        <h3 *ngIf="seance">Liste des présence de la séance: {{seance.libelle}} du {{seance.date_debut | date :
            "dd/MM"}}
        </h3>
        <div class="col-12 card shadow-lg my-5 ">
            <p-table #dt1 *ngIf="presences" [columns]="cols" [value]="presences" rowExpandMode="single" [rows]="10"
                [paginator]="true" [pageLinks]="5" [responsive]="true" [totalRecords]="presences.length">
                <ng-template pTemplate="caption">
                    <div class="flex justify-content-between flex-column sm:flex-row">
                        <p-dropdown *ngIf="groupeFilter!=null && groupeFilter.length!=1" [options]="groupeFilter"
                            class="mb-2" (onChange)="dt1.filter($event.value, 'classe_id', 'contains')">
                        </p-dropdown>
                        <span class="p-input-icon-left mb-2">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                placeholder="Recherche" />
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th pSortableColumn="user_id" scope="col">
                            Nom <p-sortIcon field="user_id"></p-sortIcon>
                        </th>
                        <th pSortableColumn="user_id" scope="col">
                            Prénom <p-sortIcon field="user_id"></p-sortIcon>
                        </th>
                        <th pSortableColumn="groupe" scope="col">
                            Groupe <p-sortIcon field="groupe"></p-sortIcon>
                        </th>
                        <th pSortableColumn="isPresent" scope="col">
                            Présent <p-sortIcon field="isPresent"></p-sortIcon>
                        </th>
                        <th pSortableColumn="date_signature" scope="col">
                            Date de présence <p-sortIcon field="date_signature"></p-sortIcon>
                        </th>
                        <th scope="col">
                            Action
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rowData let-columns="columns">
                    <tr class="bandeau-show">
                        <td *ngIf="userList[rowData.user_id]">
                            {{userList[rowData.user_id].lastname}}
                        </td>
                        <td *ngIf="userList[rowData.user_id]">
                            {{userList[rowData.user_id].firstname}}
                        </td>
                        <td *ngFor="let cid of seance.classe_id; let index = index">
                            {{classeList[cid].nom}}
                        </td>
                        <td>
                            {{(rowData.isPresent)?"Oui":"Non"}}
                        </td>
                        <td *ngIf="seance" [style]="colorDate(rowData)">
                            {{rowData.date_signature| date:'dd/MM/yyyy HH:mm'}}
                        </td>
                        <td>
                            <i *ngIf="rowData.justificatif" pTooltip="Télécharger la justification"
                                tooltipPosition="bottom" class="pi pi-download" (click)="downloadFile(rowData)"
                                aria-hidden="true"></i>
                            <i *ngIf="!rowData.isPresent" pTooltip="Marquer comme présent" tooltipPosition="bottom"
                                class="pi pi-check" (click)="acceptJustif(rowData,true)" aria-hidden="true"></i>
                            <i *ngIf="rowData.isPresent" pTooltip="Marquer comme absent" tooltipPosition="bottom"
                                class="pi pi-times" (click)="acceptJustif(rowData,false)" aria-hidden="true"></i>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>