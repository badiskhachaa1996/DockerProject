<div class="grid">
	<div class="col-12">
		<div class="card">
			<h1 class="text-center">Dashboard</h1>
			<div class="grid text-center">
				<div class="col-12">
					<strong>{{ today | date: 'dd MMMM YYYY' }}</strong> <br>
					<strong>{{ today | date: 'H:mm' }} Paris</strong>
				</div>
				<p class="col-12">Site <p-multiSelect [options]="localisationList" placeholder="Paris, Tunis..."
						[(ngModel)]="siteSelected" (onChange)="filterCollaborateur($event.value)" autoWidth="false"
						[style]="{'width':'13em'}"></p-multiSelect></p>

				<div class="col-12 md:col-4 align-self-center grid"
					style="border: 1px black solid;margin:0px;height: 100px;">
					<p class="col-12"><p-tag value="Checkin IMS"
							icon="pi pi-check-circle"></p-tag><strong>&nbsp;{{numberOfChecks}}/{{collaborateurs.length}}</strong>
					</p>
					<p class="col-12"><p-tag value="Pointage" icon="pi pi-bookmark"></p-tag><strong>&nbsp;WIP</strong>
					</p>
				</div>

				<div class="col-12 md:col-4 align-self-center grid"
					style="border: 1px black solid;margin:0px;height: 100px;">
					<p class="col-12"><p-tag value="Absent" icon="pi pi-times"
							severity="danger"></p-tag><strong>&nbsp;{{numberOfAbsent}}</strong></p>
					<p class="col-12"><p-tag value="Congé" icon="pi pi-home"
							severity="info"></p-tag><strong>&nbsp;{{numberOfConge}}</strong> </p>
				</div>

				<div class="col-12 md:col-4 align-self-center grid"
					style="border: 1px black solid;margin:0px;height: 100px;">
					<p class="col-6" style="text-align: center;"><p-tag value="Disponible" severity="success"
							icon="pi pi-check"></p-tag>
						<strong>&nbsp;{{numberOfDisponible}}</strong>
					</p> <!-- Icon à faire -->
					<p class="col-6" style="text-align: center;"><p-tag value="En pause" severity="warning"
							icon="pi pi-moon"></p-tag>
						<strong>&nbsp;{{numberOfPause}}</strong>
					</p>
					<p class="col-6" style="text-align: center;margin-bottom: 0px;"><p-tag value="Occupé"
							severity="danger" icon="pi pi-pencil"></p-tag> <strong>&nbsp;{{numberOfOccupe}}</strong></p>
					<p class="col-6" style="text-align: center;margin-bottom: 0px;"><p-tag value="En réunion"
							severity="warning" icon="pi pi-phone"></p-tag> <strong>&nbsp;{{numberOfReunion}}</strong>
					</p>
				</div>
			</div>
		</div>

		<!-- tableau d'affichage des données en temps réel -->
		<div class="card">
			<h1 class="text-center">Activités</h1>
			<p-table #dt1 [value]="dailyChecks" dataKey="_id" [rows]="10" [loading]="loading" [rowHover]="true"
				[totalRecords]="dailyChecks.length" styleClass="p-datatable-gridlines" [paginator]="true"
				[globalFilterFields]="['user_id.firstname','user_id.lastname','user_id.email','user_id.phone']"
				responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter
								(input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Recherche"
								class="w-full" />
						</span>

						<p-dropdown [style]="{'margin-bottom':'2px', 'margin-left': '3px'}" [options]="statutList"
							(onChange)="dt1.filter($event.value, 'user_id.statut', 'equals');" placeholder="Statut"
							[showClear]="true"></p-dropdown>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th>Collaborateur</th>
						<th>Site</th>
						<th>Checkin</th>
						<th>Pause</th>
						<th>Checkout</th>
						<th style="width: 8rem">
							Taux CRA
						</th>
						<th style="width: 8rem">
							Statut
						</th>
						<th>
							Action
						</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-check>
					<tr (click)="onGetUserChecksHistorique(check);" style="cursor: pointer;">
						<td style="min-width: 12rem;">
							{{check?.user_id?.lastname | uppercase}} {{check?.user_id?.firstname | titlecase}}
						</td>
						<td>
							{{dicCollaborateurs[check?.user_id._id]?.localisation}}
						</td>
						<td style="min-width: 14rem;">
							<strong>IMS: </strong>{{check?.check_in | date: 'H:mm'}}<br>
							<strong>Pointage: </strong>{{getCheckIn(check?.user_id?._id) | date:'H:mm'}}
						</td>
						<td style="min-width: 10rem;padding: 0%;">
							<app-pause-read-more [pausemin]="check?.pause_timing"
								[pauseList]="check?.pause"></app-pause-read-more>
						</td>
						<td style="min-width: 10rem;">
							<strong>IMS: </strong>{{check?.check_out | date: 'H:mm'}}<br>
							<strong>Pointage: </strong>{{getCheckOut(check?.user_id?._id) | date:'H:mm'}}
						</td>

						<td *ngIf="check?.taux_cra" style="min-width: 12rem;"
							[ngClass]="{'cra-none':check?.taux_cra<1,'cra-perfect':check?.taux_cra>99,'cra-middle':(check?.taux_cra>=1 && check?.taux_cra<=99)}">
							{{check?.taux_cra}}% <i *ngIf="check.validated" class="pi pi-check" tooltipPosition="bottom"
								pTooltip="CRA Validé"></i> <i *ngIf="!check.validated" class="pi pi-times"
								tooltipPosition="bottom" pTooltip="CRA Non validé"></i>
						</td>
						<td *ngIf="!check?.taux_cra" style="min-width: 12rem;" class="cra-none">
							0% <i *ngIf="check.validated" class="pi pi-check" tooltipPosition="bottom"
								pTooltip="CRA Validé"></i> <i *ngIf="!check.validated" class="pi pi-times"
								tooltipPosition="bottom" pTooltip="CRA Non validé"></i>
						</td>

						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Disponible'">
							<p-tag value="Disponible" severity="success" icon="pi pi-check"></p-tag>
						</td>
						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En congé'">
							<p-tag value="En congé" icon="pi pi-home" severity="info"></p-tag>
						</td>
						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En réunion'">
							<p-tag value="En réunion" severity="warning" icon="pi pi-phone"></p-tag>
						</td>
						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Occupé'">
							<p-tag value="Occupé" severity="danger" icon="pi pi-pencil"></p-tag>
						</td>
						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Absent'">
							<p-tag value="Absent" icon="pi pi-times" severity="danger"></p-tag>
						</td>
						<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En pause'">
							<p-tag value="En pause" severity="warning" icon="pi pi-moon"></p-tag>
						</td>
						<td>
							<i pTooltip="Valider CRA" style="cursor: pointer;" class="pi pi-check"
								tooltipPosition="bottom" (click)="onValidateCRA(check)" aria-hidden="true"></i>
							<i pTooltip="Pointage" style="cursor: pointer;" class="pi pi-camera"
								tooltipPosition="bottom" (click)="seePointage(check)" aria-hidden="true"></i>
							<i pTooltip="Réinitialiser Pointage" style="margin-left: 2%; cursor: pointer;"
								class="pi pi-clock" tooltipPosition="bottom" (click)="onReinitPointage(check)"
								aria-hidden="true"></i>
							<i pTooltip="Note" style="margin-left: 2%; cursor: pointer;" class="pi pi-pencil"
								tooltipPosition="bottom" (click)="takeNote(check)" aria-hidden="true"></i>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="6">Aucun utilisateurs trouvé.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="6">Chargement des données, veuillez patienter...</td>
					</tr>
				</ng-template>
			</p-table>
		</div>

		<!-- affichage de l'historique de pointage -->
		<div class="card" *ngIf="showUserChecksHistorique">
			<i class="pi pi-times-circle" (click)="showUserChecksHistorique = false"
				style="float: right; font-size: 20px; cursor: pointer; color: red;"></i>
			<div style="clear: right;"></div>

			<h3 class="text-center">
				Historique
			</h3>
			<p-table #dtHisto [value]="userChecksHistorique" dataKey="_id" [rows]="10" [loading]="loading"
				[rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
				[globalFilterFields]="['user_id.firstname','user_id.lastname','user_id.email','user_id.phone']"
				responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<input pInputText type="date" #filter (input)="onFilter($event.target.value)"
							placeholder="Recherche par date" />
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th> Date </th>
						<th>Checkin</th>
						<th>Pause</th>
						<th>Checkout</th>
						<th style="width: 8rem"> Taux CRA </th>
						<th>Action</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-check>
					<tr>
						<td style="min-width: 12rem;">
							{{check?.today}}
						</td>
						<td style="min-width: 14rem;">
							<strong>IMS: </strong>{{check?.check_in | date: 'H:mm'}}<br>
							<strong>Pointage: </strong>WIP
						</td>
						<td style="min-width: 14rem;">
							WIP
						</td>
						<td style="min-width: 10rem;">
							<strong>IMS: </strong>{{check?.check_out | date: 'H:mm'}}<br>
							<strong>Pointage: </strong>WIP
						</td>
						<td style="min-width: 12rem;" *ngIf="check.taux_cra">
							{{check?.taux_cra}}%
						</td>
						<td style="min-width: 12rem;" *ngIf="!check.taux_cra">
							0%
						</td>
						<td>
							<i pTooltip="Valider CRA" style="cursor: pointer;" class="pi pi-check"
								tooltipPosition="bottom" (click)="onValidateCRA(check)" aria-hidden="true"></i>
							<i pTooltip="Note" style="margin-left: 2%; cursor: pointer;" class="pi pi-pencil"
								tooltipPosition="bottom" (click)="takeNote(check)" aria-hidden="true"></i>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="8">Aucun historique de pointage trouvé.</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>
</div>

<p-dialog header="Ajouter une note" [(visible)]="displayNote" [modal]="true" showEffect="fade" [style]="{width: '50vw'}"
	[breakpoints]="{'960px': '75vw'}">
	<div [style]="{'width':'100%'}" *ngIf="noteCheck" class="grid">
		<div class="col-12">
			<label class="mb-1">Commentaire</label><br>
			<textarea rows="5" cols="60" pInputTextarea [(ngModel)]="noteCheck.commentaire"></textarea>
		</div>

		<p-table class="col-12" [value]="['']" dataKey="_id" styleClass="p-datatable-gridlines"
			responsiveLayout="scroll">
			<ng-template pTemplate="header">
				<tr>
					<th>Commenté le</th>
					<th>Commenté par</th>
				</tr>
			</ng-template>
			<ng-template pTemplate="body">
				<tr>
					<td>{{noteCheck?.commented_by?.firstname | titlecase}} {{noteCheck?.commented_by?.lastname |
						uppercase}}</td>
					<td>{{noteCheck?.commented_date|date:'dd MMMM yy'}}</td>
				</tr>
			</ng-template>
		</p-table>
		<p-button class="col-12" [style]="{'width':'35%'}" (click)="saveNote(noteCheck)" icon="pi pi-plus"
			autoWidth="false" label="Sauvegarder le commentaire"></p-button>
	</div>
</p-dialog>

<p-dialog *ngIf="choosenCollaborateur" header="Activité de {{choosenCollaborateur.user_id.lastname}} {{choosenCollaborateur.user_id.firstname}}" [(visible)]="displayActivite" [modal]="true">
	<div style="width: 100%;">
		<p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true"
			[value]="pointages" [paginator]="true" [pageLinks]="5" selectionMode="single"
			[globalFilterFields]="['uid', 'machine']" responsiveLayout="scroll" styleClass="p-datatable-gridlines">
			<!--<ng-template pTemplate="caption">
				<span class="p-input-icon-left mb-2">
					<i class="pi pi-search"></i>
					<input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')"
						placeholder="Recherche" class="w-full" />
				</span>
			</ng-template>-->
			<ng-template pTemplate="header">
				<tr>
					<th pSortableColumn="date" scope="col" style="text-align: center;">
						Heure <p-sortIcon field="date"></p-sortIcon>
					</th>
					<th>
						ID
					</th>
					<th pSortableColumn="uid" scope="col" style="text-align: center;">
						UID <p-sortIcon field="uid"></p-sortIcon>
					</th>
					<th>
						Site
					</th>
					<th>
						Emplacement
					</th>
					<th pSortableColumn="type" scope="col" style="text-align: center;">
						Type <p-sortIcon field="type"></p-sortIcon>
					</th>
				</tr>
			</ng-template>
			<ng-template pTemplate="body" let-point>
				<tr>
					<td>
						{{point.date | date:'H:mm' }}
					</td>
					<td>
						{{machineDic[point.machine]._id | slice:0:5}}
					</td>
					<td>
						{{point.uid}}
					</td>
					<td>
						{{machineDic[point.machine].localisation}}
					</td>
					<td>
						{{machineDic[point.machine].emplacement}}
					</td>
					<td>
						{{point.type}}
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</p-dialog>

<p-dialog header="Valider CRA" [(visible)]="displayCRA" [modal]="true" showEffect="fade" [style]="{width: '50vw'}"
	[breakpoints]="{'960px': '75vw'}">
	<div [style]="{'width':'100%'}" *ngIf="dataCHECK">
		<p-toggleButton autoWidth="false" [style]="{'width':'100%'}" onLabel="Validé" offLabel="Non validé"
			offIcon="pi pi-times" onIcon='pi pi-check' [(ngModel)]="dataCHECK.validated"
			(onChange)="saveCheck(dataCHECK)"> <!-- ERREUR VSCode Qui n'en est pas une -->
		</p-toggleButton>
		<p>&nbsp;</p>
		<p-table [value]="dataCHECK?.cra" dataKey="_id" styleClass="p-datatable-gridlines" responsiveLayout="scroll">
			<ng-template pTemplate="header">
				<tr>
					<th>Durée</th>
					<th>Tâche</th>
				</tr>
			</ng-template>
			<ng-template pTemplate="body" let-cra let-editing="editing" let-ri="rowIndex">
				<tr [pEditableRow]="cra">
					<td>
						{{cra.number_minutes}} mn
					</td>
					<td>
						{{cra.task}}
					</td>
				</tr>
			</ng-template>
			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="3">Aucun CRA pour le moment.</td>
				</tr>
			</ng-template>
			<ng-template pTemplate="loadingbody">
				<tr>
					<td colspan="3">Chargement des CRA, merci de patienter...</td>
				</tr>
			</ng-template>
		</p-table>
	</div>

</p-dialog>