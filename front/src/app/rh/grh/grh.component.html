<p-toast></p-toast>
<div class="grid">
    <div class="col-12">
        <div class="card">
            <div class="col-12">
                <button pButton pRipple type="button" icon="pi pi-list" label="Compte rendu d'activité" class="p-button-outlined mr-2 mb-2" (click)="onGetPresences(); showPresenceList = true;"></button>
                <button pButton pRipple type="button" icon="pi pi-file" label="Démandes de congés" class="p-button-outlined mr-2 mb-2" (click)="onGetConges(); showCongeList = true;"></button>
                <button pButton pRipple type="button" icon="pi pi-times-circle" label="Abscences" class="p-button-outlined mr-2 mb-2" (click)="onGetAbscences(); showAbscenceList = true;"></button>
            </div>
            
            <div class="col-12">
                <i class="pi pi-times-circle"
                        style="float:right; margin-right: 30px; font-size: 20px; color: red; cursor: pointer;"
                        pTooltip="Fermer" *ngIf="showPresenceList == true" (click)="showPresenceList = false;" aria-hidden="true"> </i>

                <!-- Table d'affichage du compte rendu d'activité -->
                <div class="card" *ngIf="showPresenceList">
                    
                    <h5>Liste des présences</h5>
                    
                    <p-table [value]="presences" dataKey="_id" responsiveLayout="scroll"
                             rowExpandMode="single" [rows]="10" [rowHover]="true" [totalRecords]="presences.length"
                             [paginator]="true" #dt1 [globalFilterFields]="['statut', 'principale_activity_details', 'user_id.firstname', 'user_id.lastname', 'user_id.email', 'user_id.type', 'user_id.email_perso', 'date_of_the_day']">
                    
                            <ng-template pTemplate="caption">
                                <input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Recherche" />

                                <p-dropdown [style]="{'margin':'5px'}" [options]="typeList" filter="true"
                                    (onChange)="dt1.filter($event.value, 'user_id.type', 'equals')"
                                    emptyFilterMessage="Type non trouvé" filterPlaceholder="Type"></p-dropdown>
                            </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem"></th>
                                <th>Prénom</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Statut</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-presence let-expanded="expanded">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="presence" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <td style="min-width: 8rem;">{{ presence.user_id?.firstname | titlecase }}</td>
                                <td style="min-width: 8rem;">{{ presence.user_id?.lastname | uppercase }}</td>
                                <td style="min-width: 8rem;">{{ presence.user_id?.email }}</td>
                                <td style="min-width: 8rem;">{{ presence.user_id?.type }}</td>
                                <td style="min-width: 8rem;">{{ presence.date_of_the_day }}</td>
                                <td style="min-width: 8rem; font-weight: bolder;">{{ presence.statut }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-presence>
                            <tr>
                                <td colspan="7">
                                    <div class="p-3">
                                        <p-table responsiveLayout="scroll">
                                            <ng-template pTemplate="header">
                                                <tr>
                                                    <th>Téléphone</th>
                                                    <th>Heure d'arrivée</th>
                                                    <th>heure de depart</th>
                                                    <th *ngIf="presence.number_of_hour != null">Nombre d'heures</th>
                                                    <th>Tâches</th>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="body" let-presence>
                                                <tr>
                                                    <td colspan="8">Aucune données supplémentaires.</td>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="emptymessage">
                                                <tr>
                                                    <td>{{ presence.user_id?.indicatif }}{{ presence.user_id?.phone }}</td>
                                                    <td>{{ presence.in_date | date: 'H:mm' }}</td>
                                                    <td>{{ presence.out_date | date: 'H:mm' }}</td>
                                                    <td *ngIf="presence.number_of_hour != null && presence.number_of_hour > 0">{{ presence.number_of_hour }} h</td>
                                                    <td *ngIf="presence.number_of_hour != null && presence.number_of_hour == 0">-1 h</td>
                                                    <td>
                                                        <ul>
                                                            <li *ngFor="let task of presence.activity_details; let i = index">{{ task }}</li>
                                                        </ul>
                                                    </td>
                                                </tr>
                                            </ng-template>
                                        </p-table>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>

            <!-- Affichage de la liste des demandes de congés -->
            <div class="col-12">
                <div class="card" *ngIf="showCongeList">
                    <i class="pi pi-times-circle"
                        style="float:right; font-size: 20px; color: red; cursor: pointer;"
                        pTooltip="Fermer" (click)="showCongeList = false;" aria-hidden="true"> </i>

                    <h5>Liste des demandes de congés</h5>
                    
                    <p-table [value]="conges" dataKey="_id" responsiveLayout="scroll"
                             rowExpandMode="single" [rows]="10" [rowHover]="true" [totalRecords]="presences.length"
                             [paginator]="true" #dt2 [globalFilterFields]="['statut', 'referent_id.firstname', 'referent_id.lastname', 'referent_id.email', 'user_id.firstname', 'user_id.lastname', 'user_id.email']">
                    
                            <ng-template pTemplate="caption">
                                <input pInputText type="text" #filter (input)="dt2.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Recherche" />

                            </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem"></th>
                                <th>Nom</th>
                                <th>Prénom</th>
                                <th>Email</th>
                                <th>Debut</th>
                                <th>Fin</th>
                                <th>Statut</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-conge let-expanded="expanded">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="conge" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <td style="min-width: 8rem;">{{ conge.user_id?.lastname | uppercase }}</td>
                                <td style="min-width: 8rem;">{{ conge.user_id?.firstname | titlecase }}</td>
                                <td style="min-width: 8rem;">{{ conge.user_id?.email }}</td>
                                <td style="min-width: 8rem;">{{ conge.user_id?.date_debut }}</td>
                                <td style="min-width: 8rem;">{{ conge.date_fin }}</td>
                                <td style="min-width: 8rem; font-weight: bold;">{{ conge.statut }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-conge>
                            <tr>
                                <td colspan="7">
                                    <div class="p-3">
                                        <p-table responsiveLayout="scroll">
                                            <ng-template pTemplate="header">
                                                <tr>
                                                    <th>Réferent</th>
                                                    <th>Email du réferent</th>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="body" let-conge>
                                                <tr>
                                                    <td colspan="8">Aucune données supplémentaires.</td>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="emptymessage">
                                                <tr>
                                                    <td style="min-width: 8rem;">{{ conge.referent_id?.lastname | uppercase }} {{ conge.referent_id?.firstname | titlecase }}</td>
                                                    <td>{{ conge.referent_id?.email }}</td>
                                                </tr>
                                            </ng-template>
                                        </p-table>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>


            <!-- Affichage de la liste des justificatif d'abscence -->
            <div class="col-12">
                <div class="card" *ngIf="showAbscenceList">
                    <i class="pi pi-times-circle"
                        style="float:right; font-size: 20px; color: red; cursor: pointer;"
                        pTooltip="Fermer" (click)="showAbscenceList = false;" aria-hidden="true"> </i>

                    <h5>Justificatifs d'abscences</h5>
                    
                    <p-table [value]="absences" dataKey="_id" responsiveLayout="scroll"
                             rowExpandMode="single" [rows]="10" [rowHover]="true" [totalRecords]="absences.length"
                             [paginator]="true" #dt3 [globalFilterFields]="['motif', 'user_id.firstname', 'user_id.lastname', 'user_id.email', 'date_of_abscence']">
                    
                            <ng-template pTemplate="caption">
                                <input pInputText type="text" #filter (input)="dt3.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Recherche" />

                            </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Nom</th>
                                <th>Prénom</th>
                                <th>Email</th>
                                <th>Date</th>
                                <th>Motif</th>
                                <th>Précision</th>
                                <th>Fichier</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-abscence let-expanded="expanded">
                            <tr>
                                <td style="min-width: 8rem;">{{ abscence.user_id.lastname | uppercase }}</td>
                                <td style="min-width: 8rem;">{{ abscence.user_id.firstname | titlecase }}</td>
                                <td style="min-width: 8rem;">{{ abscence.user_id.email }}</td>
                                <td style="min-width: 8rem;">{{ abscence.date_of_abscence }}</td>
                                <td style="min-width: 8rem;">{{ abscence.motif }}</td>
                                <td style="min-width: 8rem;">{{ abscence.periode }}</td>
                                <td style="min-width: 8rem;" *ngIf="abscence.file_name">
                                    <i class="pi pi-download" title="Télécharger" (click)="downloadFile(abscence.user_id._id, abscence.file_name)"></i>
                                </td>
                                <td style="min-width: 8rem;" *ngIf="!abscence.file_name">
                                    <small>Aucun fichier</small>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>

        </div>
    </div>
</div>