<p-toast></p-toast>
<div class="grid">
	<!-- Ajout d'un collaborateurs -->
	<div class="col-12" *ngIf="showFormAdd">
		<div class="card">
			<div class="add-button-div">
				<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showFormAdd = false;"></i>
			</div>
			<div class="clear-float"></div>
			<h2 class="header">Ajout d'un collaborateur</h2>

			<form class="p-fluid p-formgrid grid" [formGroup]="formAdd" (ngSubmit)="onAdd()">
				<div class="field col-12 md:col-8">
					<label htmlFor="matricule">Matricule</label>
					<input pInputText id="matricule" type="text" placeholder="Numéro matricule du collaborateur"
						formControlName="matricule" />
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="date_demarrage">Date de démarrage</label>
					<p-calendar [showIcon]="true" [showButtonBar]="true" id="date_demarrage"
						formControlName="date_demarrage"></p-calendar>
				</div>
				<div class="field col-12">
					<label>Collaborateur<span class="obligatory"> *</span></label>
					<p-dropdown [options]="agents" placeholder="Veuillez choisir l'agent" filter="true"
						[virtualScroll]="true" itemSize="30" formControlName="user_id"></p-dropdown>
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="date_naissance">Date de naissance</label>
					<p-calendar [showIcon]="true" [showButtonBar]="true" id="date_naissance"
						formControlName="date_naissance"></p-calendar>
				</div>
				<div class="field col-12 md:col-8">
					<label htmlFor="localisation">Site</label>
					<p-multiSelect [options]="localisationList" placeholder="Paris, Tunis..."
						formControlName="localisation"></p-multiSelect>
				</div>
				<div class="field col-12">
					<label htmlFor="poste">Intitulé du poste</label>
					<input pInputText id="poste" type="text" placeholder="ex: Consultant informatique"
						formControlName="intitule_poste" />
				</div>
				<div class="field col-12 md:col-8">
					<label htmlFor="h_cra">Taux horaire</label>
					<div class="p-inputgroup">
						<input type="number" id="h_cra" pInputText placeholder="ex: 7" formControlName="h_cra" />
						<span class="p-inputgroup-addon">h</span>
					</div>
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="type_contrat">Type de contrat<span class="obligatory"> *</span></label>
					<p-dropdown [options]="contratList" placeholder="CDD, CDI, Alternant..."
						formControlName="contrat_type"></p-dropdown>
				</div>
				<div class="field col-12 md:col-12">
					<label htmlFor="statut">Statut</label>
					<p-dropdown [options]="statutList" placeholder="Actif, Démission..."
						formControlName="statut"></p-dropdown>
				</div>

				<button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2"
					[disabled]="formAdd.invalid"></button>
			</form>
		</div>
	</div>

	<!-- Modification d'un collaborateur -->
	<div class="col-12" *ngIf="showFormUpdate">
		<div class="card">
			<div class="add-button-div">
				<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showFormUpdate = false;"></i>
			</div>
			<div class="clear-float"></div>
			<h2 class="header">Modifier les informations du collaborateur</h2>

			<form class="p-fluid p-formgrid grid" [formGroup]="formUpdate" (ngSubmit)="onUpdate()">
				<div class="field col-12 md:col-8">
					<label htmlFor="matricule">Matricule</label>
					<input pInputText id="matricule" type="text" placeholder="Numéro matricule du collaborateur"
						formControlName="matricule" />
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="date_demarrage">Date de démarrage</label>
					<p-calendar [showIcon]="true" [showButtonBar]="true" id="date_demarrage"
						formControlName="date_demarrage"></p-calendar>
				</div>
				<div class="field col-12">
					<label>Collaborateur<span class="obligatory">*</span></label>
					<p-dropdown [options]="agents" placeholder="Veuillez choisir l'agent" filter="true"
						[disabled]="true" formControlName="user_id"></p-dropdown>
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="date_naissance">Date de naissance</label>
					<p-calendar [showIcon]="true" [showButtonBar]="true" id="date_naissance"
						formControlName="date_naissance"></p-calendar>
				</div>
				<div class="field col-12 md:col-8">
					<label htmlFor="localisation">Site</label>
					<p-multiSelect [options]="localisationList" placeholder="Paris, Tunis..."
						formControlName="localisation"></p-multiSelect>
				</div>
				<div class="field col-12">
					<label htmlFor="poste">Intitulé du poste</label>
					<input pInputText id="poste" type="text" placeholder="ex: Consultant informatique"
						formControlName="intitule_poste" />
				</div>
				<div class="field col-12 md:col-8">
					<label htmlFor="h_cra">Taux horaire</label>
					<div class="p-inputgroup">
						<input type="number" id="h_cra" pInputText placeholder="ex: 7" formControlName="h_cra" />
						<span class="p-inputgroup-addon">h</span>
					</div>
				</div>
				<div class="field col-12 md:col-4">
					<label htmlFor="type_contrat">Type de contrat<span class="obligatory">*</span></label>
					<p-dropdown [options]="contratList" placeholder="CDD, CDI, Alternant..."
						formControlName="contrat_type"></p-dropdown>
				</div>
				<div class="field col-12 md:col-12">
					<label htmlFor="statut">Statut</label>
					<p-dropdown [options]="statutList" placeholder="Actif, Démission..."
						formControlName="statut"></p-dropdown>
				</div>

				<button pButton pRipple type="submit" label="Mettre à jour" class="p-button-primary mb-2"></button>
			</form>
		</div>
	</div>

	<!-- Modification des informations personnelles du collaborateur -->
	<div class="col-12" *ngIf="showFormUpdatePersonalInfo">
		<div class="card">
			<div class="add-button-div">
				<i class="pi pi-times-circle close-icon" pTooltip="Fermer"
					(click)="showFormUpdatePersonalInfo = false;"></i>
			</div>
			<div class="clear-float"></div>
			<h2 class="header">Modifier les informations personnelles du collaborateur</h2>

			<form class="p-fluid p-formgrid grid" [formGroup]="formUpdatePersonalInfo"
				(ngSubmit)="onUpdatePersonalData()">
				<div class="field col-12 md:col-2">
					<label>Civilité</label>
					<p-dropdown [options]="civiliteList" placeholder="M, Mme..."
						formControlName="civilite"></p-dropdown>
				</div>
				<div class="field col-12 md:col-5">
					<label htmlFor="lastname">Nom</label>
					<input pInputText id="lastname" type="text" placeholder="ex: SAll" formControlName="lastname" />
				</div>
				<div class="field col-12 md:col-5">
					<label htmlFor="firstname">Prénom</label>
					<input pInputText id="firstname" type="text" placeholder="ex: Idrissa"
						formControlName="firstname" />
				</div>
				<div class="field col-12 md:col-3">
					<label htmlFor="indicatif">Indicatif</label>
					<input pInputText id="indicatif" type="number" placeholder="ex: 0033" formControlName="indicatif" />
				</div>
				<div class="field col-12 md:col-9">
					<label htmlFor="phone">Téléphone</label>
					<input pInputText id="phone" type="number" placeholder="ex: 767978281" formControlName="phone" />
				</div>
				<div class="field col-12 md:col-6">
					<label htmlFor="email">Email professionnelle</label>
					<input pInputText id="email" type="email" placeholder="ex: i.sall@intedgroup.com"
						formControlName="email" />
				</div>
				<div class="field col-12 md:col-6">
					<label htmlFor="email_perso">Email personnelle</label>
					<input pInputText id="email" type="email_perso" placeholder="ex: i.sall@gmail.com"
						formControlName="email_perso" />
				</div>

				<button pButton pRipple type="submit" label="Mettre à jour" class="p-button-primary mb-2"></button>
			</form>
		</div>
	</div>

	<!-- Formulaire d'ajout de nouvelle compétences -->
	<div class="col-12" *ngIf="showFormAddCompetence">
		<div class="card">
			<div class="add-button-div mb-2">
				<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showFormAddCompetence = false;"></i>
			</div>
			<div class="clear-float"></div>
			<h2 class="header">Ajouter des compétences à {{collaborateurToUpdate?.user_id?.lastname | uppercase}}
				{{collaborateurToUpdate?.user_id?.firstname}}</h2>

			<form class="p-fluid" [formGroup]="formAddCompetence" (ngSubmit)="onAddCollaborateurSkills()">
				<div formArrayName="competences"
					*ngFor="let competence of getCompetences().controls; let i = index; let c = count">
					<div class="p-formgrid grid" [formGroupName]="i">
						<div class="field col-12 md:col-5">
							<input pInputText id="kind" type="text" placeholder="Compétence" formControlName="kind" />
						</div>
						<div class="field col-12 md:col-5">
							<p-dropdown id="level" [options]="levelList" placeholder="Niveau"
								formControlName="level"></p-dropdown>
						</div>
						<div class="col-12 md:col-2" *ngIf="c > 1">
							<button pButton pRipple pTooltip="Supprimer la ligne" type="button" icon="pi pi-trash"
								class="p-button-outlined p-button-danger mb-2" (click)="onDeleteCompetence()"></button>
						</div>
					</div>
				</div>
				<button pButton pRipple type="button" icon="pi pi-plus" class="p-button-outlined p-button-success mb-2"
					(click)="onAddCompetence()"></button>

				<div class="col-2">
					<button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2"></button>
				</div>
			</form>
		</div>
	</div>

	<!-- Affichage du tableau pour la gestion des compétences -->
	<div class="col-12" *ngIf="showCompetenceTable">
		<div class="card">
			<div class="add-button-div mb-2">
				<i class="pi pi-times-circle close-icon" pTooltip="Fermer"
					(click)="showCompetenceTable = false; showFormAddCompetence = false;"></i>
			</div>
			<div class="clear-float"></div>
			<div class="add-button-div">
				<button pButton pRipple type="button" label="Ajouter une compétence"
					(click)="showFormAdd = false; showFormUpdate = false; showFormUpdatePersonalInfo = false; showFormAddCompetence = true;"
					class="p-button-outlined p-button-primary"></button>
			</div>
			<div class="clear-float"></div>

			<h2 class="header">Compétences du collaborateur</h2>

			<p-table #dt1 [value]="collaborateurCompetences" dataKey="_id" editMode="row" [rows]="5" [rowHover]="true"
				styleClass="p-datatable-gridlines" [paginator]="true" [globalFilterFields]="['kind', 'level']"
				responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter
								(input)="dt1.filterGlobal($event.target.value, 'contains')"
								placeholder="Filtrer les compétences" class="w-full" />
						</span>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th>
							<div class="flex justify-content-between align-items-center">
								Compétence
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Niveau
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Action
							</div>
						</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-competence let-editing="editing" let-ri="rowIndex">
					<tr [pEditableRow]="competence">
						<td style="min-width: 10rem;">
							<p-cellEditor>
								<ng-template pTemplate="input">
									<input pInputText type="text" [(ngModel)]="competence.kind">
								</ng-template>
								<ng-template pTemplate="output">
									{{competence.kind}}
								</ng-template>
							</p-cellEditor>
						</td>
						<td style="min-width: 10rem;">
							<p-cellEditor>
								<ng-template pTemplate="input">
									<p-dropdown [options]="levelList" appendTo="body" [(ngModel)]="competence.level"
										[style]="{'width':'100%'}"></p-dropdown>
								</ng-template>
								<ng-template pTemplate="output">
									{{competence.level}}
								</ng-template>
							</p-cellEditor>
						</td>
						<td class="text-center" style="min-width: 8rem;">
							<button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil"
								(click)="onRowEditInit(competence)" class="p-button-rounded p-button-text"></button>
							<button pButton pRipple type="button" icon="pi pi-trash"
								class="p-button-rounded p-button-text p-button-danger"
								(click)="onDeleteCollaborateurCompetence(competence._id)"></button>
							<button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check"
								(click)="onRowEditSave(competence)"
								class="p-button-rounded p-button-text p-button-success mr-2"></button>
							<button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times"
								(click)="onRowEditCancel(competence, ri)"
								class="p-button-rounded p-button-text p-button-danger"></button>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="3">Aucune compétence trouvé.</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>

	<!-- Affichage du cra -->
	<div class="col-12" *ngIf="showCra">
		<div class="add-button-div">
			<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showCra = false;"></i>
		</div>
		<div class="card">
			<p-sidebar [(visible)]="showCra" [fullScreen]="true" [baseZIndex]="10000">
				<h3 class="header">C.R.A</h3>
				<p-table [value]="historiqueCraSelected.cra" dataKey="_id" [rows]="4" [rowHover]="true"
					styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
					<ng-template pTemplate="header">
						<tr>
							<th>Cra du {{dateParseur(historiqueCraSelected.today)}}</th>
						</tr>
						<tr>
							<th>Tâche</th>
							<th>Durée</th>
						</tr>
					</ng-template>
					<ng-template pTemplate="body" let-cra>
						<tr>
							<td>{{cra.task}}</td>
							<td>{{cra.number_minutes}}mn</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="emptymessage">
						<tr>
							<td colspan="2">Aucun CRA pour le moment.</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="loadingbody">
						<tr>
							<td colspan="2">Chargement des CRA, merci de patienter...</td>
						</tr>
					</ng-template>
				</p-table>
			</p-sidebar>
		</div>
	</div>

	<!-- Affichage de la list des CRA de l'utilisateur -->
	<div class="col-12" *ngIf="showHistoriqueCra">
		<div class="add-button-div">
			<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showHistoriqueCra = false;"></i>
		</div>
		<div class="card">
			<i class="pi pi-times-circle mb-2" style="color: red; font-size: 20px; cursor: pointer; float: right;"
				(click)="showHistoriqueCra = false"></i>
			<div style="clear: both;"></div>

			<p-table [value]="historiqueCra" dataKey="_id" [rows]="4" [rowHover]="true"
				styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
				<ng-template pTemplate="header">
					<tr>
						<th>Date</th>
						<th>Heure Check in</th>
						<th>Heure Check out</th>
						<th>Heures pauses</th>
						<th>Taux CRA</th>
						<th>Action</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-cra>
					<tr>
						<td>{{dateParseur(cra.today)}}</td>
						<td>{{cra.check_in | date:'H:mm'}}</td>
						<td>{{cra.check_out | date:'H:mm'}} <span *ngIf="cra.auto">AUTOMATIQUE</span></td>
						<td>{{cra.pause_timing}}mn</td>
						<td>{{cra.taux_cra | number:'1.0-2'}}%</td>
						<td>
							<button pButton pRipple label="Afficher CRA" class="p-button-success p-button-outlined mb-2"
								(click)="historiqueCraSelected = cra; showCra = true"></button>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="6">Vous n'avez aucun pointage enregistré pour le moment.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="6">Chargement de votre historique, merci de patienter...</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>

	<!-- Job description -->
	<div class="col-12" *ngIf="showJobDescription">
		<div class="add-button-div">
			<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="showJobDescription = false;"></i>
		</div>
		<div class="card">
			<p-sidebar [(visible)]="showJobDescription" [fullScreen]="true" [baseZIndex]="10000">
				<!-- formulaire de mise à jour de la description du poste du collaborateur -->
				<div class="card" *ngIf="showFormUpdateJobDescriptionForm">
					<div class="add-button-div">
						<i class="pi pi-times-circle close-icon" pTooltip="Fermer"
							(click)="showFormUpdateJobDescriptionForm = false;"></i>
					</div>
					<div class="clear-float"></div>
					<h3 class="header">Mettre à jour la description du poste</h3>

					<form class="p-fluid p-formgrid grid" [formGroup]="formUpdateJobDescription"
						(ngSubmit)="onUpdateJobDescription()">
						<div class="field col-12">
							<label htmlFor="description">Description</label>
							<textarea pInputTextarea id="description" placeholder="Description du poste" autoResize
								rows="4" cols="30" formControlName="description"></textarea>
						</div>

						<button pButton pRipple label="Mettre à jour" type="submit"></button>
					</form>
				</div>

				<div class="add-button-div">
					<button pButton pRipple type="button" label="Mettre à jour"
						(click)="showFormUpdateJobDescriptionForm = true"
						class="p-button-outlined p-button-primary"></button>
				</div>
				<div class="clear-float"></div>

				<h3 class="header">Description du poste du collaborateur</h3>
				<p style="text-align: center">{{ collaborateurToUpdate?.poste_description }}</p>
			</p-sidebar>
		</div>
	</div>

	<div class="col-12" *ngIf="showEmailView">
		<div class="card">
			<i class="pi pi-times-circle mb-2" style="color: red; font-size: 20px; cursor: pointer; float: right;"
				(click)="showEmailView = false"></i><br>
			<p-tabView>
				<p-tabPanel header="Email personnalisé">
					<form class="p-fluid p-formgrid grid col-12" [formGroup]="formEmailPerso">
						<div class="col-12" style="text-align: right;">
							Email du destinataire: <span
								style="color: red; font-weight: bolder">{{collaborateurToUpdate.user_id?.email}}</span>
						</div>

						<div class="field col-12">
							<label>Objet: </label>
							<input type="text" formControlName="objet" pInputText>
						</div>
						<div class="field col-12">
							<p-editor formControlName="body" [style]="{'height':'320px'}"></p-editor>
						</div>
						<div class="field col-6">
							<label>Email de l'envoyeur: </label>
							<p-dropdown placeholder="Choisissez une adresse mail" filter="true"
								formControlName="send_from" [options]="mailDropdown" autoWidth="false"
								[style]="{'width':'100%'}">
							</p-dropdown>
						</div>
						<div class="field col-6">
							<label>Email(s)en cc: </label>
							<p-chips formControlName="cc" separator=","
								placeholder="email1@email.com , email2.email.com"></p-chips>
						</div>
						<div class="field col-12">
							<input type="file" (change)="FileUploadPJ($event.target.files)" id="selectedFile"
								#selectedFile style="display: none;" pInputFile />
							<p-table styleClass="p-datatable-gridlines" [value]="piece_jointes"
								responsiveLayout="scroll" dataKey="_id" class="col-12" responsiveLayout="scroll">
								<ng-template pTemplate="header" let-columns>
									<tr>
										<th>
											Date d'upload
										</th>
										<th>
											Nom du document
										</th>
										<th>
											Lien de téléchargement
										</th>
										<th>
											Action
										</th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-rowData let-editing="editing" let-ri="rowIndex">
									<tr>
										<td>
											{{rowData.date | date:'dd MMMM yy'}}
										</td>
										<td
											*ngIf="rowData.nom && rowData.nom!='Téléverser le fichier s\'il vous plaît'">
											{{rowData.nom}}
										</td>
										<td
											*ngIf="(!rowData.nom || rowData.nom=='Téléverser le fichier s\'il vous plaît') && rowData.path">
											{{rowData?.path}}
										</td>
										<td
											*ngIf="(!rowData.nom || rowData.nom=='Téléverser le fichier s\'il vous plaît') && !rowData.path">
											Téléverser le fichier s'il vous plaît
										</td>
										<td *ngIf="rowData.path">
											<a style="cursor: pointer;"
												(click)="downloadPJFile(rowData)">Télécharger</a>
											{{rowData.path}}
										</td>
										<td *ngIf="!rowData.path">
											<a style="cursor: pointer;" (click)="onUploadPJ(rowData)">Upload</a>
										</td>
										<td>
											<i pTooltip="Uploader un fichier" tooltipPosition="bottom"
												class="pi pi-cloud-upload mr-2" style="cursor: pointer;"
												(click)="onUploadPJ(rowData)">
											</i>
											<i pTooltip="Supprimer un fichier" tooltipPosition="bottom"
												class="pi pi-trash mr-2" style="cursor: pointer;"
												(click)="onDeletePJ(ri)">
											</i>
										</td>
									</tr>
								</ng-template>
							</p-table>
							<div class="mt-2 col-12" style="text-align: center;">
								<button pButton (click)="onAddPj()" label="Ajouter une nouvelle pièces jointe"
									autoWidth="false" [style]="{'width':'30%'}"></button>
							</div>
						</div>
						<div style="width: 100%;text-align: center;">
							<button pButton [disabled]="formEmailPerso.invalid" (click)="onEmailPerso()"
								[style]="{'width':'30%'}" label="Envoyer l'email"></button>
						</div>

					</form>
				</p-tabPanel>

				<p-tabPanel header="Depuis un mail type">
					<form class="p-fluid p-formgrid grid col-12" [formGroup]="formEmailType">
						<div class="field col-12">
							<label>Email Type: </label>
							<p-dropdown placeholder="Choisissez un mail type" filter="true"
								(onChange)="onMailType($event.value)" [options]="mailTypeDropdown" autoWidth="false"
								[style]="{'width':'100%'}">
							</p-dropdown>
						</div>
						<div class="col-12" style="text-align: right">
							Email du destinataire: <span
								style="color: red;">{{collaborateurToUpdate.user_id.email}}</span>
						</div>

						<div class="field col-12">
							<label>Objet: </label>
							<input type="text" formControlName="objet" pInputText>
						</div>
						<div class="field col-12">
							<p-editor formControlName="body" [style]="{'height':'320px'}"></p-editor>
						</div>
						<div class="field col-6">
							<label>Email de l'envoyeur: </label>
							<p-dropdown placeholder="Choisissez une adresse mail" filter="true"
								formControlName="send_from" [options]="mailDropdown" autoWidth="false"
								[style]="{'width':'100%'}">
							</p-dropdown>
						</div>
						<div class="field col-6">
							<label>Email(s) en cc: (Écrivez un , après chaque email)</label>
							<p-chips formControlName="cc" separator=","
								placeholder="email1@email.com,email2.email.com"></p-chips>
						</div>
						<div class="field col-12">
							<input type="file" (change)="FileUploadPJ($event.target.files)" id="selectedFile"
								#selectedFile style="display: none;" pInputFile />
							<p-table styleClass="p-datatable-gridlines" [value]="piece_jointes"
								responsiveLayout="scroll" dataKey="_id" class="col-12" responsiveLayout="scroll">
								<ng-template pTemplate="header" let-columns>
									<tr>
										<th>
											Date d'upload
										</th>
										<th>
											Nom du document
										</th>
										<th>
											Lien de téléchargement
										</th>
										<th>
											Action
										</th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-rowData let-editing="editing" let-ri="rowIndex">
									<tr>
										<td>
											{{rowData.date | date:'dd MMMM yy'}}
										</td>
										<td
											*ngIf="rowData.nom && rowData.nom!='Téléverser le fichier s\'il vous plaît'">
											{{rowData.nom}}
										</td>
										<td
											*ngIf="(!rowData.nom || rowData.nom=='Téléverser le fichier s\'il vous plaît') && rowData.path">
											{{rowData?.path}}
										</td>
										<td
											*ngIf="(!rowData.nom || rowData.nom=='Téléverser le fichier s\'il vous plaît') && !rowData.path">
											Téléverser le fichier s'il vous plaît
										</td>
										<td *ngIf="rowData.path">
											<a style="cursor: pointer;"
												(click)="downloadPJFile(rowData)">Télécharger</a>
											{{rowData.path}}
										</td>
										<td *ngIf="!rowData.path">
											<a style="cursor: pointer;" (click)="onUploadPJ(rowData)">Upload</a>
										</td>
										<td>
											<i pTooltip="Uploader un fichier" tooltipPosition="bottom"
												class="pi pi-cloud-upload mr-2" style="cursor: pointer;"
												(click)="onUploadPJ(rowData)">
											</i>
											<i pTooltip="Supprimer un fichier" tooltipPosition="bottom"
												class="pi pi-trash mr-2" style="cursor: pointer;"
												(click)="onDeletePJ(ri)">
											</i>
										</td>
									</tr>
								</ng-template>
							</p-table>
							<div class="mt-2 col-12" style="text-align: center;">
								<button pButton (click)="onAddPj()" label="Ajouter une nouvelle pièces jointe"
									autoWidth="false" [style]="{'width':'30%'}"></button>
							</div>
						</div>
						<div style="width: 100%;text-align: center;">
							<button pButton [disabled]="formEmailType.invalid" label="Envoyer l'email"
								[style]="{'width':'30%'}" (click)="onEmailType()"></button>
						</div>

					</form>
				</p-tabPanel>

				<p-tabPanel header="Historique des emails">
					<p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true"
						[value]="historiqueEmails" [paginator]="true" [pageLinks]="5" selectionMode="single"
						class="col-12" responsiveLayout="scroll" styleClass="p-datatable-gridlines">
						<ng-template pTemplate="header">
							<tr>
								<th style="width: 3rem" scope="col"></th>
								<th pSortableColumn="date_creation" scope="col" style="text-align: center;">
									Date de l'envoie <p-sortIcon field="date_creation"></p-sortIcon>
								</th>
								<th pSortableColumn="objet" scope="col" style="text-align: center;">
									Objet du mail <p-sortIcon field="objet"></p-sortIcon>
								</th>
								<th pSortableColumn="send_by.firstname" scope="col" style="text-align: center;">
									Envoyé par <p-sortIcon field="send_by.firstname"></p-sortIcon>
								</th>
								<th pSortableColumn="cc" scope="col" style="text-align: center;">
									Envoyé à <p-sortIcon field="cc"></p-sortIcon>
								</th>
								<th pSortableColumn="send_from" scope="col" style="text-align: center;">
									Envoyé depuis <p-sortIcon field="send_from"></p-sortIcon>
								</th>
							</tr>
						</ng-template>
						<ng-template pTemplate="body" let-email let-expanded="expanded">
							<tr>

								<td>
									<button type="button" pButton pRipple [pRowToggler]="email"
										class="p-button-text p-button-rounded p-button-plain"
										[icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
								</td>
								<td>
									{{email.date_creation|date:'dd MMMM yy'}}
								</td>
								<td>
									{{email.objet}}
								</td>
								<td>
									{{email?.send_by?.firstname | titlecase}} {{email?.send_by?.lastname | uppercase}}
								</td>
								<td>
									<strong>{{collaborateurToUpdate?.user_id?.email }}</strong>
								</td>
								<td>
									{{email.send_from}}
								</td>
							</tr>
						</ng-template>
						<ng-template pTemplate="rowexpansion" let-email>
							<div [innerHTML]="email.body">

							</div>
						</ng-template>
					</p-table>
				</p-tabPanel>
			</p-tabView>
		</div>
	</div>

	<!-- Voir la liste des documents -->
	<div class="field col-12 card grid" *ngIf="seeFile">
		<div class="add-button-div">
			<i class="pi pi-times-circle close-icon" pTooltip="Fermer" (click)="seeFile = null;"></i>
		</div>
		<input type="file" (change)="FileUploadRH($event.target.files)" id="selectedFileRH" #selectedFileRH
			style="display: none;" pInputFile />
		<p-table styleClass="p-datatable-gridlines" [value]="seeFile.documents_rh" responsiveLayout="scroll"
			dataKey="_id" class="col-12" responsiveLayout="scroll">
			<ng-template pTemplate="header" let-columns>
				<tr>
					<th>
						Date d'upload
					</th>
					<th>
						Nom du document
					</th>
					<th>
						Note du document
					</th>
					<th>
						Lien de téléchargement
					</th>
					<th>
						Action
					</th>
				</tr>
			</ng-template>
			<ng-template pTemplate="body" let-rowData let-editing="editing" let-ri="rowIndex">
				<tr>
					<td>
						{{rowData.date | date:'dd MMMM yy'}}
					</td>
					<td pEditableColumn>
						<p-cellEditor>
							<ng-template pTemplate="input">
								<input type="text" pInputText [(ngModel)]="rowData.filename">
							</ng-template>
							<ng-template pTemplate="output">
								{{rowData.filename}}
							</ng-template>
						</p-cellEditor>
					</td>
					<td pEditableColumn>
						<p-cellEditor>
							<ng-template pTemplate="input">
								<input type="text" pInputText [(ngModel)]="rowData.note">
							</ng-template>
							<ng-template pTemplate="output">
								{{rowData.note}}
							</ng-template>
						</p-cellEditor>
					</td>
					<td *ngIf="rowData.path">
						<a style="cursor: pointer;" (click)="downloadRHFile(rowData)">Télécharger</a>
					</td>
					<td *ngIf="!rowData.path">
						<a style="cursor: pointer;" (click)="onUploadRH(rowData)">Upload</a>
					</td>
					<td>
						<i pTooltip="Uploader un fichier" tooltipPosition="bottom" class="pi pi-cloud-upload mr-2"
							style="cursor: pointer;" (click)="onUploadRH(rowData)">
						</i>
						<i pTooltip="Supprimer un fichier" tooltipPosition="bottom" class="pi pi-trash mr-2"
							style="cursor: pointer;" (click)="onDeleteRH(ri)">
						</i>
					</td>
				</tr>
			</ng-template>
		</p-table>
		<div class="col-6 mt-2" style="text-align: center;">
			<button pButton (click)="onAddRH()" label="Ajouter un document" autoWidth="false"
				[style]="{'width':'50%'}"></button>
		</div>
		<div class="col-6 mt-2" style="text-align: center;">
			<button pButton (click)="saveRH()" label="Sauvegarder les documents" autoWidth="false"
				[style]="{'width':'50%'}"></button>
		</div>
	</div>

	<!-- Liste des n -->
	<div class="col-12">
		<div class="card">
			<div class="add-button-div">
				<button pButton pRipple type="button" label="Ajouter un collaborateur"
					(click)="showFormAdd = true; showFormUpdate = false; showFormUpdatePersonalInfo = false;"
					class="p-button-outlined p-button-primary"></button>
			</div>
			<div class="clear-float"></div>

			<p-table #dt1 [value]="collaborateurs" dataKey="_id" [rows]="8" [loading]="loading" [rowHover]="true"
				styleClass="p-datatable-gridlines" [paginator]="true"
				[globalFilterFields]="['user_id.firstname', 'user_id.lastname', 'user_id.email', 'matricule']"
				responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter
								(input)="dt1.filterGlobal($event.target.value, 'contains')"
								placeholder="Rechercher un collaborateur" class="w-full" />
						</span>
						<p-multiSelect [options]="serviceFilter" filter="true" autoWidth='false'
							[style]="{'width':'20em'}" [showClear]="true"
							(onChange)="dt1.filter($event.value, 'user_id.service_id._id', 'in')"
							placeholder="Choisissez un Service"></p-multiSelect>
						<p-multiSelect [options]="statutFilter" filter="true" autoWidth='false'
							[style]="{'width':'20em'}" (onChange)="dt1.filter($event.value, 'statut', 'in')"
							[showClear]="true" placeholder="Choisissez un statut"></p-multiSelect>
						<p-multiSelect [options]="siteFilter" filter="true" autoWidth='false' [style]="{'width':'20em'}"
							(onChange)="dt1.filter($event.value, 'localisation', 'contains')" [showClear]="true"
							placeholder="Choisissez un site"></p-multiSelect>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th>
							<div class="flex justify-content-between align-items-center">
								Matricule
							</div>
						</th>
						<th pSortableColumn="user_id.lastname" style="text-align:center"> Collaborateur
							<p-sortIcon field="user_id.lastname">
							</p-sortIcon>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Email
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Site
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Poste
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Service
							</div>
						</th>
						<th>
							<div class="flex justify-content-between align-items-center">
								Statut
							</div>
						</th>
						<th style="width: 8rem">
							<div class="flex justify-content-between align-items-center">
								Action
							</div>
						</th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-collaborateur>
					<tr>
						<td [ngClass]="{'periode-begin':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 10rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur.matricule}}
						</td>
						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 12rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}
						</td>

						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 10rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur.user_id?.email}}
						</td>
						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 12rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur?.localisation}}
						</td>
						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 10rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur?.intitule_poste}}
						</td>
						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 10rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur?.user_id?.service_id?.label}}
						</td>
						<td [ngClass]="{'periode-middle':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							style="min-width: 10rem;" (click)="clickDetails(collaborateur)" tooltipPosition="bottom"
							style="cursor: pointer;"
							pTooltip="Voir plus d'informations sur {{collaborateur.user_id?.lastname | uppercase}} {{collaborateur.user_id?.firstname}}">
							{{collaborateur.statut}}
						</td>
						<td [ngClass]="{'periode-end':(collaborateur?.statut=='Période d\'essai' && testDate(collaborateur.date_demarrage))}"
							class="text-center" style="min-width: 8rem;">
							<i class="pi pi-briefcase m-1" pTooltip="Ajouter une compétence" tooltipPosition="bottom"
								style="cursor: pointer; color: #3B82F6"
								(click)="collaborateurToUpdate = collaborateur; onGetCollaborateurCompetence(collaborateur._id); showCompetenceTable = true; showFormAdd = false; showFormUpdate = false; showFormUpdatePersonalInfo = false;"></i>
							<i class="pi pi-pencil m-1" pTooltip="Modifier les informations collaborateurs"
								tooltipPosition="bottom" style="cursor: pointer; color: #22C55E"
								(click)="onFillForm(collaborateur)"></i>
							<i class="pi pi-user-edit m-1" pTooltip="Modifier les informations personnelles"
								tooltipPosition="bottom" style="cursor: pointer;"
								(click)="onFillFormUpdatePersonalData(collaborateur)"></i>
							<!--<i class="pi pi-align-center m-1" pTooltip="Job description" tooltipPosition="bottom"
								style="cursor: pointer; color: #3B82F6"
								(click)="collaborateurToUpdate = collaborateur; onInitFormUpdateJobDescription(); showJobDescription = true"></i>-->
							<i class="pi pi-file m-1" pTooltip="Insérer un document" tooltipPosition="bottom"
								style="cursor: pointer; color: #F59E0B"
								(click)="clickUploadFile(collaborateur.user_id)"></i>
							<i class="pi pi-trash m-1" pTooltip="Supprimer" style="cursor: pointer; color: #EF4444"
								tooltipPosition="bottom" (click)="onRemoveCollaborateur(collaborateur._id)"></i>
							<!--<i class="pi pi-list m-1" pTooltip="CRA" style="cursor: pointer; color: #A855F7"
								tooltipPosition="bottom"
								(click)="onGetHistoriqueCra(collaborateur.user_id?._id); showHistoriqueCra = true;"></i>

							<i pTooltip="Voir l'emploi du temps du salarié" (click)="seeCalendar(collaborateur)"
								tooltipPosition="bottom" class="pi pi-calendar m-1" style="color: #00326b"></i>-->
							<i pTooltip="Envoyer un mail" (click)="onInitEmailView(collaborateur)"
								tooltipPosition="bottom" class="pi pi-envelope m-1" style="color: #C0C0C0"></i>
							<i pTooltip="Voir le résumé des congés" (click)="onInitConge(collaborateur)"
								tooltipPosition="bottom" class="pi pi-calendar-minus m-1" style="color: #469cff"></i>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="17">Aucun collaborateur trouvé.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="17">Chargement des données, merci de patienter...</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>
</div>
<p-dialog *ngIf="dataConge?.user_id"
	header="Fiche congé de {{dataConge?.user_id.firstname}} {{dataConge?.user_id.lastname}}" [(visible)]="displayConge"
	[modal]="true">
	<div class="field col-12" *ngIf="dataConge">
		<label htmlFor="firstname">Solde de congé</label><br>
		<p-inputNumber [(ngModel)]="dataConge.conge_nb" (onBlur)="onUpdateConge()" [style]="{'width':'100%'}"
			suffix="/mois" mode="decimal" [showButtons]="true" [step]="0.25" [minFractionDigits]="1"
			[maxFractionDigits]="2" autoWidth="false"> </p-inputNumber>
	</div>
	<div class="field col-12" *ngIf="dataConge">
		<label htmlFor="firstname">Plafond</label><br>
		<p-inputNumber [(ngModel)]="dataConge.plafond" (onBlur)="onUpdateConge()" [style]="{'width':'100%'}"
			mode="decimal" [showButtons]="true" [step]="0.25" [minFractionDigits]="1" [maxFractionDigits]="2"
			autoWidth="false"> </p-inputNumber>
	</div>
	<div *ngIf="dataConge">
		Accumulé : {{calcCPA()}}<br>

		Pris : {{nbrConge}}<br>

		Reste : {{calcCPA()-nbrConge}}<br>
	</div>

</p-dialog>
<p-dialog header="Informations supplémentaires du Collaborateur" [(visible)]="displayDetails" [modal]="true"
	[style]="{width: '50vw'}">
	<h6 style="text-align: center;">Information collaborateur</h6><br><br>
	<p *ngIf="dataCollab && dataCollab.user_id">
		Civilité : {{dataCollab?.user_id?.civilite}} <br>
		Nom et prénom : {{dataCollab.user_id?.lastname | uppercase}} {{dataCollab.user_id?.firstname}}<br>
		Date de naissance : {{dataCollab?.date_naissance | date: 'dd MMMM yy'}}<br>
		Email travail : {{dataCollab.user_id?.email}}<br>
		Email personnelle : {{dataCollab.user_id?.email_perso}}<br>
		Téléphone personnelle : {{dataCollab.user_id?.indicatif}} {{dataCollab.user_id?.phone}}<br>
		Adresse : {{dataCollab.user_id?.numero_adresse}} {{dataCollab.user_id?.rue_adresse}} <br>
		{{dataCollab.user_id?.postal_adresse}},
		{{dataCollab.user_id?.ville_adresse}}/{{dataCollab.user_id?.pays_adresse}}<br>
	</p>
	<br>
	<hr />
	<h6 style="text-align: center;">Poste</h6><br><br>
	<p *ngIf="dataCollab && dataCollab.user_id">
		Matricule : {{dataCollab?.matricule}}<br>
		Nom du poste : {{dataCollab?.intitule_poste}} <br>
		Service : {{dataCollab?.user_id?.service_id?.label}}<br>
		Mention : {{dataCollab.user_id.mention}}<br>
		Date de démarrage : {{dataCollab?.date_demarrage | date: 'dd MMMM yy'}}<br>
		Ancienneté : {{afficherAnciennete(dataCollab)}} jours<br>
		Type de contrat : {{dataCollab?.contrat_type}}<br>
		Taux horaire : {{dataCollab?.h_cra}}<br>
		Localisation : {{dataCollab?.localisation}}<br>
	</p>
	<br>
	<hr />
	<h6 style="text-align: center;">Autre Informations</h6><br><br>
	<div style="width: 100%;" class="grid">
		<button pButton pRipple label="Ajouter" class="p-button-primary p-button-outlined col-12 mb-2"
			style="float: right;" (click)="addOther()"></button>
		<p-table [value]="dataCollab?.other" dataKey="_id" editMode="row" class="col-12"
			styleClass="p-datatable-gridlines" responsiveLayout="scroll">
			<ng-template pTemplate="header">
				<tr>
					<th>Libellé</th>
					<th>Information</th>
					<th>Action</th>
				</tr>
			</ng-template>
			<ng-template pTemplate="body" let-rowData let-editing="editing" let-ri="rowIndex">
				<tr>
					<td pEditableColumn>
						<p-cellEditor>
							<ng-template pTemplate="input">
								<input pInputText type="text" [(ngModel)]="rowData.title" (blur)="onUpdateRow()">
							</ng-template>
							<ng-template pTemplate="output">
								{{rowData.title}}
							</ng-template>
						</p-cellEditor>
					</td>
					<td pEditableColumn>
						<p-cellEditor>
							<ng-template pTemplate="input">
								<input pInputText type="text" [(ngModel)]="rowData.description" (blur)="onUpdateRow()">
							</ng-template>
							<ng-template pTemplate="output">
								{{rowData.description}}
							</ng-template>
						</p-cellEditor>
					</td>
					<td>
						<button pButton pRipple type="button" icon="pi pi-trash"
							class="p-button-rounded p-button-text p-button-danger" (click)="onDeleteRow(ri)"></button>
					</td>
				</tr>
			</ng-template>
			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="3">Aucun autre information pour le moment.</td>
				</tr>
			</ng-template>
		</p-table>
	</div>

	<hr />
</p-dialog>