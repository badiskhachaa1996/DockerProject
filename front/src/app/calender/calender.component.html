<div class="col-12">
    <input type="file" (change)="FileUploadPC($event.target.files)" id="selectedFile" #selectedFile
        accept=".pdf,.jpg,.png,.jpeg" style="display: none;" pInputFile />
</div>


<p-dialog [style]="{width: '50vw'}" [(visible)]="displayPointeuse" header="Heure de Pointage" [modal]="true">
    <p-table #dtPoi dataKey="_id" [value]="histoPointage" responsiveLayout="scroll" styleClass="p-datatable-gridlines"
        *ngIf="histoPointage">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="date" scope="col" style="text-align: center;">
                    Time <p-sortIcon field="date"></p-sortIcon>
                </th>
                <th pSortableColumn="uid" scope="col" style="text-align: center;">
                    UID <p-sortIcon field="uid"></p-sortIcon>
                </th>
                <th pSortableColumn="user_id" scope="col" style="text-align: center;">
                    Localisation <p-sortIcon field="user_id"></p-sortIcon>
                </th>
                <th pSortableColumn="type" scope="col" style="text-align: center;">
                    Type de Pointage <p-sortIcon field="type"></p-sortIcon>
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-point>
            <tr>
                <td>
                    {{point.date | date:'H:mm' }}
                </td>
                <td>
                    {{point.uid}}
                </td>
                <td>
                    {{machineDic[point.machine]?.localisation}}
                </td>
                <td>
                    {{point.type}}
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-dialog>

<!-- Checking area -->
<div class="grid">
    <div class="col-12">
        <!-- info user -->

        <!-- Tabs avec les cra etc -->
        <div class="card">
            <p-tabView [(activeIndex)]="selectedTabIndex">
                <p-tabPanel header="Pointage">
                    <div class="grid">
                        <div class="col-12 md:col-4">
                            <button pButton pRipple (click)="onCheckIn()" label="Checkin" class="p-button-warning mb-2 "
                                [disabled]="dailyCheck != null" style="width: 150px; height: 80px;"> <i
                                    class="pi pi-sign-in"></i></button> <br>

                            <h6>Temps travail
                                <strong>{{calculTravail()}}</strong>
                            </h6>
                        </div>
                        <div class="col-12 md:col-4">
                            <span *ngIf="!dailyCheck?.isInPause"><button pButton pRipple
                                    (click)="motifStr='Déjeuner';displayMotif=true" label="Pause"
                                    class="p-button-help mb-2"
                                    [disabled]="dailyCheck == null || dailyCheck.check_out != null"
                                    style="width: 150px; height: 80px;"><i class="pi pi-pause"></i></button>
                                <br></span>
                            <span *ngIf="dailyCheck?.isInPause"><button pButton pRipple (click)="onStopPause()"
                                    label="Fin pause" style="width: 150px; height: 80px;background-color: #df6bff;"
                                    class=" mb-2" [disabled]="dailyCheck == null || dailyCheck.check_out != null"><i
                                        class="pi pi-play"></i></button>
                                <br></span>
                            <h6>Temps pause <strong>{{calculPause()}}</strong></h6>


                        </div>
                        <div class="col-12 md:col-4 ">
                            <button pButton pRipple label="Checkout" (click)="onCheckOut()" class="p-button-danger"
                                [disabled]="dailyCheck == null || dailyCheck.check_out != null"
                                style="width: 150px; height: 80px;"><i class="pi pi-sign-out"></i></button>
                            <h6>Remplissage CRA <strong
                                    *ngIf="!isNaN(craPercent) && !isInfinity(craPercent)">{{craPercent|
                                    number:'1.0-2'}}%</strong> <strong
                                    *ngIf="isNaN(craPercent) || isInfinity(craPercent)">0%</strong></h6>
                        </div>
                        <div class="col-12" *ngIf="dailyCheck">
                            <p-table [value]="[dailyCheck]" dataKey="_id" [rows]="1"
                                [rowHover]="true" styleClass="p-datatable-gridlines" responsiveLayout="scroll">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th></th>
                                        <th>Checkin IMS</th>
                                        <th>Checkin Pointeuse</th>
                                        <th>Pause</th>
                                        <th>Checkout IMS</th>
                                        <th>Checkout Pointeuse</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-cra let-expandedt="expandedt" let-rit="rowIndex">
                                    <tr
                                        (click)="historiqueCraSelected = [dailyCheck]; showDailySelectedCra = true">
                                        <td>
                                            <button type="button" pButton pRipple [pRowToggler]="cra"
                                                class="p-button-text p-button-rounded p-button-plain"
                                                [icon]="expandedt ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                                            </button>
                                        </td>
                                        <td>{{cra.check_in | date:'H:mm'}}</td>
                                        <td>WIP</td>
                                        <td *ngIf="pauseTiming">

                                            {{ pauseTiming }}mn
                                        </td>
                                        <td *ngIf="!pauseTiming">
                                            0mn
                                        </td>
                                        <td>{{cra.check_out | date:'H:mm'}} <span *ngIf="cra.auto">AUTOMATIQUE</span>
                                        </td>
                                        <td>WIP</td>


                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="8">Vous n'avez aucun pointage enregistré pour le moment.</td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="loadingbody">
                                    <tr>
                                        <td colspan="8">Chargement de votre historique, merci de patienter...</td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="rowexpansion" let-cra>

                                    <tr>
                                        <td colspan="9">
                                            <p-table class="col-12" styleClass="p-datatable-gridlines">
                                                <ng-template pTemplate="header">
                                    <tr>
                                        <th> Pauses </th>
                                        <th>Motif</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td *ngIf="cra.pause && cra.pause.length!=0">
                                            <ul>
                                                <li *ngFor="let pause of cra.pause; let i = index">
                                                    de {{ pause?.in | date:'H:mm' }} à {{ pause?.out | date:'H:mm' }}
                                                </li>
                                            </ul>
                                            <br> &nbsp;&nbsp;&nbsp; {{ pauseTiming }}mn
                                        </td>
                                        <td colspan="2" *ngIf="!cra.pause || cra.pause.length==0">
                                            0mn
                                        </td>

                                        <td *ngIf="cra.pause && cra.pause.length!=0">
                                            <ul>
                                                <li *ngFor="let pause of cra.pause; let i = index">
                                                    -{{ pause?.motif }}
                                                </li>
                                            </ul>
                                            <br> &nbsp;&nbsp;&nbsp;
                                        </td>


                                    </tr>

                                </ng-template>
                            </p-table>
                            </td>
                            </tr>
                            <tr>


                                </ng-template>



                                </p-table>

                        </div>
                        <div class="col-12 ">
                            <a *ngIf="!visible" (click)="visible=true;getHistoPointage()" style="width: 100px; height: 50px;">Voir l'historique -></a>
                            <div class="col-12" *ngIf="visible">
                                <!-- affichage du CRA d'un historique de pointage -->
                                <h5 class="mt-5">Historique :</h5>
                                <div class="m-2">
                                    <label htmlFor="">Choisissez un mois et une année &nbsp;&nbsp;&nbsp;</label>
                                    <input pInputText type="month" (input)="getHistoPointage($event.target.value)">
                                </div>
                                <p-table [value]="historiqueCraHisto" dataKey="_id" [rows]="4" [rowHover]="true"
                                    styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th></th>
                                            <th>Date</th>
                                            <th>Checkin IMS</th>
                                            <th>Checkin Pointeuse</th>
                                            <th>Pauses</th>
                                            <th>Checkout IMS</th>
                                            <th>Checkout Pointeuse</th>

                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-cra let-expanded="expanded" let-ri="rowIndex">
                                        <tr (click)="historiqueCraSelected = cra; showDailySelectedCra1 = true">
                                            <td
                                                [ngClass]="{'valid-begin':cra?.validated,'non-valid-begin':!cra?.validated}">
                                                <button type="button" pButton pRipple [pRowToggler]="cra"
                                                    class="p-button-text p-button-rounded p-button-plain"
                                                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                                                </button>
                                            </td>
                                            <td
                                                [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}">
                                                {{dateParseur(cra?.today)}}</td>
                                            <td
                                                [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}">
                                                {{cra.check_in | date:'H:mm'}}</td>
                                            <td
                                                [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}">
                                                WIP</td>
                                            <td [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}"
                                                *ngIf="cra.pause_timing>0">

                                                &nbsp;&nbsp;&nbsp; {{ cra.pause_timing }}mn
                                            </td>
                                            <td [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}"
                                                *ngIf="!cra.pause_timing>0  ">
                                                0 mn
                                            </td>
                                            <td
                                                [ngClass]="{'valid-middle':cra?.validated,'non-valid-middle':!cra?.validated}">
                                                {{cra.check_out | date:'H:mm'}} <span
                                                    *ngIf="cra.auto">AUTOMATIQUE</span></td>
                                            <td
                                                [ngClass]="{'valid-end':cra?.validated,'non-valid-end':!cra?.validated}">
                                                WIP</td>

                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td colspan="8">Vous n'avez aucun pointage enregistré pour le moment.</td>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="loadingbody">
                                        <tr>
                                            <td colspan="8">Chargement de votre historique, merci de patienter...</td>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="rowexpansion" let-cra>

                                        <tr>
                                            <td colspan="3">
                                                <p-table class="col-12" styleClass="p-datatable-gridlines">
                                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th> Pauses </th>
                                            <th>Motif</th>

                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td *ngIf="cra.pause && cra.pause.length!=0">
                                                <ul>
                                                    <li *ngFor="let pause of cra.pause; let i = index">
                                                        de {{ pause?.in | date:'H:mm' }} à {{ pause?.out | date:'H:mm'
                                                        }}
                                                    </li>
                                                </ul>
                                                <br> &nbsp;&nbsp;&nbsp; {{ pauseTiming }}mn
                                            </td>
                                            <td colspan="2" *ngIf="!cra.pause || cra.pause.length==0">
                                                0mn
                                            </td>

                                            <td *ngIf="cra.pause && cra.pause.length!=0">
                                                <ul>
                                                    <li *ngFor="let pause of cra.pause; let i = index">
                                                        -{{ pause?.motif }}
                                                    </li>
                                                </ul>
                                                <br> &nbsp;&nbsp;&nbsp;
                                            </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                                </td>
                                </tr>
                                <tr>
                                    </ng-template>
                                    </p-table>
                            </div>
                        </div>
                    </div>
                </p-tabPanel>
                <p-tabPanel header="CRA">


                    <div *ngIf="showFormAddCraTicket">
                        <div class="add-button-div mb-2">
                            <i class="pi pi-times-circle" pTooltip="Fermer" (click)="showFormAddCraTicket = false;"
                                style="color: red; font-size: 20px; float: right; cursor: pointer;"></i>
                        </div>
                        <div style="clear: both;"></div>

                        <form class="p-fluid" [formGroup]="formAddCraTicket" (ngSubmit)="onAddCraTicket()">


                            <div class="p-formgrid grid">
                                <div class="field col-12 md:col-5">

                                    <p-dropdown formControlName="ticket" [options]="ticketListe" filter="true"
                                        placeholder="Choisissez un ticket" [showClear]="true"
                                        (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                                </div>
                                <div class="field col-12 md:col-5">
                                    <input pInputText type="number" id="duration" formControlName="duration"
                                        placeholder="Durée en minute">
                                </div>

                            </div>

                            <div class="col-2">
                                <button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2"
                                    [disabled]="formAddCraTicket.invalid"></button>
                            </div>
                        </form>
                    </div>
                    <div *ngIf="dailyCheck">
                        <form class="p-fluid grid" [formGroup]="formAddCra" (ngSubmit)="onAddCra()">
                            <div class="field col-12 md:col-5">
                                <p-dropdown [options]="ticketListe" placeholder="Veuillez décrire l'activité"
                                    [editable]="true" formControlName="task"></p-dropdown>
                                <!--<input pInputText type="text" id="tache" formControlName="task"
                                    placeholder="Veuillez décrire l'activité">-->
                            </div>
                            <div class="field col-8 md:col-4" *ngIf="formAddCra.value.mode_type=='/H'">
                                <input pInputText type="number" id="duration" formControlName="number_minutes"
                                    placeholder="Durée en heures">
                            </div>
                            <div class="field col-8 md:col-4" *ngIf="formAddCra.value.mode_type!='/H'">
                                <input pInputText type="number" id="duration" formControlName="number_minutes"
                                    placeholder="Durée en minutes" step="15">
                            </div>
                            <div class="field col-4 md:col-2">
                                <p-dropdown [options]="modeType" formControlName="mode_type"
                                    placeholder="Choisissez une mesure"></p-dropdown>
                            </div>
                            <div class="col-12 md:col-1">
                                <button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2 "
                                    [disabled]="formAddCra.invalid"></button>
                            </div>
                        </form>
                    </div>
                    <!--<p-splitButton label="Ajouter" [model]="itemsCra" style="float: right;"
                        *ngIf="dailyCheck != null && !showFormAddCra"
                        styleClass="p-button-outlined p-button-secondary mr-2 mb-2"></p-splitButton>-->

                    <div style="clear: both;"></div>

                    <p-table [value]="dailyCheck?.cra" [totalRecords]="dailyCheck?.cra" dataKey="_id" editMode="row"
                        [rows]="4" [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
                        responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th
                                    [ngClass]="{'valid-begin':dailyCheck?.validated,'non-valid-begin':!dailyCheck?.validated}">
                                    Activité</th>
                                <th
                                    [ngClass]="{'valid-middle':dailyCheck?.validated,'non-valid-middle':!dailyCheck?.validated}">
                                    Durée</th>
                                <th
                                    [ngClass]="{'valid-end':dailyCheck?.validated,'non-valid-end':!dailyCheck?.validated}">
                                    Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-cra let-editing="editing" let-ri="rowIndex">
                            <tr [pEditableRow]="cra">
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="text" [(ngModel)]="cra.task">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.task}}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="number" [(ngModel)]="cra.number_minutes">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.number_minutes}} mn
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                                        icon="pi pi-pencil" (click)="onRowEditInit(cra)"
                                        class="p-button-rounded p-button-text"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow
                                        icon="pi pi-check" (click)="onRowEditSave(cra)"
                                        class="p-button-rounded p-button-text p-button-success mr-2"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow
                                        icon="pi pi-times" (click)="onRowEditCancel(cra, ri)"
                                        class="p-button-rounded p-button-text p-button-danger"></button>
                                    <button pButton pRipple type="button" icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="onDeleteCra(cra._id)"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="summary">
                            <div class="flex align-items-center justify-content-between">
                                <div>

                                    <p *ngIf="!isNaN(craPercent) && !isInfinity(craPercent)" style="font-weight:400px">
                                        <strong>Taux de CRA &nbsp;</strong>{{craPercent|number:'1.0-2'}}%
                                    </p>
                                    <p *ngIf="isNaN(craPercent) || isInfinity(craPercent)" style="font-weight:400px">
                                        <strong>Taux de CRA &nbsp;</strong>0%
                                    </p>
                                </div>
                                <div>

                                    <p style="font-weight:400px"><strong>Durée
                                            totale &nbsp;</strong>{{totalCalc(dailyCheck?.cra)}}</p>

                                </div>

                            </div>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3">Aucun CRA pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="3">Chargement des CRA, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                    <br><br>
                    <a style="width: 100px; height: 50px;" (click)="showHistorique()">Voir l'historique -></a>
                    <div class="col-12" *ngIf="visible">

                        <div class="m-2">
                            <label htmlFor="">Choisissez un mois et une année &nbsp;&nbsp;&nbsp;</label>
                            <input pInputText type="month" [(ngModel)]=dateFilterHistorique
                                (input)="getHistoPointage($event.target.value)">
                        </div>
                        <p-table [value]="historiqueCraHisto" dataKey="_id" [rows]="4" [rowHover]="true"
                            styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Date</th>
                                    <th>Taux CRA</th>

                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-cra>
                                <tr (click)="historiqueCraSelected = cra; showDailySelectedCra = true">
                                    <td>{{dateParseur(cra?.today)}}</td>

                                    <td *ngIf="cra.taux_cra && !isNaN(cra.taux_cra)">{{ cra.taux_cra | number:'1.0-2'
                                        }}%</td>
                                    <td *ngIf="!cra.taux_cra || isNaN(cra.taux_cra)">0%</td>

                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="8">Vous n'avez aucun pointage enregistré pour le moment.</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="loadingbody">
                                <tr>
                                    <td colspan="8">Chargement de votre historique, merci de patienter...</td>
                                </tr>
                            </ng-template>
                        </p-table>
                        <!-- affichage de l'activité -->

                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            *ngIf="showDailySelectedCra" (click)="showDailySelectedCra = false"></i>
                        <div style="clear: both;"></div>
                        <p-table *ngIf="showDailySelectedCra" [value]="historiqueCraSelected.cra" dataKey="_id"
                            [rows]="4" [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
                            responsiveLayout="scroll">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th colspan="2" style="text-align: center;">Cra du
                                        {{dateParseur(historiqueCraSelected?.today)}}</th>
                                </tr>
                                <tr>
                                    <th>Durée</th>
                                    <th>Activité</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-cra>
                                <tr>
                                    <td>{{cra.number_minutes}}mn</td>
                                    <td>{{cra.task}}</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="2">Vous n'avez aucun CRA enregistré pour le jour sélectionné.</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="loadingbody">
                                <tr>
                                    <td colspan="2">Chargement de votre CRA, merci de patienter...</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </p-tabPanel>
                <p-tabPanel header="Calendrier">
                    <div class="col-12 grid">
                        <div class="col-12 grid">
                            <div class="col-6">
                                <label>Absence Non Justifiée</label><br>
                                <p-checkbox class="absence" [(ngModel)]="filter_value" value="Absence Non Justifié"
                                    (onChange)="onFilter()"></p-checkbox>
                            </div>
                            <div class="col-6">
                                <label>Autorisation</label><br>
                                <p-checkbox class="autorisation" [(ngModel)]="filter_value" value="Autorisation"
                                    (onChange)="onFilter()"></p-checkbox>
                            </div>
                            <div class="col-6">
                                <label>Activité</label><br>
                                <p-checkbox class="activite" [(ngModel)]="filter_value" value="Présent"
                                    (onChange)="onFilter()"></p-checkbox>
                            </div>
                            <div class="col-6">
                                <label>Cours</label><br>
                                <p-checkbox class="cours" [(ngModel)]="filter_value" value="Cours"
                                    (onChange)="onFilter()"></p-checkbox>
                            </div>
                        </div>
                    </div>
                    <p-fullCalendar #calendar [events]="eventUsers" [options]="optionsUsers">
                    </p-fullCalendar>
                    <p-dialog *ngIf="dateCRA" [(visible)]="displayCRA" header="CRA du {{dateCRA| date:'dd MMMM yy'}}"
                        [style]="{width: '55vw'}" [modal]="true">
                        <p-table #dtAbs dataKey="_id" styleClass="p-datatable-gridlines" [value]="DataCRA">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Site</th>
                                    <th>Checkin</th>
                                    <th>Pause</th>
                                    <th>Checkout</th>
                                    <th style="width: 8rem">
                                        Taux CRA
                                    </th>
                                    <!--<th style="width: 8rem">
                                        Statut
                                    </th>-->
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-check>
                                <tr>
                                    <td>
                                        {{collaborateurDic[check?.user_id._id]?.localisation}}
                                    </td>
                                    <td style="min-width: 14rem;">
                                        <strong>IMS: </strong>{{check?.check_in | date: 'H:mm'}}<br>
                                        <strong>Pointage: </strong>{{getCheckIn(check?.user_id?._id) | date:'H:mm'}}
                                    </td>
                                    <td style="min-width: 10rem;padding: 0%;">
                                        <app-pause-read-more [pausemin]="check?.pause_timing"
                                            [pauseList]="check?.pause"></app-pause-read-more>
                                    </td>
                                    <td style="min-width: 10rem;">
                                        <strong>IMS: </strong>{{check?.check_out | date: 'H:mm'}}<br>
                                        <strong>Pointage: </strong>{{getCheckOut(check?.user_id?._id) | date:'H:mm'}}
                                    </td>

                                    <td *ngIf="check?.taux_cra" style="min-width: 12rem;"
                                        [ngClass]="{'cra-none':check?.taux_cra<1,'cra-perfect':check?.taux_cra>99,'cra-middle':(check?.taux_cra>=1 && check?.taux_cra<=99)}">
                                        {{check?.taux_cra | number:'1.0-2'}}% <i *ngIf="check?.validated"
                                            class="pi pi-check" tooltipPosition="bottom" pTooltip="CRA Validé"></i> <i
                                            *ngIf="!check?.validated" class="pi pi-times" tooltipPosition="bottom"
                                            pTooltip="CRA Non validé"></i>
                                    </td>
                                    <td *ngIf="!check?.taux_cra" style="min-width: 12rem;" class="cra-none">
                                        0% <i *ngIf="check?.validated" class="pi pi-check" tooltipPosition="bottom"
                                            pTooltip="CRA Validé"></i> <i *ngIf="!check?.validated" class="pi pi-times"
                                            tooltipPosition="bottom" pTooltip="CRA Non validé"></i>
                                    </td>

                                    <!--<td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Disponible'">
                                        <p-tag value="Disponible" severity="success" icon="pi pi-check"></p-tag>
                                    </td>
                                    <td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En congé'">
                                        <p-tag value="En congé" icon="pi pi-home" severity="info"></p-tag>
                                    </td>
                                    <td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En réunion'">
                                        <p-tag value="En réunion" severity="warning" icon="pi pi-phone"></p-tag>
                                    </td>
                                    <td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Occupé'">
                                        <p-tag value="Occupé" severity="danger" icon="pi pi-pencil"></p-tag>
                                    </td>
                                    <td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'Absent'">
                                        <p-tag value="Absent" icon="pi pi-times" severity="danger"></p-tag>
                                    </td>
                                    <td style="min-width: 12rem;" *ngIf="check.user_id?.statut == 'En pause'">
                                        <p-tag value="En pause" severity="warning" icon="pi pi-moon"></p-tag>
                                    </td>-->
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="6">Aucun tache de cra trouvé.</td>
                                </tr>
                            </ng-template>
                        </p-table>
                        <br>
                        <p>&nbsp;</p>
                        <p-table *ngIf="DataCRA.length!=0" [value]="DataCRA[0].cra" dataKey="_id" [rowHover]="true"
                            styleClass="p-datatable-gridlines" responsiveLayout="scroll">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Durée</th>
                                    <th>Activité</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-cra>
                                <tr>
                                    <td>{{cra.number_minutes}}mn</td>
                                    <td>{{cra.task}}</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="2">Vous n'avez aucun CRA enregistré pour le jour sélectionné.</td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="loadingbody">
                                <tr>
                                    <td colspan="2">Chargement de votre CRA, merci de patienter...</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </p-dialog>
                </p-tabPanel>


                <p-tabPanel header="Congé" id="departAnticipe">
                    <!-- formulaire de modification d'une demande de congé -->
                    <div *ngIf="showUpdateCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showUpdateCongeForm = false; showOtherTextArea = false"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Modifier une demande de congé</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formUpdateConge"
                            (ngSubmit)="onUpdateConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="type du congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>
                            <div class="field col-12">
                                <label>Urgent</label><br>
                                <p-checkbox formControlName="urgent" [binary]="true"></p-checkbox>
                            </div>
                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formUpdateConge.invalid"></button>
                        </form>
                    </div>

                    <!-- formulaire de demande de congé -->
                    <div *ngIf="showAddCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showAddCongeForm = false; showOtherTextArea = false;"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Nouvelle demande</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formAddConge" (ngSubmit)="onAskConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="Choisissez un type de congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true" (onInput)="onCalcNumberDay()"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>
                            <div class="field col-6">
                                <input type="file" pInputText (change)="onSelectFile($event)" accept="application/pdf">
                            </div>
                            <div class="field col-6">
                                <label>Urgent</label><br>
                                <p-checkbox formControlName="urgent" [binary]="true"></p-checkbox>
                            </div>

                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formAddConge.invalid"></button>
                        </form>
                    </div>

                    <button pButton pRipple label="Nouvelle demande" style="float: right;"
                        class="p-button-outlined mb-2" (click)="showAddCongeForm = true"></button>
                    <div style="clear: both"></div>
                    <p-table [value]="conges" [expandedRowKeys]="expandedRows" dataKey="_id" [rows]="4"
                        [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
                        responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Date de la demande</th>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Nombre de jours</th>
                                <th>Justificatif</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-conge let-expanded="expanded">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="conge"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <td>{{conge._id.substring(conge._id.length-6, conge._id.length)}}</td>
                                <td>{{conge.date_demande | date: 'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.type_conge == 'Autre motif'">{{ conge.other_motif}}</td>
                                <td *ngIf="conge.type_conge != 'Autre motif'">{{ conge.type_conge}}</td>

                                <td>du {{conge.date_debut | date: 'd/MM/YYYY'}} <br> au {{conge.date_fin | date:
                                    'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.nombre_jours > 1">{{conge.nombre_jours}} jours</td>
                                <td *ngIf="conge.nombre_jours <= 1">{{conge.nombre_jours}} jour</td>

                                <td *ngIf="conge.justificatif == null">--</td>
                                <td *ngIf="conge.justificatif != null">
                                    <i class="pi pi-file" pTooltip="Télécharger le justificatif"
                                        (click)="onDonwloadJustificatif(conge._id)"
                                        style="cursor: pointer; font-size: 20px; color: rgba(0, 0, 0, 0.622)"></i>
                                </td>

                                <td>
                                    <span *ngIf="conge.statut == 'En attente'"><p-tag icon="pi pi-spin pi-spinner"
                                            severity="warning" value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Refusé'"><p-tag icon="pi pi-times" severity="danger"
                                            value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Validé'"><p-tag icon="pi pi-check" severity="success"
                                            value={{conge.statut}}></p-tag></span>
                                </td>
                                <td>
                                    <button pButton pRipple icon="pi pi-pencil" pTooltip="Mettre à jour la demande"
                                        *ngIf="conge.statut != 'Validé'" (click)="onPachCongeData(conge)"
                                        class="p-button-primary p-button-rounded p-button-outlined mb-2"></button>
                                    <button pButton pRipple pTooltip="Supprimer la demande" icon="pi pi-trash"
                                        *ngIf="conge.statut != 'Validé'" (click)="onDeleteConge(conge._id)"
                                        class="p-button-danger p-button-rounded p-button-outlined ml-2 mb-2"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-conge>
                            <tr>
                                <td colspan="9">
                                    <div class="p-3">
                                        <p-table responsiveLayout="scroll">
                                            <ng-template pTemplate="header">
                            <tr>
                                <th>Motif</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td>{{conge.motif}}</td>
                            </tr>
                        </ng-template>
                    </p-table>
        </div>

        <div class="p-3">
            <p-table responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Note decideur</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{conge.note_decideur}}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        </td>
        </tr>
        </ng-template>
        </p-table>
        </p-tabPanel>
        </p-tabView>
    </div>

</div>

<p-dialog header="Motif de la pause" [(visible)]="displayMotif" [style]="{width: '50vw'}" [modal]="true">
    <div style="width: 100%;" style="text-align: center;">
        <p-dropdown autoWidth="false" [style]="{'width':'30%'}" *ngIf="motifStr=='Déjeuner'" [options]="motifDropdown"
            appendTo="body" [(ngModel)]="motifStr"></p-dropdown>
        <textarea *ngIf="motifStr!='Déjeuner'" [style]="{'width':'30%'}" pInputTextarea
            [(ngModel)]="motifStr"></textarea>
    </div>
    <ng-template pTemplate="footer">
        <p-button icon="pi pi-check" (click)="displayMotif=false;onPause()" label="Ok"
            styleClass="p-button-text"></p-button>
    </ng-template>
</p-dialog>

<p-dialog header="Valider CRA" [(visible)]="displayCRACheck" [modal]="true" showEffect="fade" [style]="{width: '50vw'}"
    [breakpoints]="{'960px': '75vw'}">
    <div [style]="{'width':'100%'}" *ngIf="dataCHECK">
        <p-toggleButton autoWidth="false" [style]="{'width':'100%'}" onLabel="Validé" offLabel="Non validé"
            offIcon="pi pi-times" [(ngModel)]="dataCHECK.validated" (onChange)="saveCheck(dataCHECK)">
            <!-- ERREUR VSCode Qui n'en est pas une -->
        </p-toggleButton>
        <p>&nbsp;</p>
        <p-table [value]="dataCHECK?.cra" dataKey="_id" styleClass="p-datatable-gridlines" responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th>Tâche</th>
                    <th>Durée</th>

                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-cra let-editing="editing" let-ri="rowIndex">
                <tr [pEditableRow]="cra">
                    <td>
                        {{cra?.task}}
                    </td>
                    <td>
                        {{cra?.number_minutes}} mn
                    </td>

                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="3">Aucun CRA pour le moment.</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="loadingbody">
                <tr>
                    <td colspan="3">Chargement des CRA, merci de patienter...</td>
                </tr>
            </ng-template>
        </p-table>
        <p>&nbsp;</p>
        <h3 style="text-align: center;width: 100%;">Durée totale : {{totalCalc(dataCHECK?.cra)}}</h3>
    </div>

</p-dialog>

<p-dialog header="Définir un jour de cours" [(visible)]="displayCours" [modal]="true" showEffect="fade"
    [style]="{width: '50vw'}">
    <p>Voulez-vous déclarez {{DataDay?.day | date: 'dd MM YYYY'}} comme un jour de cours ?</p>
    <button pButton label="Déclarez comme un jour de cours" (click)="onAddJourDeCours()"></button>
</p-dialog>

<p-dialog class="grid" header="Cours du {{dataEvent?.date | date: 'dd MM YYYY'}}" [(visible)]="displayData"
    [modal]="true" [style]="{width: '75vw'}">
    <div class="col-12 grid">
        <div class="col-12" *ngIf="dataEvent?._id">
            <p-button icon="pi pi-trash" [style]="{'width':'100%'}" label="Supprimer le cours"
                styleClass="p-button-danger" (click)="onDelete()"></p-button>
        </div>
    </div>
</p-dialog>