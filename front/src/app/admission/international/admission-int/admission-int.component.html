<p-toast></p-toast>
<div class="grid">
    <!-- partie Modification des informations du prospect -->
    <div class="col-12 card" *ngIf="showDetails">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showDetails = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showDetails?.user_id" class="text-center" style="font-weight: bold;"> Détails de : {{
            showDetails?.user_id?.firstname }} {{
            showDetails?.user_id?.lastname | uppercase }}
        </h3>

        <p-tabView class="col-12">
            <p-tabPanel header="Informations Personnelles">
                <form class="grid" [formGroup]="detailsForm">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field col-12">
                            <label For="Civilite">Civilité</label>
                            <p-dropdown [options]="civiliteList" formControlName="civilite"></p-dropdown>
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="lastname">Nom</label>
                            <input pInputText id="lastname" formControlName="lastname" type="text" placeholder="Nom" />
                        </div>
                        <div class="field col-12 md:col-6">
                            <label For="firstname">Prénom</label>
                            <input pInputText id="firstname" formControlName="firstname" type="text"
                                placeholder="Prénom" />
                        </div>
                        <div class="field col-12 md:col-4">
                            <label For="indicatif">Indicatif</label>
                            <input pInputText id="indicatif" formControlName="indicatif" type="text"
                                placeholder="0033" />
                        </div>
                        <div class="field col-12 md:col-8">
                            <label For="phone">Téléphone</label>
                            <input pInputText id="phone" formControlName="phone" type="tel" placeholder="0767987887" />
                        </div>
                        <div class="field col-12">
                            <label For="email_perso">Adresse Email</label>
                            <input pInputText id="phone" formControlName="email_perso" type="email"
                                placeholder="s.hue@gmail.com" />
                        </div>
                        <div class="field col-12 md:col-7">
                            <label For="pays">Pays de résidence</label>
                            <p-dropdown [options]="paysList" formControlName="pays_adresse" optionValue="value"
                                optionLabel="value"></p-dropdown>
                        </div>
                        <!--<div class="field col-12 md:col-5">
                            <label For="ville">Ville</label>
                            <input pInputText id="ville" formControlName="ville_adresse" type="text"
                                placeholder="Paris" />
                        </div>
                        <div class="field col-12 md:col-4">
                            <label For="numero_adresse">Numéro de rue</label>
                            <input pInputText id="numero_adresse" formControlName="numero_adresse" type="number"
                                placeholder="15" />
                        </div>
                        <div class="field col-12 md:col-8">
                            <label For="rue_adresse">Rue</label>
                            <input pInputText id="rue_adresse" formControlName="rue_adresse" type="text"
                                placeholder="rue du louvre" />
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="postal_adresse">Code postale</label>
                            <input pInputText id="postal_adresse" formControlName="postal_adresse" type="number"
                                placeholder="94200" />
                        </div>-->
                        <div class="field md:col-6 col-12">
                            <label For="postal_adresse">Date d'inscription</label>
                            <p>{{showDetails?.date_creation|date:'mediumDate'}}</p>
                        </div>
                    </div>
                </form>
            </p-tabPanel>
            <p-tabPanel header="Programme d'étude">
                <form class="grid" [formGroup]="detailsForm">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field md:col-6 col-12">
                            <label For="formation">Formation</label>
                            <p-dropdown [options]="dropdownFormation" placeholder="Choisissez une formation"
                                formControlName="formation"></p-dropdown>
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="campus_choix_1">Campus 1er choix</label>
                            <p-dropdown [options]="dropdownCampus" placeholder="Choisissez un campus"
                                formControlName="campus_choix_1"></p-dropdown>

                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="campus_choix_2">Campus 2ème choix</label>
                            <p-dropdown [options]="dropdownCampus" placeholder="Choisissez un campus"
                                formControlName="campus_choix_2"></p-dropdown>
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="campus_choix_3">Campus 3ème choix</label>
                            <p-dropdown [options]="dropdownCampus" placeholder="Choisissez un campus"
                                formControlName="campus_choix_3"></p-dropdown>
                            <!--<input pInputText formControlName="campus_choix_3" />-->

                        </div>
                        <div class="field col-12">
                            <label For="formation">Ecole</label>
                            <p-dropdown [options]="dropdownEcole" placeholder="Choisissez une école"
                                formControlName="type_form"></p-dropdown>
                        </div>
                    </div>
                </form>
            </p-tabPanel>
            <p-tabPanel header="Dossier d'admission">
                <form class="grid" [formGroup]="detailsForm">
                    <ul>
                        <li *ngFor="let file of ListDocuments; index as i">
                            <div class="grid">

                                <div class="field col-10 " style="border-style: 2;border: 2em;border-bottom: red;">
                                    <i class="pi pi-file-pdf " style="font-size: 20px;cursor: pointer;"
                                        pTooltip="Visualiser dans un nouvel onglet"
                                        (click)="VisualiserFichier(showDetails._id,i)"></i>
                                    <em (click)="VisualiserFichier(showDetails._id,i)" [id]="i" style="cursor: pointer;"
                                        pTooltip=" Visualiser dans un nouvel onglet">
                                        {{ ListPiped[i] }}
                                    </em>
                                </div>
                                <div class="field col-1">
                                    <i class="pi pi-download" pTooltip="Télécharger le fichier"
                                        style=" float:right;cursor: pointer;font-size: 15px;color: rgb(3, 54, 237);"
                                        (click)="downloadFile(showDetails._id,i)"></i>
                                </div>
                                <div class="field col-1">
                                    <i class="pi pi-times"
                                        style=" float:left;font-size: 15px;cursor:pointer;color: red;"
                                        pTooltip="Supprimer le fichier du dossier"
                                        (click)="deleteFile(showDetails._id,i)" aria-hidden="true"> </i>
                                </div>

                            </div>
                        </li>
                    </ul>
                    <p *ngIf="ListDocuments==null || ListDocuments.length==0">
                        Aucun document n'a été chargé !
                    </p>
                    <div class="col-12">
                        <button pButton label="Ajouter un document"
                            (click)="showUploadFile=showDetails;scrollToTop()"></button>
                    </div>
                </form>
            </p-tabPanel>
            <p-tabPanel header="Paiements">
                <div class="grid">
                    <p-table #dt2 dataKey="ID" [value]="payementList" class="col-12" styleClass="p-datatable-gridlines">
                        <ng-template pTemplate="header">
                            <tr>
                                <th pSortableColumn="ID" style="text-align: center;"> ID <p-sortIcon field="ID">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="type" style="text-align: center;"> Type de Paiement <p-sortIcon
                                        field="type">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="montant" style="text-align: center;"> Montant <p-sortIcon
                                        field="montant"></p-sortIcon>
                                </th>
                                <th pSortableColumn="date" style="text-align: center;"> Date du réglement <p-sortIcon
                                        field="date"></p-sortIcon>
                                </th>

                                <th>
                                    <div class="flex justify-content-between align-items-center">
                                        Action
                                    </div>
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-paiement let-ri="rowIndex">
                            <tr [pEditableRow]="paiement">
                                <td>
                                    {{paiement?.ID}}
                                </td>
                                <td pEditableColumn>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <p-dropdown [options]="typePaiement" [(ngModel)]="paiement.type"
                                                placeholder="Choisissez la méthode de paiement"
                                                (onChange)="changeMontant(ri,$event,'type')"></p-dropdown>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{paiement.type}}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td pEditableColumn>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input type="number" (change)="changeMontant(ri,$event,'montant')"
                                                [(value)]="paiement.montant" placeholder="20" value="0" pInputText>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{paiement.montant}}€
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td pEditableColumn>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input type="date" pInputText (change)="changeMontant(ri,$event,'date')"
                                                [(value)]="paiement.date">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{paiement.date | date:mediumDate}}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <i pTooltip="Supprimer le paiement" tooltipPosition="bottom" class="pi pi-trash"
                                        aria-hidden="true" (click)="deletePayement(ri)"> </i>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div class="col-12">
                        <button type="button" (click)="onAddPayement()" pButton label="Ajouter un paiement"></button>
                    </div>
                </div>
            </p-tabPanel>
            <p-tabPanel header="Orientation et Admission">
                <form class="grid" [formGroup]="detailsForm">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field md:col-6 col-12">
                            <label For="formation">Décision orientation</label>
                            <p-multiSelect [options]="orientationList"
                                formControlName="decision_orientation"></p-multiSelect>
                            <!--<p-dropdown [options]="civiliteList" formControlName="formation"></p-dropdown>-->
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="formation">Décision admission</label>
                            <p-dropdown [options]="admissionList" formControlName="decision_admission"></p-dropdown>
                            <!--<p-dropdown [options]="civiliteList" formControlName="formation"></p-dropdown>-->
                        </div>
                    </div>
                </form>
            </p-tabPanel>
            <p-tabPanel header="Avancement consulaire">
                <form class="grid" [formGroup]="detailsForm">
                    <div class="p-fluid p-formgrid grid">
                        <div class="field md:col-6 col-12">
                            <label For="formation">A besoin d'un visa ?</label>
                            <p-dropdown [options]="abesoinvisaList" formControlName="a_besoin_visa"></p-dropdown>
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="formation">Avancement Campus France</label>
                            <p-dropdown [options]="cflist" formControlName="validated_cf"></p-dropdown>
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="formation">Logement</label>
                            <p-dropdown [options]="logementList" formControlName="logement"></p-dropdown>
                        </div>
                        <div class="field md:col-6 col-12">
                            <label For="formation">Finance</label>
                            <input pInputText formControlName="finance" />
                        </div>
                        <div class="field col-12">
                            <label For="formation">Visa</label>
                            <p-dropdown [options]="visaList" formControlName="avancement_visa"></p-dropdown>
                        </div>
                    </div>
                </form>
            </p-tabPanel>
            <p-tabPanel header="Documents d'inscription">
                <div class="col-12 grid">
                    <div class="col-12">
                        <strong>Mes attestations disponibles:</strong>
                    </div>
                    <div class="col-12">
                        <p-table styleClass="p-datatable-gridlines" [value]="showDetails.documents_administrative"
                            responsiveLayout="scroll" responsiveLayout="scroll">
                            <ng-template pTemplate="header" let-columns>
                                <tr>
                                    <th>
                                        Date de délivrance
                                    </th>
                                    <th>
                                        Nom du document
                                    </th>
                                    <th>
                                        Traité par
                                    </th>
                                    <th>
                                        Lien de téléchargement
                                    </th>
                                    <th>
                                        Note
                                    </th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-rowData>
                                <tr>
                                    <td>
                                        {{rowData.date | date:'mediumDate'}}
                                    </td>
                                    <td>
                                        {{rowData.nom}}
                                    </td>
                                    <td>
                                        {{rowData.traited_by}}
                                    </td>
                                    <td>
                                        <a (click)="downloadAdminFile(rowData.path)">Télécharger</a>
                                    </td>
                                    <td>
                                        {{rowData.note}}
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </div>
                <p *ngIf="showDetails.documents_administrative==null || showDetails.documents_administrative.length==0">
                    Aucun document n'a été chargé !
                </p>
            </p-tabPanel>
        </p-tabView>
        <div class="col-12 grid">
            <div class="col-12">
                <button pButton label="Sauvegardez les modifications" (click)="saveDetails()"></button>
            </div>
            <!--<div class="col-4">
                    <button pButton label="Ajouter un document" (click)="showUploadFile=showDetails;scrollToTop()"></button>
                </div>-->
            <!--<div class="col-6">
                <button pButton pButton class="p-button-danger" label="Sauvegardez les modifications et fermer"
                    (click)="saveDetails(true)"></button>
            </div>-->
        </div>
    </div>


    <div class="col-12 card" *ngIf="showPaiement">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showPaiement = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showPaiement?.user_id" class="text-center" style="font-weight: bold;"> Paiement de : {{
            showPaiement?.user_id?.firstname }} {{
            showPaiement?.user_id?.lastname | uppercase }}
        </h3>
        <div class="grid">
            <p-table #dt2 dataKey="ID" [value]="payementList" class="col-12" styleClass="p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="ID" style="text-align: center;"> ID <p-sortIcon field="ID">
                            </p-sortIcon>
                        </th>
                        <th pSortableColumn="type" style="text-align: center;"> Type de Paiement <p-sortIcon
                                field="type">
                            </p-sortIcon>
                        </th>
                        <th pSortableColumn="montant" style="text-align: center;"> Montant <p-sortIcon
                                field="montant"></p-sortIcon>
                        </th>
                        <th pSortableColumn="date" style="text-align: center;"> Date du réglement <p-sortIcon
                                field="date"></p-sortIcon>
                        </th>

                        <th>
                            <div class="flex justify-content-between align-items-center">
                                Action
                            </div>
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-paiement let-ri="rowIndex">
                    <tr [pEditableRow]="paiement">
                        <td>
                            {{paiement?.ID}}
                        </td>
                        <td pEditableColumn>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <p-dropdown [options]="typePaiement" [(ngModel)]="paiement.type"
                                        placeholder="Choisissez la méthode de paiement"
                                        (onChange)="changeMontant(ri,$event,'type')"></p-dropdown>
                                </ng-template>
                                <ng-template pTemplate="output">
                                    {{paiement.type}}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td pEditableColumn>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input type="number" (change)="changeMontant(ri,$event,'montant')"
                                        [(value)]="paiement.montant" placeholder="20" value="0" pInputText>
                                </ng-template>
                                <ng-template pTemplate="output">
                                    {{paiement.montant}}€
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td pEditableColumn>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input type="date" pInputText (change)="changeMontant(ri,$event,'date')"
                                        [(value)]="paiement.date">
                                </ng-template>
                                <ng-template pTemplate="output">
                                    {{paiement.date | date:mediumDate}}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td>
                            <i pTooltip="Supprimer le paiement" tooltipPosition="bottom" class="pi pi-trash"
                                aria-hidden="true" (click)="deletePayement(ri)"> </i>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            <div class="col-4">
                <button type="button" (click)="onAddPayement()" pButton label="Ajouter un paiement"></button>
            </div>

            <div class="col-4">
            </div>
            <div class="col-4">
                <button pButton label="Sauvegardez les modifications" (click)="savePaiement()"></button>
            </div>
            <!--<label>Montant Payé</label>
            <div class="col-12 grid" *ngFor="let data of payementList; let i = index">
                <div class="field col-12 md:col-3">
                    <label>Type de paiement:</label><br>
                    <p-dropdown [options]="typePaiement" [(ngModel)]="payementList[i]['type']"
                        placeholder="Choisissez la méthode de paiement"
                        (onChange)="changeMontant(i,$event,'type')"></p-dropdown>
                </div>
                <div class="field col-12 md:col-3">
                    <label>Montant:</label><br>
                    <input type="number" (change)="changeMontant(i,$event,'montant')"
                        [(value)]="payementList[i]['montant']" placeholder="20" value="0" pInputText>
                </div>
                <div class="field col-12 md:col-5">
                    <label>Date du paiement:</label><br>
                    <input type="date" pInputText (change)="changeMontant(i,$event,'date')"
                        [(value)]="payementList[i]['date']">
                </div>
                <div class="field col-12 md:col-1">
                    <label>&nbsp;</label><br>
                    <button type="button" pButton icon="pi pi-times" (click)="deletePayement(i)"
                        styleClass="p-button-danger"></button>
                </div>
            </div>
            <div class="col-6">
                <label>Reste à Payé</label>
                <p>En cours de développement</p>
            </div>


            <div class="col-4">
                <button type="button" (click)="onAddPayement()" pButton label="Ajouter un paiement"></button>
            </div>

            <div class="col-4">
            </div>
            <div class="col-4">
                <button pButton label="Sauvegardez les modifications" (click)="savePaiement()"></button>
            </div>-->
        </div>
    </div>
    <!-- partie ajout de document -->
    <div class="col-12" *ngIf="showUploadFile!=null && showDetails">
        <div class="card">
            <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;"
                (click)="showUploadFile = null" aria-hidden="true"> </i>
            <h3 *ngIf="showUploadFile.user_id" class="text-center" style="font-weight: bold;">Ajouter un document à : {{
                showUploadFile.user_id?.firstname }} {{
                showUploadFile.user_id?.lastname | uppercase }}
            </h3>

            <form class="p-fluid p-formgrid grid" [formGroup]="uploadFileForm">
                <div class="field col-12">
                    <label>Type de document</label>
                    <p-dropdown [options]="DocTypes" formControlName="typeDoc"></p-dropdown>
                </div>
                <div class="field col-12">
                    <p-fileUpload (uploadHandler)="FileUpload($event)" mode="basic" chooseLabel="Ajouter un Document"
                        customUpload="true" fileLimit="1" accept=".docx,.pdf,.doc,.jpg,.png,.jpeg"
                        maxFileSize="10000000" [auto]="true" #fileInput>
                    </p-fileUpload>
                </div>

            </form>
        </div>
    </div>
    <div class="col-12" *ngIf="showUploadFile!=null && showDocuments">
        <div class="card">
            <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;"
                (click)="showUploadFile = null" aria-hidden="true"> </i>
            <h3 *ngIf="showUploadFile.user_id" class="text-center" style="font-weight: bold;">Ajouter un document à : {{
                showUploadFile.user_id?.firstname }} {{
                showUploadFile.user_id?.lastname | uppercase }}
            </h3>

            <form class="p-fluid p-formgrid grid" [formGroup]="uploadAdminFileForm">
                <div class="field col-6">
                    <label>Date de délivrance</label>
                    <input type="date" formControlName="date" pInputText />
                </div>
                <div class="field col-6">
                    <label>Nom du Fichier</label>
                    <input type="text" formControlName="nom" pInputText />
                </div>
                <div class="field col-6">
                    <label>Note :</label>
                    <textarea pInputTextarea formControlName="note"></textarea>
                </div>
                <div class="field col-6">
                    <label>Traité par :</label>
                    <p-dropdown [options]="agentSourcingList" formControlName="traited_by" optionValue="label"
                        optionLabel="label" placeholder="Choisissez un agent" [group]="true" filter="true"></p-dropdown>
                </div>
                <div class="field col-12">
                    <p-fileUpload (uploadHandler)="FileUploadAdmin($event)" mode="basic"
                        chooseLabel="Ajouter un Document" customUpload="true" fileLimit="1"
                        accept=".docx,.pdf,.doc,.jpg,.png,.jpeg" [disabled]="uploadAdminFileForm.invalid"
                        maxFileSize="10000000" [auto]="true" #fileInput>
                    </p-fileUpload>
                </div>

            </form>
        </div>
    </div>
    <div class="col-12 card" *ngIf="showDocuments">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showDocuments = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showPaiement?.user_id" class="text-center" style="font-weight: bold;"> Documents de : {{
            showDocuments?.user_id?.firstname }} {{
            showDocuments?.user_id?.lastname | uppercase }}
        </h3>
        <div class="col-12 grid">
            <div class="col-12">
                <strong>Mes attestations disponibles:</strong>
            </div>
            <div class="col-12">
                <p-table styleClass="p-datatable-gridlines" [value]="showDocuments.documents_administrative"
                    responsiveLayout="scroll" responsiveLayout="scroll">
                    <ng-template pTemplate="header" let-columns>
                        <tr>
                            <th>
                                Date de délivrance
                            </th>
                            <th>
                                Nom du document
                            </th>
                            <th>
                                Traité par
                            </th>
                            <th>
                                Lien de téléchargement
                            </th>
                            <th>
                                Note
                            </th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-rowData>
                        <tr>
                            <td>
                                {{rowData.date | date:'mediumDate'}}
                            </td>
                            <td>
                                {{rowData.nom}}
                            </td>
                            <td>
                                {{rowData.traited_by}}
                            </td>
                            <td>
                                <a (click)="downloadAdminFile(rowData.path)">Télécharger</a>
                            </td>
                            <td>
                                {{rowData.note}}
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
        <p *ngIf="showDocuments.documents_administrative==null || showDocuments.documents_administrative.length==0">
            Aucun document n'a été chargé !
        </p>
        <div class="col-12">
            <button pButton label="Ajouter un document" (click)="showUploadFile=showDocuments;scrollToTop()"></button>
        </div>
    </div>
    <!-- Formulaire Traitement -->
    <div class="col-12 card" *ngIf="showTraitement">
        <i class="pi pi-times-circle" style="float:right; color: red; cursor: pointer;" (click)="showTraitement = null"
            aria-hidden="true"> </i>
        <h3 *ngIf="showTraitement?.user_id" class="text-center" style="font-weight: bold;"> Dossier de : {{
            showTraitement?.user_id?.firstname }} {{
            showTraitement?.user_id?.lastname | uppercase }}
        </h3>
        <form class="p-fluid p-formgrid grid card" [formGroup]="traitementForm">
            <div class="field md:col-6 col-12">
                <label>Traité le :</label>
                <input type="date" pInputText formControlName="dossier_traited_date" />
            </div>
            <div class="field md:col-6 col-12">
                <label>Traité par :</label>
                <p-dropdown [options]="agentSourcingList" formControlName="dossier_traited_by"
                    placeholder="Choisissez un agent" [group]="true" filter="true"></p-dropdown>
            </div>
            <div class="field col-12">
                <label>Etat du dossier :</label>
                <p-dropdown [options]="etatList" formControlName="statut_dossier" placeholder="Choisissez un état"
                    filter="true"></p-dropdown>
            </div>

            <div class="field col-12">
                <label>Procèdure pédagogique</label>
                <p-dropdown [options]="ppList" formControlName="procedure_peda"
                    placeholder="Choisissez une procèdure"></p-dropdown>
            </div>
            <div class="field md:col-6 col-12">
                <label For="formation">Décision admission</label>
                <p-dropdown [options]="admissionList" formControlName="decision_admission"></p-dropdown>
                <!--<p-dropdown [options]="civiliteList" formControlName="formation"></p-dropdown>-->
            </div>
            <div class="field md:col-6 col-12">
                <label>Note :</label>
                <textarea pInputTextarea formControlName="note_decision"></textarea>
            </div>
            <div class="field col-12">
                <label>Statut de paiement</label>
                <p-dropdown [options]="[{label:'Oui'},{label:'Non'}]" optionValue="label" optionLabel="label"
                    formControlName="statut_payement" placeholder="Choisissez une procèdure"></p-dropdown>
            </div>
            <div class="field md:col-6 col-12">
                <label>Numéro de dossier Campus France :</label>
                <input pInputText formControlName="numero_dossier_campus_france" />
            </div>
            <div class="field md:col-6 col-12">
                <label>Confirmation Campus France :</label>
                <p-selectButton [options]="stat_cf" formControlName="validated_cf">
                </p-selectButton>
            </div>
            <div class="col-12">
                <button pButton label="Sauvegardez les modifications" (click)="saveTraitement()"></button>
            </div>
        </form>
    </div>

    <!-- Table d'affichage de la liste des preinscription -->
    <div class="col-12 card grid" *ngIf="ecoleList.length!=0">
        <p-tabView style="max-width: 100%;">
            <p-tabPanel [header]="ecole.titre" *ngFor="let ecole of ecoleList; let i = index" [selected]="i == 0">
                <div *ngIf="prospects && prospects[ecole.url_form]" >
                    <h5>Liste des leads admission de {{ecole.titre}}</h5>

                    <p-toast></p-toast>
                    <p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true"
                        [value]="prospects[ecole.url_form]" [paginator]="true" [pageLinks]="5" selectionMode="single"
                        [globalFilterFields]="['customid', 'type_form', 'code_commercial', 'programme','user_id.firstname','user_id.lastname','formation','statut_dossier','campus_choix_1','campus_choix_2','campus_choix_3','user_id.email_perso','rythme_formation']"
                        responsiveLayout="scroll" styleClass="p-datatable-gridlines">

                        <ng-template pTemplate="caption">
                            <span class="p-input-icon-left mb-2">
                                <i class="pi pi-search"></i>
                                <input pInputText type="text" #filter
                                    (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Recherche"
                                    class="w-full" />
                            </span>
                            <p-dropdown filter="true" placeholder="Pays" [options]="filterPays"
                                (onChange)="dt1.filter($event.value, 'user_id.pays_adresse','equals')"
                                emptyFilterMessage="Pas de pays trouvé" filterPlaceholder="Pays"
                                [style]="{'margin':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Campus" [options]="filterCampus"
                                (onChange)="dt1.filter($event.value, 'campus_choix_1','equals')"
                                emptyFilterMessage="Pas de campus trouvé" filterPlaceholder="Campus"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Formation" [options]="filterFormation"
                                (onChange)="dt1.filter($event.value, 'formation','equals')"
                                emptyFilterMessage="Pas de formation trouvé" filterPlaceholder="Formation"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown placeholder="Initiale/Alternance" [options]="filterRythmeFormation"
                                (onChange)="dt1.filter($event.value, 'rythme_formation','equals')"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Anglais/Français" [options]="filterProgramme"
                                (onChange)="dt1.filter($event.value, 'programme','equals')"
                                emptyFilterMessage="Pas de programme trouvé" filterPlaceholder="Programme"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Dossier Lead" [options]="filterStatut"
                                (onChange)="dt1.filter($event.value, 'haveDoc','equals')"
                                emptyFilterMessage="Pas de statut trouvé" filterPlaceholder="Statut du dossier"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Source" [options]="filterSource"
                                (onChange)="dt1.filter($event.value, 'source','startsWith')"
                                emptyFilterMessage="Pas de source trouvé" filterPlaceholder="Source"
                                [style]="{'margin-left':'5px','margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Decision Admission"
                                [options]="dropdownDecisionAdmission"
                                (onChange)="dt1.filter($event.value, 'decision_admission','equals')"
                                emptyFilterMessage="Pas de decision trouvé" filterPlaceholder="Decision Admission"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>


                            <p-dropdown filter="true" placeholder="Ecole" [options]="filterEcole"
                                (onChange)="dt1.filter($event.value, 'type_form','equals')"
                                emptyFilterMessage="Pas d'école trouvé" filterPlaceholder="Ecole"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>


                            <p-dropdown filter="true" placeholder="Decision Orientation"
                                [options]="dropdownDecisionOrientation"
                                (onChange)="dt1.filter($event.value, 'decision_orientation','equals')"
                                emptyFilterMessage="Pas de decision trouvé" filterPlaceholder="Decision Orientation"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>

                            <p-dropdown filter="true" placeholder="Phase de la candidature" [options]="filterPhase"
                                (onChange)="dt1.filter($event.value, 'phase_candidature','equals')"
                                emptyFilterMessage="Pas de phase trouvé" filterPlaceholder="Phase de la candidature"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                            <p-dropdown filter="true" placeholder="Rentrée scolaire" [options]="filterRentreeScolaire"
                                (onChange)="dt1.filter($event.value, 'rentree_scolaire','equals')"
                                emptyFilterMessage="Pas de statut trouvé" filterPlaceholder="Rentrée scolaire"
                                [style]="{'margin-right':'5px'}">
                            </p-dropdown>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem" scope="col"></th>
                                <th pSortableColumn="date_creation" scope="col" style="text-align: center;">
                                    Date Inscr. <p-sortIcon field="date_creation"></p-sortIcon>
                                </th>
                                <th pSortableColumn="customid" scope="col" style="text-align: center;">
                                    ID Lead <p-sortIcon field="customid"></p-sortIcon>
                                </th>
                                <th pSortableColumn="source" scope="col" style="text-align: center;">
                                    Source <p-sortIcon field="source"></p-sortIcon>
                                </th>
                                <th pSortableColumn="user_id.firstname" scope="col" style="text-align: center;">
                                    Prénom & Nom <p-sortIcon field="firstname"></p-sortIcon>
                                </th>
                                <th pSortableColumn="user_id.pays_adresse" scope="col" style="text-align: center;">
                                    Pays de résidence <p-sortIcon field="user_id.pays_adresse"></p-sortIcon>
                                </th>
                                <th pSortableColumn="campus_choix_1" scope="col" style="text-align: center;">
                                    Campus <p-sortIcon field="campus_choix_1"></p-sortIcon>
                                </th>
                                <th pSortableColumn="type_form" scope="col" style="text-align: center;">
                                    Ecole <p-sortIcon field="type_form"></p-sortIcon>
                                </th>
                                <th pSortableColumn="formation" scope="col" style="text-align: center;">
                                    Formation <p-sortIcon field="formation"></p-sortIcon>
                                </th>
                                <th pSortableColumn="rythme_formation" scope="col" style="text-align: center;">
                                    Initial/Alternant <p-sortIcon field="rythme_formation"></p-sortIcon>
                                </th>
                                <th pSortableColumn="programme" scope="col" style="text-align: center;">
                                    Anglais/Français <p-sortIcon field="programme"></p-sortIcon>
                                </th>
                                <th pSortableColumn="haveDoc" scope="col" style="text-align: center;">
                                    Documents d'inscription<p-sortIcon field="haveDoc"></p-sortIcon>
                                </th>

                                <th pSortableColumn="decision_orientation" scope="col" style="text-align: center;">
                                    Decision Orientation<p-sortIcon field="decision_orientation"></p-sortIcon>
                                </th>
                                <th pSortableColumn="decision_admission" scope="col" style="text-align: center;">
                                    Decision Admission<p-sortIcon field="decision_admission"></p-sortIcon>
                                </th>
                                <th pSortableColumn="statut_payement" scope="col" style="text-align: center;">
                                    Paiement<p-sortIcon field="statut_payement"></p-sortIcon>
                                </th>
                                <th pSortableColumn="numero_dossier_campus_france" scope="col"
                                    style="text-align: center;">
                                    ID CF<p-sortIcon field="numero_dossier_campus_france"></p-sortIcon>
                                </th>
                                <th pSortableColumn="validated_cf" scope="col" style="text-align: center;">
                                    Confirmation CF<p-sortIcon field="validated_cf"></p-sortIcon>
                                </th>
                                <th pSortableColumn="phase_candidature" scope="col" style="text-align: center;">
                                    Phase de Candidature <p-sortIcon field="phase_candidature"></p-sortIcon>
                                </th>
                                <th pSortableColumn="rentree_scolaire" scope="col" style="text-align: center;">
                                    Rentrée scolaire <p-sortIcon field="rentree_scolaire"></p-sortIcon>
                                </th>
                                <th *ngIf="AccessLevel!='Spectateur'" pSortableColumn="action" scope="col"
                                    style="text-align: center;">
                                    Action
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-prospect>
                            <tr>

                                <td>
                                    <button type="button" pButton pRipple
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="selectedProspect==prospect ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                        (click)="expand(prospect)"></button>
                                </td>

                                <td>
                                    {{prospect?.date_creation | date :'mediumDate' }}
                                </td>
                                <td>
                                    {{ prospect?.customid }}
                                </td>

                                <td>
                                    {{ prospect?.source }}
                                </td>

                                <td *ngIf="prospect.user_id">
                                    {{ prospect?.user_id?.firstname | titlecase }}
                                    {{ prospect?.user_id?.lastname | uppercase }}
                                </td>
                                <td *ngIf="prospect.user_id">
                                    {{ prospect?.user_id?.pays_adresse }}
                                </td>

                                <td>
                                    {{ prospect.campus_choix_1 }}
                                </td>
                                <td>
                                    {{ prospect.type_form|titlecase }}
                                </td>
                                <td>
                                    {{ prospect.formation | titlecase }}
                                </td>
                                <td>
                                    {{ prospect.rythme_formation }}
                                </td>
                                <td>
                                    {{ prospect.programme }}
                                </td>
                                <td *ngIf="prospect.haveDoc">
                                    Oui
                                </td>
                                <td *ngIf="!prospect.haveDoc">
                                    Non
                                </td>
                                <td>
                                    {{ prospect.decision_orientation }}
                                </td>
                                <td>
                                    {{ (prospect.decision_admission)?prospect.decision_admission:"En attente de
                                    traitement" }}
                                </td>
                                <td *ngIf="prospect.statut_payement">
                                    {{ prospect.statut_payement }}
                                </td>
                                <td *ngIf="!prospect.statut_payement">
                                    Non
                                </td>
                                <td>
                                    {{ prospect.numero_dossier_campus_france }}
                                </td>
                                <td>
                                    {{ prospect.validated_cf }}
                                </td>
                                <td>
                                    {{ prospect.phase_candidature }}
                                </td>
                                <td>
                                    {{ prospect.rentree_scolaire }}
                                </td>
                                <td *ngIf="AccessLevel!='Spectateur'">
                                    <i pTooltip="Traiter le dossier" tooltipPosition="bottom" class="pi pi-cog mr-2"
                                        (click)="initTraitement(prospect);scrollToTop()" aria-hidden="true"></i>
                                    <i pTooltip="Paiement" tooltipPosition="bottom" class="pi pi-credit-card mr-2"
                                        (click)="initPaiement(prospect);scrollToTop()" aria-hidden="true"></i>
                                    <i pTooltip="Documents" tooltipPosition="bottom" class="pi pi-file mr-2"
                                        (click)="initDocument(prospect);scrollToTop()" aria-hidden="true"></i>
                                    <i pTooltip="Details" tooltipPosition="bottom" class="pi pi-user-edit"
                                        (click)="initDetails(prospect);scrollToTop()" aria-hidden="true"></i>

                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </p-tabPanel>
        </p-tabView>
    </div>
    <div class="col-12 card" *ngIf="ecoleList.length==0">
        <h5>Chargement en cours des données...</h5>
        <p-skeleton width="100%" height="100vh"></p-skeleton>
    </div>
    <!-- Expand SideBar -->
    <p-sidebar [(visible)]="showSideBar" styleClass="w-30rem" position="right" (onHide)="selectedProspect=null">
        <div *ngIf="selectedProspect">
            <h5>Informations Lead</h5>
            <p>Civilité: {{selectedProspect?.user_id?.civilite}}</p>
            <p>Nom & Prénom: {{ selectedProspect?.user_id?.firstname | titlecase }} {{
                selectedProspect?.user_id?.lastname |
                uppercase }}</p>
            <p>Date de naissance: {{ selectedProspect?.date_naissance | date:'mediumDate' }}</p>
            <p>Nationalité: {{ selectedProspect?.user_id?.nationnalite }}</p>
            <p>Pays de résidence: {{ selectedProspect?.user_id?.pays_adresse }}</p>
            <p>Adresse électronique: {{ selectedProspect?.user_id?.email_perso }}</p>
            <p>Numéro de téléphone: {{ selectedProspect?.user_id?.indicatif }} {{ selectedProspect?.user_id?.phone }}
            </p>
            <p>Numéro WhatsApp: {{ selectedProspect?.numero_whatsapp }}</p>
            <p>Statut actuel : {{ selectedProspect?.statut_actuel }}</p>

            <h5>Compétences et expériences</h5>
            <p>Niveau en Français: {{ selectedProspect?.languages_fr }}</p>
            <p>Niveau en Anglais: {{ selectedProspect?.languages_en }}</p>
            <p>Expériences professionnelles: {{ selectedProspect.professional_experience?'Oui':'Non' }}</p>
            <p>Description de l’expérience: {{ selectedProspect?.professional_experience }}</p>

            <h5>Choix académique</h5>
            <p>Rentrée scolaire: {{ selectedProspect?.rentree_scolaire }}</p>
            <p>Campus choix 1: {{ selectedProspect?.campus_choix_1 }}</p>
            <p>Campus choix 2: {{ selectedProspect?.campus_choix_2 }}</p>
            <p>Campus choix 3: {{ selectedProspect?.campus_choix_3 }}</p>
            <p>Formation : {{ selectedProspect?.formation }}</p>
            <p>Programme : {{ selectedProspect?.programme }}</p>
            <p>Rythme : {{ selectedProspect?.rythme_formation }}</p>

            <h5>Source </h5>
            <p>Source du lead: {{ selectedProspect?.source }}</p>
            <p>Nom de la commerciale ou partenaire: {{infoCommercial?.user_id?.lastname}}
                {{infoCommercial?.user_id?.firstname}}
            </p>
            <p>
                Nom du Partenaire : {{infoPartenaire?.nom}}
            </p>
            <p>Adresse électronique commerciale: {{infoCommercial?.user_id?.email_perso}}</p>

            <h5>Démarches </h5>
            <p>Date d’inscription: {{ selectedProspect?.date_creation | date :'mediumDate'}}</p>
            <p>Date de contact: {{ selectedProspect?.contact_date| date :'mediumDate' }}</p>
            <p>Phase de la candidature: {{ selectedProspect?.phase_candidature }}</p>
            <p>Montant payé: {{ selectedProspect?.statut_payement }}</p>
            <p>Visa : {{ selectedProspect?.avancement_visa }}</p>
        </div>

    </p-sidebar>
</div>