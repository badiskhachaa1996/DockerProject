<input type="file" (change)="FileUpload($event)" id="selectedFile" #selectedFile style="display: none;" pInputFile />
<div class="grid">

    <div class="card col-12" *ngIf="showAffect">
        <form class="p-fluid p-formgrid grid" [formGroup]="affectForm">
            <div class="field col-12 md:col-6">
                <label>Affecter le :</label>
                <input type="date" pInputText formControlName="affected_date">
            </div>
            <div class="field col-12 md:col-6">
                <label>Affecter à :</label>
                <p-dropdown [options]="memberList" formControlName="affected_to_member" autoWidth="false"
                    [style]="{'width':'100%'}" placeholder="Choisissez un membre"></p-dropdown>
            </div>
            <div class="col-12 grid">
                <div class="col-12">
                    <button pButton label="Sauvegardez les modifications" (click)="onUpdateAffect()"></button>
                </div>
            </div>

        </form>
    </div>
    <div class="card col-12">
        <h5>La liste des leads CRM</h5>

        <p-toast></p-toast>
        <p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true" [value]="leads" [paginator]="true"
            [pageLinks]="5" selectionMode="single" [globalFilterFields]="['custom_id', 'prenom', 'nom','email']"
            rowExpandMode="single" responsiveLayout="scroll" styleClass="p-datatable-gridlines">
            <ng-template pTemplate="caption">
                <div class="d-flex flex-wrap align-items-center justify-content-center">
                    <input pInputText type="text" #filter (input)="dt1.filterGlobal($event.target.value, 'contains')"
                        placeholder="Recherche" class="h-auto" />

                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterPays" filter="true"
                        (onChange)="dt1.filter($event.value, 'pays_residence', 'equals');"
                        emptyFilterMessage="Pas de pays trouvé" filterPlaceholder="Choisissez un pays"></p-dropdown>

                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterSource" filter="true"
                        (onChange)="dt1.filter($event.value, 'source', 'equals');"
                        emptyFilterMessage="Pas de source trouvé"
                        filterPlaceholder="Choisissez une source"></p-dropdown>

                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterOperation" filter="true"
                        (onChange)="dt1.filter($event.value, 'operation', 'equals');"
                        emptyFilterMessage="Pas d'opération trouvé"
                        filterPlaceholder="Choisissez une operation"></p-dropdown>
                </div>
                <div class="d-flex flex-wrap align-items-center justify-content-center">
                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterAffecte" filter="true"
                        (onChange)="dt1.filter($event.value, 'affected_to_member', 'equals');"
                        emptyFilterMessage="Pas de membre trouvé" filterPlaceholder="Choisissez un membre"></p-dropdown>

                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterQualification" filter="true"
                        (onChange)="dt1.filter($event.value, 'decision_qualification', 'equals');"
                        emptyFilterMessage="Pas de qualification trouvé"
                        filterPlaceholder="Choisissez une qualification"></p-dropdown>

                    <p-dropdown [style]="{'margin':'5px'}" [options]="filterPaiement" filter="true"
                        (onChange)="dt1.filter($event.value, 'modalite_paiement', 'equals');"
                        emptyFilterMessage="Pas de modalité trouvé"
                        filterPlaceholder="Choisissez une modalité de paiement"></p-dropdown>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>

                    </th>
                    <th pSortableColumn="date_creation" scope="col" style="text-align: center;">
                        Date d'insertion <p-sortIcon field="date_creation"></p-sortIcon>
                    </th>

                    <th pSortableColumn="operation" scope="col" style="text-align: center;">
                        Opération <p-sortIcon field="operation"></p-sortIcon>
                    </th>
                    <th pSortableColumn="source" scope="col" style="text-align: center;">
                        Source Lead <p-sortIcon field="source"></p-sortIcon>
                    </th>
                    <th pSortableColumn="prenom" scope="col" style="text-align: center;">
                        Prénom & NOM <p-sortIcon field="prenom"></p-sortIcon>
                    </th>
                    <th pSortableColumn="pays_residence" scope="col" style="text-align: center;">
                        Pays de résidence <p-sortIcon field="pays_residence"></p-sortIcon>
                    </th>
                    <th pSortableColumn="affected_to_member" scope="col" style="text-align: center;">
                        Affecté à <p-sortIcon field="affected_to_member"></p-sortIcon>
                    </th>
                    <th pSortableColumn="decision_qualification" scope="col" style="text-align: center;">
                        Decision Qualification <p-sortIcon field="decision_qualification"></p-sortIcon>
                    </th>
                    <th *ngIf="AccessLevel!='Spectateur'">
                        Action
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-lead let-expanded="expanded">
                <tr>
                    <td>
                        <button type="button" pButton pRipple [pRowToggler]="lead"
                            class="p-button-text p-button-rounded p-button-plain"
                            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right' "></button>
                    </td>
                    <td>
                        {{lead.date_creation | date:'dd MMMM yy'}}
                    </td>
                    <td>
                        {{lead.operation}}
                    </td>
                    <td>
                        {{lead.source}}
                    </td>
                    <td>
                        {{lead.prenom | titlecase}} {{lead.nom | uppercase}}
                    </td>
                    <td>
                        {{lead.pays_residence}}
                    </td>
                    <td>
                        {{lead?.affected_to_member?.firstname | titlecase}}
                        {{lead?.affected_to_member?.lastname | uppercase}}
                    </td>
                    <td>
                        {{lead.decision_qualification}}
                    </td>
                    <td *ngIf="AccessLevel!='Spectateur'">
                        <i pTooltip="Suivre" tooltipPosition="bottom" class="pi pi-briefcase mr-2"
                            (click)="initFollow(lead);scrollToTop()" aria-hidden="true"></i>
                        <i pTooltip="Affecter" tooltipPosition="bottom" class="pi pi-cog mr-2"
                            (click)="initAffect(lead);scrollToTop()" aria-hidden="true"></i>
                        <i style="padding-left: 3%;" class="pi pi-pencil" (click)="updateLead(lead._id)"
                            pTooltip="Modifier le lead" aria-hidden="true" tooltipPosition="bottom"></i>
                        <i style="padding-left: 3%;" class="pi pi-trash" (click)="delete(lead);"
                            pTooltip="Supprimer le lead" aria-hidden="true" tooltipPosition="bottom"></i>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="rowexpansion" let-lead>
                <tr>
                    <td colspan="9">
                        <h5>Informations supplémentaire</h5>
                        <p-table [value]="['']" styleClass="p-datatable-gridlines">
                            <ng-template pTemplate="header">
                <tr>
                    <th>Civilité</th>
                    <th>Pays de résidence</th>
                    <th>Email</th>
                    <th>Nationalité</th>
                    <th>Date de naissance</th>
                    <th>Numéro de téléphone</th>
                    <th>Numéro WhatsApp</th>
                    <th>Dernier niveau académique</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body">
                <tr>
                    <td>{{lead?.civilite}}</td>
                    <td>{{lead?.pays_residence}}</td>
                    <td>{{lead?.email}}</td>
                    <td>{{lead?.nationalite}}</td>
                    <td>{{lead?.date_naissance | date: 'dd MMMM YYYY'}}</td>
                    <td>{{lead?.indicatif_phone}} {{lead?.numero_phone}}</td>
                    <td>{{lead?.indicatif_whatsapp}} {{lead?.numero_whatsapp}}</td>
                    <td>{{lead?.dernier_niveau_academique}}</td>
                </tr>
            </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        </p-table>
    </div>