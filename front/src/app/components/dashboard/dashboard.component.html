<p-toast></p-toast>
<div class="col-12">
    <input type="file" (change)="FileUploadPC($event.target.files)" id="selectedFile" #selectedFile
        accept=".pdf,.jpg,.png,.jpeg" style="display: none;" pInputFile />
</div>
<div *ngIf="isUnknow">
    <h2 *ngIf="user" style="text-align: center;">Bienvenue {{user.firstname | titlecase}} {{user.lastname | uppercase}}
    </h2>
    <div class="card">
        <div class="col-8 col-offset-2 flex justify-content-center flex-wrap card-container">
            <img src="assets\images\construction.jpg" style="width: 40%;">
        </div>
        <p>Le tableau de bord est actuellement en construction pour votre statut!</p>
        <p>Pour naviguer sur l'application, merci d'utiliser le menu à gauche.</p>
        <p>Si vous rencontrez le moindre problème, nous vous invitons à créer un ticket dans la partie <span
                style="color: red; font-weight: bold;">"Ticketing"</span> dans le menu</p>
        <p>Merci de votre patience!</p>
    </div>
</div>

<p-dialog [style]="{width: '50vw'}" [(visible)]="displayPointeuse" header="Heure de Pointage" [modal]="true">
    <p-table #dtPoi dataKey="_id" [value]="histoPointage" responsiveLayout="scroll" styleClass="p-datatable-gridlines"
        *ngIf="histoPointage">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="date" scope="col" style="text-align: center;">
                    Time <p-sortIcon field="date"></p-sortIcon>
                </th>
                <th pSortableColumn="uid" scope="col" style="text-align: center;">
                    UID <p-sortIcon field="uid"></p-sortIcon>
                </th>
                <th pSortableColumn="user_id" scope="col" style="text-align: center;">
                    Localisation <p-sortIcon field="user_id"></p-sortIcon>
                </th>
                <th pSortableColumn="type" scope="col" style="text-align: center;">
                    Type de Pointage <p-sortIcon field="type"></p-sortIcon>
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-point>
            <tr>
                <td>
                    {{point.date | date:'H:mm' }}
                </td>
                <td>
                    {{point.uid}}
                </td>
                <td>
                    {{machineDic[point.machine]?.localisation}}
                </td>
                <td>
                    {{point.type}}
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-dialog>

<!-- Modèle visiteur -->
<div *ngIf="isVisitor">
    <h2 *ngIf="user && !isEtudiant" style="text-align: center;">Bienvenue {{user.firstname | titlecase}} {{user.lastname
        | uppercase}}
    </h2>
    <h5 style="color: red;"> Ce compte étant un compte avec un accès limité, vous n'aurez ni droit à la modification ni
        à l'ajout de données</h5>
    <div class="card">
        <p>Bonjour, ceci est un accès limité à notre outils de gestion [IMS]. N'hésitez pas à faire le tour du menu qui
            vous a été attribué.</p>
        <p>Bonne visite sur IMS!</p>
    </div>
</div>


<!-- Checking area -->
<div class="grid" *ngIf="isAdmin"> 
    <div class="col-12">
        <!-- info user -->
        

        <!-- Tabs avec les cra etc -->
        <div class="card">
            <p-tabView [(activeIndex)]="selectedTabIndex">
                <p-tabPanel header="CRA">
                    
                    <div class="card">
                        <div class="grid">
                            <div class="col-6 md:col-3">
                                <button pButton pRipple (click)="onCheckIn()" label="Check in" class="p-button-primary mb-2"
                                    [disabled]="dailyCheck != null"></button> <br>
                                
                                    <h5>Heure de check In </h5>
                                    <h6><strong>Online</strong> {{dailyCheck?.check_in | date: 'HH:mm'}} </h6>
                                    <h6><strong>Pointeuse</strong> {{getCheckIn(user?._id) | date:'H:mm'}} </h6>
                                
                            </div>
                            <div class="col-6 md:col-3">
                                <span *ngIf="!dailyCheck?.isInPause"><button pButton pRipple (click)="onPause()" label="Pause"
                                    class="p-button-warning mb-2"
                                    [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button> <br></span>
                            <span *ngIf="dailyCheck?.isInPause"><button pButton pRipple (click)="onStopPause()"
                                    label="Fin de la pause" class="p-button-warning mb-2"
                                    [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button> <br></span>
                                
                                
                               
                            </div>
                            <div class="col-6 md:col-3 ">
                                <button pButton pRipple label="Check out" (click)="onCheckOut()" class="p-button-danger"
                                    [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button>
                                <!--<h5 style="text-align: center;">
                                    Statut actuel <span pTooltip="Modifier le statut" (click)="showFormUpdateStatut = true"><i
                                            class="pi pi-pencil" style="color: #4338CA"></i></span><br>
                                    <!-- formulaire pour mettre à jour le statut de l'utilisateur -->
                                <!--    <div *ngIf="showFormUpdateStatut">
                                        <hr>
                                        <form [formGroup]="formUpdateStatut" class="p-fluid p-formgrid"
                                            (ngSubmit)="onUpdateStatus()">
                                            <div class="field">
                                                <label htmlFor="statut">Mettre à jour votre statut</label>
                                                <p-dropdown [options]="statutList" placeholder="Sélectionnez votre nouveau statut"
                                                    [showClear]="true" formControlName="statut"></p-dropdown>
                                            </div>
                                            <div class="field">
                                                <button pButton type="submit" label="Valider" class="p-button-outlined"></button>
                                            </div>
                                        </form>
                                        <hr>
                                    </div>
                                    <!-- end dialogue -->
                            <!--      <span style="color: green; font-weight: bolder;">{{userConnected?.statut}}</span>
                                </h5>
                            -->
                            </div>
                            <div class="col-6 md:col-3" style="text-align: center">
                                <h6>Temps passé au <br> travail:
                                    <strong>{{workingHour}}</strong>h<strong>{{workingMinute}}</strong>mn
                                </h6>
                                <h6>Temps passé en <br> pause: <strong>{{pauseTiming}}</strong>mn</h6>
                                <h6>Taux de remplissage du <br> CRA: <strong>{{craPercent}}%</strong></h6>
                                <!--<img [src]="imageToShow" alt="Profil" width="150" height="150" style="border-radius: 50px;" />
                                <!--<h6 style="font-style: italic;">{{userConnected?.mention}}</h6>
                                <h6 *ngIf="userConnected?.service_id">Service: <i>{{userConnected?.service_id?.label}}</i></h6>-->
                        
                            </div>
                        </div>
                    </div>
                    <div class=" card">
                        <div class="grid col-12">
                            <div class="col-4 text-center">
                                <p-button styleClass="p-button-secondary">Historique</p-button>

                            </div>
                            <div class="col-4 d-flex text-center">
                                <p-button styleClass="p-button-warning">Congé</p-button>
                            </div>
                            <div class="col-4 text-center">
                                <p-button styleClass="p-button-help">Assiduité</p-button>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="showFormAddCra">
                        <div class="add-button-div mb-2">
                            <i class="pi pi-times-circle" pTooltip="Fermer" (click)="showFormAddCra = false;"
                                style="color: red; font-size: 20px; float: right; cursor: pointer;"></i>
                        </div>
                        <div style="clear: both;"></div>

                        <form class="p-fluid" [formGroup]="formAddCra" (ngSubmit)="onAddCra()">
                            <div formArrayName="cras"
                                *ngFor="let cra of getCras().controls; let i = index; let c = count">
                                <div class="p-formgrid grid" [formGroupName]="i">
                                    <div class="field col-12 md:col-5">
                                        <input pInputText type="text" id="tache" formControlName="tache"
                                            placeholder="Veuillez décrire la tâche">
                                    </div>
                                    <div class="field col-12 md:col-5">
                                        <input pInputText type="number" id="duration" formControlName="duration"
                                            placeholder="Durée en minute">
                                    </div>
                                    <div class="field col-12 md:col-2" *ngIf="c > 1">
                                        <button pButton pRipple pTooltip="Supprimer la ligne" type="button"
                                            icon="pi pi-trash" class="p-button-outlined p-button-danger mb-2"
                                            (click)="onDeleteCraField()"></button>
                                    </div>
                                </div>
                            </div>
                            <button pButton pRipple type="button" icon="pi pi-plus"
                                class="p-button-outlined p-button-success mb-2" (click)="onAddCraField()"></button>

                            <div class="col-2">
                                <button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2"
                                    [disabled]="formAddCra.invalid"></button>
                            </div>
                        </form>
                    </div>

                    <button pButton pRipple label="Ajouter" class="p-button-primary p-button-outlined mb-2"
                        style="float: right;" (click)="showFormAddCra = true;"
                        *ngIf="dailyCheck != null && !showFormAddCra"></button>
                    <div style="clear: both;"></div>
                    <p-table [value]="dailyCheck?.cra" dataKey="_id" editMode="row" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Durée</th>
                                <th>Tâche</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-cra let-editing="editing" let-ri="rowIndex">
                            <tr [pEditableRow]="cra">
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="number" [(ngModel)]="cra.number_minutes">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.number_minutes}} mn
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="text" [(ngModel)]="cra.task">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.task}}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                                        icon="pi pi-pencil" (click)="onRowEditInit(cra)"
                                        class="p-button-rounded p-button-text"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow
                                        icon="pi pi-check" (click)="onRowEditSave(cra)"
                                        class="p-button-rounded p-button-text p-button-success mr-2"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow
                                        icon="pi pi-times" (click)="onRowEditCancel(cra, ri)"
                                        class="p-button-rounded p-button-text p-button-danger"></button>
                                    <button pButton pRipple type="button" icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="onDeleteCra(cra._id)"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3">Aucun CRA pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="3">Chargement des CRA, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>
                <p-tabPanel header="Actualités">
                    <p-table [value]="actualites" dataKey="_id" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Date</th>
                                <th>Titre de l'actualité</th>
                                <th>Contenu de l'actualité</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-actualite>
                            <tr>
                                <td>
                                    {{actualite?.date_creation | date :'medium' }}
                                </td>
                                <td>
                                    {{actualite?.titre}}
                                </td>
                                <td>
                                    {{actualite?.description}}
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3">Aucune information pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="3">Chargement des informations, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>



                <!--<p-tabPanel header="Suivre mon assiduité">
                    <div class="grid">
                        <div class="col-6">
                            <div>
                                <label htmlFor="">Choisissez un mois et une année</label> <br>
                                <input pInputText type="month"
                                    (input)="dateChoose=$event.target.value;OnCalcAssiduite()">
                            </div>
                            <h6>Nombre de jours de congés payés: <strong>{{stats.conges_pay}} jrs</strong></h6>
                            <h6>Nombre de jours de congés sans solde: <strong>{{stats.conges_ss}} jrs</strong></h6>
                            <h6>Nombre de jours de congés maladie: <strong>{{stats.maladie}} jrs</strong></h6>
                            <h6>Nombre de jours en absences justifies: <strong>{{stats.absence_justifie}} jrs</strong>
                            </h6>
                            <h6>Nombre de jours en absences non justifies:
                                <strong>{{22-stats.assiduite-stats.absence_justifie-stats.maladie-stats.conges_ss-stats.conges_pay}}
                                    jrs</strong>
                            </h6>

                        </div>
                        <div class="col-6 flex justify-content-center align-items-center">
                            <h6>Taux d'assiduité: <strong>{{(stats.assiduite/22)*100 | number:'1.0-2'}} %</strong></h6>
                        </div>

                    </div>

                </p-tabPanel>

                <!--<p-tabPanel header="Mes demandes">
                    <button pButton pRipple label="Ajouter" class="p-button-primary p-button-outlined mb-2"
                        (click)="AddTicket()" style="float: right;"></button>
                    <div style="clear: both;"></div>
                    <p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true" [value]="tickets"
                        [paginator]="true" rowExpandMode="single" [pageLinks]="5" selectionMode="single" class="col-12"
                        [globalFilterFields]="['customid', 'prenom', 'nom','email']" responsiveLayout="scroll"
                        styleClass="p-datatable-gridlines">
                        <ng-template pTemplate="caption">
                            <div class="flex justify-content-between flex-column sm:flex-row">
                                <input pInputText type="text" #filter
                                    (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Recherche" />
                                <!-- <p-dropdown [style]="{'margin':'5px'}" [options]="filterPays" filter="true"
                                (onChange)="dt1.filter($event.value, 'pays_residence', 'equals');"
                                emptyFilterMessage="Pas de pays trouvé" filterPlaceholder="Choisissez un pays"></p-dropdown>
            
                            <p-dropdown [style]="{'margin':'5px'}" [options]="filterSource" filter="true"
                                (onChange)="dt1.filter($event.value, 'source', 'equals');" emptyFilterMessage="Pas de source trouvé"
                                filterPlaceholder="Choisissez une source"></p-dropdown>
            
                            <p-dropdown [style]="{'margin':'5px'}" [options]="filterOperation" filter="true"
                                (onChange)="dt1.filter($event.value, 'operation', 'equals');"
                                emptyFilterMessage="Pas d'opération trouvé"
                                filterPlaceholder="Choisissez une operation"></p-dropdown>-->
                            <!--</div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem"></th>
                                <th pSortableColumn="customid" style="text-align:center"> ID Ticket <p-sortIcon
                                        field="customid">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="date_ajout" style="text-align:center"> Date de création <p-sortIcon
                                        field="date_ajout">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="createur_id.lastname" style="text-align:center"> Crée par
                                    <p-sortIcon field="user_id">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="service" style="text-align:center"> Service <p-sortIcon
                                        field="service">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="sujet" style="text-align:center"> Sujet <p-sortIcon field="sujet">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="priorite" style="text-align:center"> Priorité <p-sortIcon
                                        field="priorite">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="statut" style="text-align:center"> Etat de traitement <p-sortIcon
                                        field="statut">
                                    </p-sortIcon>
                                </th>
                                <th style="text-align:center">
                                    Délai de traitement
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-ticket let-expanded="expanded" let-ri="rowIndex">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="ticket"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                                    </button>
                                </td>
                                <td>
                                    {{ticket.customid}}
                                </td>
                                <td>
                                    {{ticket.date_ajout | date:'mediumDate'}}
                                </td>
                                <td>
                                    {{ticket?.createur_id?.firstname | titlecase}} {{ticket?.createur_id?.lastname |
                                    uppercase}}
                                </td>
                                <td>
                                    {{ticket?.sujet_id?.service_id?.label}}
                                </td>
                                <td>
                                    {{ticket?.sujet_id?.label}}
                                </td>
                                <td>
                                    {{ticket.priorite}}
                                </td>
                                <td>
                                    <p-tag *ngIf="ticket.statut == null" icon="pi pi-times" severity="danger"
                                        [value]="'Aucun status définit'">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En attente de traitement'" icon="pi pi-eye-slash"
                                        severity="info" [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En cours de traitement'" icon="pi pi-eye"
                                        severity="warning" [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En suspension'" icon="pi pi-pause" severity="danger"
                                        [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'Traité'" icon="pi pi-check-square"
                                        severity="success" [value]="ticket.statut">
                                    </p-tag>
                                </td>
                                <td>
                                    {{getDelaiTraitrement(ticket)}}
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-ticket>
                            <tr>
                                <td colspan="9">
                                    <p-table [value]="['']" class="col-12" styleClass="p-datatable-gridlines">
                                        <ng-template pTemplate="header">
                            <tr>
                                <th> Description </th>
                                <th> Date de traitement </th>
                                <th> Note du Service qui traite </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body">
                            <tr>
                                <td>{{ticket.description}}</td>
                                <td>{{ticket.date_fin_traitement| date:'mediumDate'}}</td>
                                <td>{{ticket.note}}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                    </td>

                    </tr>

                    <tr>
                        <td colspan="10">
                            <h5>Documents</h5>
                            <p-table dataKey="_id" [value]="ticket.documents" class="col-12"
                                styleClass="p-datatable-gridlines">
                                <ng-template pTemplate="header">
                    <tr>
                        <th> Nom </th>
                        <th>Lien </th> <!--TODO-->
                        <!--
                        <th> Action </th>
                    </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-document let-idx="rowIndex">
                        <tr>
                            <td>{{document.path}}</td>
                            <td>
                                <a (click)="downloadFile(idx,ticket)">Télécharger le document</a>
                            </td>
                            <td>
                                <i pTooltip="Supprimer le document" tooltipPosition="bottom" class="pi pi-trash mr-2"
                                    aria-hidden="true" (click)="deleteFile(idx,ticket)"> </i>
                            </td>
                        </tr>
                    </ng-template>
                    </p-table>
                    </td>
                    </tr>
                    <tr>
                        <td colspan="10">
                            <h5>Documents du service</h5>
                            <p-table dataKey="_id" [value]="ticket.documents_service" class="col-12"
                                styleClass="p-datatable-gridlines">
                                <ng-template pTemplate="header">
                    <tr>
                        <th> Nom </th>
                        <th>Lien </th> <!--TODO-->
                     <!--   <th> Action </th>
                    </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-document let-idx="rowIndex">
                        <tr>
                            <td>{{document.path}}</td>
                            <td>
                                <a (click)="downloadFileService(idx,ticket)">Télécharger le document</a>
                            </td>
                            <td>
                                <i pTooltip="Supprimer le document" tooltipPosition="bottom" class="pi pi-trash mr-2"
                                    aria-hidden="true" (click)="deleteFileService(idx,ticket)"> </i>
                            </td>
                        </tr>
                    </ng-template>
                    </p-table>
                    </td>
                    </tr>

                    </ng-template>
                    </p-table>
                </p-tabPanel>

                <p-tabPanel header="Mes documents" *ngIf="user">

                    <p-table [value]="user.documents_rh" dataKey="_id" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Date de délivrance</th>
                                <th>Nom du document</th>
                                <th>Lien de téléchargement</th>
                                <th>Note</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-rowData>
                            <tr>
                                <td>{{rowData?.date | date:'mediumDate'}}</td>
                                <td>{{rowData?.filename}}</td>
                                <td>
                                    <a style="cursor: pointer;" (click)="downloadRHFile(rowData)">Télécharger</a>
                                </td>
                                <td>{{rowData?.note}}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="4">Vous n'avez aucun document pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="4">Chargement de vos documents, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>-->

         <!--     <!----> <!--<p-tabPanel header="Demande de congé / autorisation" id="departAnticipe">*
                    <!-- formulaire de modification d'une demande de congé -->
          <!--         <div *ngIf="showUpdateCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showUpdateCongeForm = false; showOtherTextArea = false"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Modifier une demande de congé</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formUpdateConge"
                            (ngSubmit)="onUpdateConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="type du congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>

                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formUpdateConge.invalid"></button>
                        </form>
                    </div>

                    <!-- formulaire de demande de congé -->
             <!--       <div *ngIf="showAddCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showAddCongeForm = false; showOtherTextArea = false;"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Nouvelle demande de congé</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formAddConge" (ngSubmit)="onAskConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="Choisissez un type de congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true" (onInput)="onCalcNumberDay()"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>
                            <div class="field col-12">
                                <input type="file" pInputText (change)="onSelectFile($event)" accept="application/pdf">
                            </div>

                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formAddConge.invalid"></button>
                        </form>
                    </div>

                    <button pButton pRipple label="Nouvelle demande" style="float: right;"
                        class="p-button-outlined mb-2" (click)="showAddCongeForm = true"></button>
                    <div style="clear: both"></div>
                    <p-table [value]="conges" [expandedRowKeys]="expandedRows" dataKey="_id" [rows]="4"
                        [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
                        responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Date de la demande</th>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Nombre de jours</th>
                                <th>Justificatif</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-conge let-expanded="expanded">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="conge"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <td>{{conge._id.substring(conge._id.length-6, conge._id.length)}}</td>
                                <td>{{conge.date_demande | date: 'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.type_conge == 'Autre motif'">{{ conge.other_motif}}</td>
                                <td *ngIf="conge.type_conge != 'Autre motif'">{{ conge.type_conge}}</td>

                                <td>du {{conge.date_debut | date: 'd/MM/YYYY'}} <br> au {{conge.date_fin | date:
                                    'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.nombre_jours > 1">{{conge.nombre_jours}} jours</td>
                                <td *ngIf="conge.nombre_jours <= 1">{{conge.nombre_jours}} jour</td>

                                <td *ngIf="conge.justificatif == null">--</td>
                                <td *ngIf="conge.justificatif != null">
                                    <i class="pi pi-file" pTooltip="Télécharger le justificatif"
                                        (click)="onDonwloadJustificatif(conge._id)"
                                        style="cursor: pointer; font-size: 20px; color: rgba(0, 0, 0, 0.622)"></i>
                                </td>

                                <td>
                                    <span *ngIf="conge.statut == 'En attente'"><p-tag icon="pi pi-spin pi-spinner"
                                            severity="warning" value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Refusé'"><p-tag icon="pi pi-times" severity="danger"
                                            value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Validé'"><p-tag icon="pi pi-check" severity="success"
                                            value={{conge.statut}}></p-tag></span>
                                </td>
                                <td>
                                    <button pButton pRipple icon="pi pi-pencil" pTooltip="Mettre à jour la demande"
                                        (click)="onPachCongeData(conge)"
                                        class="p-button-primary p-button-rounded p-button-outlined mb-2"></button>
                                    <button pButton pRipple pTooltip="Supprimer la demande" icon="pi pi-trash"
                                        (click)="onDeleteConge(conge._id)"
                                        class="p-button-danger p-button-rounded p-button-outlined ml-2 mb-2"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-conge>
                            <tr>
                                <td colspan="9">
                                    <div class="p-3">
                                        <p-table responsiveLayout="scroll">
                                            <ng-template pTemplate="header">
                            <tr>
                                <th>Motif</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td>{{conge.motif}}</td>
                            </tr>
                        </ng-template>
                    </p-table>
        </div>

        <div class="p-3">
            <p-table responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Note decideur</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{conge.note_decideur}}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        </td>
        </tr>
        </ng-template>
        </p-table>
        </p-tabPanel>

       <!-- <p-tabPanel header="Historique de pointage et CRA">
            <!-- affichage du CRA d'un historique de pointage -->
        <!--   <i class="pi pi-times-circle" style="color: red; font-size: 20px; cursor: pointer; float: right;"
                *ngIf="showDailySelectedCra" (click)="showDailySelectedCra = false"></i>
            <div style="clear: both;"></div>

            <p-table *ngIf="showDailySelectedCra" [value]="historiqueCraSelected.cra" dataKey="_id" [rows]="4"
                [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Cra du {{historiqueCraSelected.today}}</th>
                    </tr>
                    <tr>
                        <th>Durée</th>
                        <th>Tâche</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-cra>
                    <tr>
                        <td>{{cra.number_minutes}}mn</td>
                        <td>{{cra.task}}</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="2">Vous n'avez aucun CRA enregistré pour le jour sélectionné.</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="loadingbody">
                    <tr>
                        <td colspan="2">Chargement de votre CRA, merci de patienter...</td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- affichage de l'historique de pointage -->
         <!--   <h5 class="mt-5">Historique de pointage et CRA</h5>
            <div class="m-2">
                <label htmlFor="">Choisissez un mois et une année</label> <br>
                <input pInputText type="month" (input)="getHistoPointage($event.target.value)">
            </div>
            <p-table [value]="historiqueCra" dataKey="_id" [rows]="4" [rowHover]="true"
                styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Date</th>
                        <th>Heure Check in Online</th>
                        <th>Heure Check in Pointeuse</th>
                        <th>Heure Check out Online</th>
                        <th>Heure Check out Pointeuse</th>
                        <th>Heures pauses</th>
                        <th>Taux CRA</th>
                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-cra>
                    <tr>
                        <td>{{cra.today}}</td>
                        <td>{{cra.check_in | date:'H:mm'}}</td>
                        <td>WIP</td>
                        <td>{{cra.check_out | date:'H:mm'}}</td>
                        <td>WIP</td>
                        <td *ngIf="cra.pause_timing">
                            <ul>
                                <li *ngFor="let pause of cra.pause; let i = index">
                                    de {{ pause.in | date:'H:mm' }} à {{ pause.out | date:'H:mm' }}
                                </li>
                            </ul>
                            <br>Total: {{ cra.pause_timing }}mn
                        </td>
                        <td *ngIf="!cra.pause_timing">
                            0mn
                        </td>
                        <td>{{ cra.taux_cra }}%</td>
                        <td>
                            <button pButton pRipple label="Afficher CRA" class="p-button-success p-button-outlined mb-2"
                                (click)="historiqueCraSelected = cra; showDailySelectedCra = true"></button>
                            <button pButton pRipple label="Afficher Pointeuse"
                                class="p-button-success p-button-outlined mb-2" (click)="onSeePointeuse()"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8">Vous n'avez aucun pointage enregistré pour le moment.</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="loadingbody">
                    <tr>
                        <td colspan="8">Chargement de votre historique, merci de patienter...</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabPanel>-->
        <p-tabPanel header="Calendrier">
            <p-fullCalendar #calendar [events]="eventsRH" [options]="optionsRH">
            </p-fullCalendar>
            <p-dialog class="grid" header="Détails de l'événement" [(visible)]="displayData" [modal]="true"
                [style]="{width: '75vw'}">
                <div class="col-12 grid">
                    <div class="col-12">
                        <p>
                            {{dataEvent?.note}}
                        </p>
                    </div>
                </div>
            </p-dialog>
        </p-tabPanel>
        <!--<p-tabPanel header="Mes favoris">
            <div class="card" *ngIf="showForm">
                <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
                    (click)="showForm=false;addLinkForm.reset()" aria-hidden="true"> </i>
                <h4 style="text-align: center;">Ajouter un lien</h4>
                <div style="text-align: center;">
                    <small>Tous les champs marqués d'un astérisque <span style="color: red;"> * </span> sont
                        obligatoires</small><br>
                </div>
                <br>
                <form class="p-fluid p-formgrid grid" [formGroup]="addLinkForm" (ngSubmit)="saveLink()">
                    <div class="field col-12 md:col-6">
                        <label for="libelle">Libellé <span style="color: red;"> * </span></label>
                        <input pInputText id="libelle" type="text" formControlName="libelle" placeholder="Google" />
                    </div>
                    <div class="field col-12 md:col-6">
                        <label for="link">Lien <span style="color: red;"> * </span></label>
                        <input pInputText id="link" type="text" formControlName="link" placeholder="google.fr" />
                    </div>
                    <div style="justify-content: right;">
                        <button pButton label="Ajouter" type="submit" [disabled]="addLinkForm.invalid"></button>
                    </div>
                </form>
            </div>
            <div class="card">
                <button (click)="showForm=true;addLinkForm.reset()" pButton icon="pi pi-plus"
                    label="Ajouter un nouveau lien" style="width:auto;float:right"></button>
                <div class="grid" *ngIf="dashboard">
                    <div class="field col-12 md:col-3 grid" *ngFor="let link of dashboard.links; let i = index">
                        <a class="col-11" href="{{link.link}}" target="_blank">{{link.label}}</a>
                        <i class="col-1 pi pi-trash"
                            style="font-size: 20px; color: red; cursor: pointer; margin-left: 1%;"
                            (click)="deleteLink(i)" aria-hidden="true"> </i>
                    </div>
                </div>
            </div>
        </p-tabPanel>-->
        </p-tabView>
    </div>

</div>

</div>




<div class="grid" *ngIf="isEtudiant && dataEtudiant && !isVisitor">
    <h1 *ngIf="user && dataEtudiant">Bienvenue {{user.firstname | titlecase}} {{user.lastname | uppercase}}
        N°{{dataEtudiant?.custom_id}}
    </h1>
    <p *ngIf="dataEtudiant && dataEtudiant?.statut_dossier?.includes('Document Manquant') || dataEtudiant?.statut_dossier?.includes('Paiement non finalisé')"
        style="color:red;">Votre
        dossier n'est pas complet, il manque des documents ou votre statut n'est pas régularisé, veuillez contacter
        l'administration via Ticketing
    </p>


    <div class="col-12 card"
        *ngIf="dataEtudiant.lien_livret.read || dataEtudiant.lien_dossier_professionel ||dataEtudiant.lien_tableau_synthese || dataEtudiant.lien_bulletin['Semestre 1'] || dataEtudiant.lien_bulletin['Semestre 2'] || dataEtudiant.lien_bulletin['Annuel'] || dataEtudiant.lien_attestation || (dataEtudiant.classe_id && (dataEtudiant.classe_id.lien_programme || dataEtudiant.classe_id.lien_calendrier))">
        <!-- *ngIf="!dataEtudiant?.statut_dossier?.includes('Paiement non finalisé')" -->
        <div class="grid"
            *ngIf="dataEtudiant.lien_livret.read || dataEtudiant.lien_dossier_professionel ||dataEtudiant.lien_tableau_synthese">
            <h4 class="col-12">Documents</h4>
            <div class="card col-6" *ngIf="dataEtudiant.lien_livret.read">
                <h5>Livret</h5>
                <a href="{{dataEtudiant.lien_livret.read}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-3" *ngIf="dataEtudiant.lien_dossier_professionel">
                <h5 class="col-12">Dossier professionel</h5>
                <a href="{{dataEtudiant.lien_dossier_professionel}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-3" *ngIf="dataEtudiant.lien_tableau_synthese">
                <h5>Tableau synthèse</h5>
                <a href="{{dataEtudiant.lien_tableau_synthese}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
        </div>
        <div class="grid"
            *ngIf="dataEtudiant.lien_bulletin['Semestre 1'] || dataEtudiant.lien_bulletin['Semestre 2'] || dataEtudiant.lien_bulletin['Annuel']">
            <h4 class="col-12">Bulletin</h4>
            <div class="card col-3" *ngIf="dataEtudiant.lien_bulletin['Semestre 1'] && paimentS1">
                <h5>Semestre 1</h5>
                <a href="{{dataEtudiant.lien_bulletin['Semestre 1']}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-6" *ngIf="!paimentS1 && dataEtudiant.lien_bulletin['Semestre 1']">
                <h5>Semestre 1</h5>
                <p>Vous n'avez pas régularisé votre 1er semestre, merci de contacter l'administration ou de vous rendre
                    au
                    campus du Louvre.</p>
            </div>
            <div class="card col-3" *ngIf="dataEtudiant.lien_bulletin['Semestre 2'] && paimentAn">
                <h5>Semestre 2</h5>
                <a href="{{dataEtudiant.lien_bulletin['Semestre 2']}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-6" *ngIf="!paimentAn && dataEtudiant.lien_bulletin['Semestre 2']">
                <h5>Semestre 2</h5>
                <p>Vous n'avez pas régularisé votre 2ème semestre, merci de contacter l'administration ou de vous rendre
                    au
                    campus du Louvre.</p>
            </div>
            <div class="card col-6" *ngIf="dataEtudiant.lien_bulletin['Annuel'] && paimentAn">
                <h5>Annuel</h5>
                <a href="{{dataEtudiant.lien_bulletin['Annuel']}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-6" *ngIf="!paimentAn && dataEtudiant.lien_bulletin['Annuel']">
                <h5>Annuel</h5>
                <p>Vous n'avez pas régularisé votre année, merci de contacter l'administration ou de vous rendre au
                    campus du Louvre.</p>
            </div>
        </div>
        <div class="grid" *ngIf="dataEtudiant.lien_attestation">
            <div class="card col-12" *ngIf="dataEtudiant.lien_attestation">
                <h5>Attestation</h5>
                <a href="{{dataEtudiant.lien_attestation}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
        </div>
        <div class="grid"
            *ngIf="dataEtudiant.classe_id && (dataEtudiant.classe_id.lien_programme || dataEtudiant.classe_id.lien_calendrier)">
            <h4 class="col-12">Documents de Formation</h4>
            <div class="card col-6" *ngIf="dataEtudiant.classe_id.lien_programme">
                <h5>Programme</h5>
                <a href="{{dataEtudiant.classe_id.lien_programme}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
            <div class="card col-6" *ngIf="dataEtudiant.classe_id.lien_calendrier">
                <h5>Calendrier</h5>
                <a href="{{dataEtudiant.classe_id.lien_calendrier}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6">
        <div class="card">
            <div class="col-12 flex justify-content-center flex-wrap card-container">
                <div>
                    <h4 class="col-12">Planning journée</h4>
                </div>

                <div class="col-12" *ngIf="type==null">
                    <p-fullCalendar #calendar [events]="events" class="col-12 md:col-8" [options]="optionsetu">
                    </p-fullCalendar>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6">
        <div class="card" *ngIf="dernotes">
            <h5>Dernières notes obtenues</h5>
            <p-table [value]="dernotes">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="matiere_id.nom">Matière <p-sortIcon field="matiere_id.nom"></p-sortIcon>
                        </th>
                        <th pSortableColumn="note">Note <p-sortIcon field="note_val"></p-sortIcon>
                        </th>

                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-note>
                    <tr>
                        <td style="width: 35%; min-width: 7rem;">{{note.matiere_id.nom }}</td>
                        <td style="width: 35%; min-width: 7rem;">{{ note.note_val }}</td>

                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <!--<div class="col-12">
        <div class="card">
            <h5>
                Besoin d'un logement ?
                Rendez-vous sur <a routerLink="/logements">IMS Booking</a>. Nous vous mettons à disposition des
                logements tout neufs et pas cher.
            </h5>

            <p-galleria [(value)]="carousselImages" [responsiveOptions]="responsiveOptions"
                [containerStyle]="{'max-width': '800px', 'margin':'auto'}" [numVisible]="5">
                <ng-template pTemplate="item" let-item>
                    <img [src]="item.previewImageSrc" style="width: 100%;" />
                </ng-template>
                <ng-template pTemplate="thumbnail" let-item>
                    <div class="grid grid-nogutter justify-content-center">
                        <img [src]="item.thumbnailImageSrc" style="width:100px; height:100px" />
                    </div>
                </ng-template>
            </p-galleria>
        </div>
    </div>-->

</div>

<div *ngIf="isFormateur">
    <h2 *ngIf="!isEtudiant" style="text-align: center;">Bienvenue {{user?.lastname | uppercase}} {{user?.firstname |
        titlecase}} </h2>

    <div class="col-12 card" *ngIf="dataFormateur">
        <div class="grid" *ngIf="dataFormateur.lien_sequentiel">
            <h4>Documents</h4>
            <div class="card col-12" *ngIf="dataFormateur.lien_sequentiel">
                <h5>Sequentiels</h5>
                <a href="{{dataFormateur.lien_sequentiel}}" target="_blank"><img style="max-height: 20vh;"
                        src="assets/images/word.png" /></a>
            </div>
        </div>
    </div>

    <!-- Afficher les cours de la journée-->
    <div class="col-12 md:col-12">
        <div class="card">
            <div class="col-12 flex justify-content-center flex-wrap card-container">
                <div>
                    <h4 class="col-12">Planning pour la journée d'aujourd'hui</h4>
                </div>

                <div class="col-12" *ngIf="type==null">
                    <p-fullCalendar #calendar [events]="events" class="col-12 md:col-8" [options]="optionsforma">
                    </p-fullCalendar>
                </div>
            </div>
        </div>
    </div>
</div>

<div *ngIf="isAdmission">
    <div class="grid">
        <div class="col-6 lg:col-6 xl:col-4">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-4">
                    <div>
                        <span class="block text-500 font-medium mb-4">Nombre total d'inscrits</span>
                        <div class="text-900 font-medium text-xl">{{numberTotalInscription}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-green-100 border-round"
                        [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-check-circle text-green-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 lg:col-6 xl:col-4">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-4">
                    <div>
                        <span class="block text-500 font-medium mb-4">Nombre de nouvelle inscrits </span>
                        <div class="text-900 font-medium text-xl">{{numberNewStudentInscription}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-cyan-100 border-round"
                        [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-id-card text-cyan-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 lg:col-6 xl:col-4">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-4">
                    <div>
                        <span class="block text-500 font-medium mb-4">Nombre d'etudiant en attente</span>
                        <div class="text-900 font-medium text-xl">{{numberStudentWaiting}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-orange-100 border-round"
                        [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-clock text-orange-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div *ngIf="isPedagogie">

    <!--<div class="card">
        <div class="col-8 col-offset-2 flex justify-content-center flex-wrap card-container">
            <img src="assets\images\construction.jpg" style="width: 40%;">
        </div>
        <p>Le tableau de bord de la pédagogie est actuellement en construction pour votre statut!</p>
        <p>Pour naviguer sur l'application, merci d'utiliser le menu à gauche.</p>
        <p>Si vous rencontrez le moindre problème, nous vous invitons à créer un ticket dans la partie <span
                style="color: red; font-weight: bold;">"Ticketing"</span> dans le menu</p>
        <p>Merci de votre patience!</p>
    </div>-->
    <!-- Afficher un calendrier de taches (TODO)-->
    <!-- Afficher le nombre total de réinscription en attente -->
    <!-- Afficher le nombre total d'étudiants dans les filières Informatique, Commercial et Tertiaire -->
    <!-- Afficher l'emploi du temps de la journée dans les filières Informatique, Commercial et Tertiaire -->
</div>

<div *ngIf="isCommercial && !CommercialExterne">

    <!--<div class="card">
        <div class="col-8 col-offset-2 flex justify-content-center flex-wrap card-container">
            <img src="assets\images\construction.jpg" style="width: 40%;">
        </div>
        <p>Le tableau de bord des commerciaux est actuellement en construction pour votre statut!</p>
        <p>Pour naviguer sur l'application, merci d'utiliser le menu à gauche.</p>
        <p>Si vous rencontrez le moindre problème, nous vous invitons à créer un ticket dans la partie <span
                style="color: red; font-weight: bold;">"Ticketing"</span> dans le menu</p>
        <p>Merci de votre patience!</p>
    </div>-->
    <!-- Afficher le nombre total de ces prospects avec leur code -->
    <!-- Afficher le nombre total d'étudiants avec leur code -->
</div>

<div *ngIf="isCommercial && CommercialExterne && CommercialExterne.statut=='Admin'">

    <div class="col-12">
        <h1 class="text-center" *ngIf="PartenaireInfo">Bonjour notre cher partenaire {{PartenaireInfo.nom}}</h1>
        <div class="card">
            <p-fieldset legend="Information Entreprise">
                <div class="grid" style="color: black;font-weight:normal" *ngIf="!editInfoCommercial">
                    <div class="col-12 md:col-3">
                        <a (click)="clickFile()" pTooltip="Modifier la photo de profil" tooltipPosition="bottom"
                            style="cursor: pointer;"><img [src]="imageToShow" alt="Profil" width="150" height="150"
                                style="border-radius: 50px;" /></a>
                    </div>
                    <div class="col-12 md:col-6 grid">
                        <p class="col-12 md:col-6 text-center"><strong>Téléphone:</strong><br>
                            {{PartenaireInfo?.indicatifPhone}} {{PartenaireInfo?.phone}}</p>
                        <p class="col-12 md:col-6 text-center"><strong>WhatsApp:</strong><br>
                            {{PartenaireInfo?.indicatifWhatsapp}} {{PartenaireInfo?.WhatsApp}}
                        </p>
                        <p class="col-12 md:col-6 text-center"><strong>Site Web:</strong><br>
                            {{PartenaireInfo?.site_web}}</p>
                        <p class="col-12 md:col-6 text-center"><strong>Facebook:</strong><br>
                            {{PartenaireInfo?.facebook}}
                        </p>
                        <p class="col-12 md:col-12 text-center"><strong>Pays:</strong><br>
                            {{PartenaireInfo?.Pays}}</p>
                        <p class="col-12 md:col-12 text-center"><strong>Services:</strong><br>
                            {{PartenaireInfo?.Services}}
                        </p>

                        <p class="col-12 md:col-12 text-center"><strong>Description:</strong><br>
                            {{PartenaireInfo?.description}}
                        </p>
                    </div>
                    <div class="col-12 md:col-3">
                        <p style="cursor: pointer;"><a (click)="initEditCommercialForm()">Modifier les informations</a>
                        </p>
                    </div>
                </div>
                <div class="grid" style="color: black;font-weight:normal" *ngIf="editInfoCommercial">
                    <form class="col-12 grid" [formGroup]="editInfoCommercialForm">
                        <div class="col-12 md:col-3">
                            <a (click)="clickFile()" pTooltip="Modifier la photo de profil" tooltipPosition="bottom"
                                style="cursor: pointer;"><img [src]="imageToShow" alt="Profil" width="150" height="150"
                                    style="border-radius: 50px;" /></a>
                        </div>
                        <div class="col-12 md:col-6 grid">
                            <p class="col-12 md:col-6 text-center"><strong>Téléphone:</strong><br>
                                <input type="text" pInputText placeholder="+33" formControlName="indicatifPhone" /><br>
                                <input type="text" pInputText placeholder="0612345678" formControlName="phone" />
                            </p>
                            <p class="col-12 md:col-6 text-center"><strong>WhatsApp:</strong><br>
                                <input type="text" pInputText placeholder="+33"
                                    formControlName="indicatifWhatsapp" /><br>
                                <input type="text" pInputText placeholder="0612345678" formControlName="WhatsApp" />
                            </p>
                            <p class="col-12 md:col-6 text-center"><strong>Site Web:</strong><br>
                                <input type="text" pInputText placeholder="https://www.example.com"
                                    formControlName="site_web" />
                            </p>
                            <p class="col-12 md:col-6 text-center"><strong>Facebook:</strong><br>
                                <input type="text" pInputText placeholder="https://www.example.com"
                                    formControlName="facebook" />
                            </p>
                            <p class="col-12 md:col-12 text-center"><strong>Pays:</strong><br>
                                <p-multiSelect formControlName="Pays" [options]="paysList" placeholder="Pays"
                                    optionLabel="value" optionValue="value" emptyFilterMessage="Pas de pays trouvé"
                                    filterPlaceholder="Pays" filter="true" optionDisabled="actif"></p-multiSelect>
                            </p>
                            <p class="col-12 md:col-12 text-center"><strong>Services:</strong><br>
                                <input type="text" pInputText placeholder="https://www.example.com"
                                    formControlName="Services" />
                            </p>

                            <p class="col-12 md:col-12 text-center"><strong>Description:</strong><br>
                                <textarea pInputTextarea formControlName="description" placeholder=""></textarea>
                            </p>
                        </div>
                        <div class="col-12 md:col-3">
                            <p style="cursor: pointer;"><a (click)="saveEditCommercialInfo()">Enregistrer les
                                    informations</a></p>
                        </div>
                    </form>
                </div>
            </p-fieldset><br>
            <p-fieldset legend="Information du partenariat">
                <div class="grid" style="color: black;font-weight:normal">
                    <div class="col-12 grid">
                        <p class="col-12 md:col-6 text-center"><strong>Ancienneté:</strong><br>
                            {{PartenaireInfo?.statut_anciennete}}</p>
                        <p class="col-12 md:col-4 text-center"><strong>Contribution:</strong><br>
                            {{PartenaireInfo?.contribution}}
                        </p>
                        <p class="col-12 md:col-6 text-center"><strong>Etat de contrat:</strong><br>
                            {{PartenaireInfo?.etat_contrat}}</p>
                        <div class="col-12 md:col-6 text-center">
                            <button pButton class="mr-2" label="Télécharger le contrat" type="button"
                                [disabled]="!PartenaireInfo?.pathEtatContrat" (click)="downloadContrat()"></button>
                        </div>
                    </div>
                </div>
            </p-fieldset><br>
            <p-fieldset legend="Commissions" *ngIf="PartenaireInfo && PartenaireInfo.commissions">
                <p-table [value]="PartenaireInfo.commissions">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Description</th>
                            <th>Montant</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-co>
                        <tr>
                            <td>{{co.description}}</td>
                            <td>{{co.montant}}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-fieldset>
        </div>
    </div>
</div>

<div *ngIf="isReinscrit">
    <div class="card">
        <div class="col-8 col-offset-2 flex justify-content-center flex-wrap card-container">
            <img src="assets\images\validation_dossier.jpg" style="max-width: 60%;">
        </div>
        <h2>Votre demande de reinscription est en cours de traitement.</h2>
        <h3 *ngIf="dataEtudiant && !dataEtudiant.valided_by_admin">Le statut de votre dossier est: En attente de la
            validation par
            l'administration. <a href="mailto:m.hue@intedgroup.com">Merci de contacté m.hue@intedgroup.com</a></h3>
        <h3 *ngIf="dataEtudiant && dataEtudiant.valided_by_admin">Le statut de votre dossier est: En attente de
            l'assignation au groupe
            scolaire par la pédagogie.</h3>
    </div>
</div>


<div *ngIf="isCEO">
    <h2 *ngIf="user" style="text-align: center;">
        Bonjour {{user.firstname | titlecase}} {{user.lastname | uppercase}}, Bienvenue sur votre espace entreprise
    </h2>
</div>

<div *ngIf="isIntuns">
    <div class="card grid">
        <div class="col-3 flex flex-column align-items-center justify-content-center">
            <a href="https://www.lms.intuns.com/login/index.php">
                <img src="assets\images\livre_intuns.jpg" style="max-height: 200px;" />
            </a>
            <a href="https://www.lms.intuns.com/login/index.php">
                Supports de cours
            </a>
        </div>
        <p-divider class="col-1" layout="vertical">
        </p-divider>
        <div class="col-4 flex  flex-column align-items-center justify-content-center">
            <a href="{{dataIntuns?.formation_id?.linkedin}}">
                <img src="assets\images\linkedin-logo.png" style="max-height: 200px;" />
            </a>
            <a href="{{dataIntuns?.formation_id?.linkedin}}">
                Linked Learning
            </a>
        </div>
        <p-divider class="col-1" layout="vertical">
        </p-divider>
        <div class="col-3 flex  flex-column align-items-center justify-content-center">
            <a (click)="navigateToEmployabilite()">
                <img src="assets\images\emploi.jpg" style="max-height: 200px;" />
            </a>
            <a (click)="navigateToEmployabilite()">
                Employabilité et Alternance
            </a>
        </div>
    </div>
</div>


<div *ngIf="!isEtudiant && !isAdmin &&!isProspect && !isCEO">
    <div class="col-12">
        <!-- info user -->
        

        <!-- Tabs avec les cra etc -->
        <div class="card">
            <p-tabView [(activeIndex)]="selectedTabIndex">
                <p-tabPanel header="CRA">
                    <div class="card">
                        <div class="grid">
                            <div class="col-6 md:col-3">
                                <button pButton pRipple (click)="onCheckIn()" label="Check in" class="p-button-primary mb-2"
                                    [disabled]="dailyCheck != null"></button> <br>
                                <span *ngIf="!dailyCheck?.isInPause"><button pButton pRipple (click)="onPause()" label="Pause"
                                        class="p-button-warning mb-2"
                                        [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button> <br></span>
                                <span *ngIf="dailyCheck?.isInPause"><button pButton pRipple (click)="onStopPause()"
                                        label="Fin de la pause" class="p-button-warning mb-2"
                                        [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button> <br></span>
                                <a href="#departAnticipe" (click)="selectedTabIndex = 5;onUpdateStatus('Absent')"
                                    *ngIf="dailyCheck != null && dailyCheck.check_out == null"><button pButton pRipple
                                        label="Départ anticipé" class="p-button-help mb-2"></button></a> <br
                                    *ngIf="dailyCheck != null && dailyCheck.check_out == null">
                                <button pButton pRipple label="Check out" (click)="onCheckOut()" class="p-button-danger"
                                    [disabled]="dailyCheck == null || dailyCheck.check_out != null"></button>
                            </div>
                            <div class="col-6 md:col-3">
                                <h5>Heure de check In </h5>
                                <h6><strong>Online</strong>{{dailyCheck?.check_in | date: 'HH:mm'}} </h6>
                                <h6><strong>Pointeuse</strong>En dévéloppement </h6>
                                <h6>Temps passé au <br> travail:
                                    <strong>{{workingHour}}</strong>h<strong>{{workingMinute}}</strong>mn
                                </h6>
                                <h6>Temps passé en <br> pause: <strong>{{pauseTiming}}</strong>mn</h6>
                                <h6>Taux de remplissage du <br> CRA: <strong>{{craPercent}}%</strong></h6>
                            </div>
                            <div class="col-6 md:col-3 flex align-items-center justify-content-center">
                                <h5 style="text-align: center;">
                                    Statut actuel <span pTooltip="Modifier le statut" (click)="showFormUpdateStatut = true"><i
                                            class="pi pi-pencil" style="color: #4338CA"></i></span><br>
                                    <!-- formulaire pour mettre à jour le statut de l'utilisateur -->
                                    <div *ngIf="showFormUpdateStatut">
                                        <hr>
                                        <form [formGroup]="formUpdateStatut" class="p-fluid p-formgrid"
                                            (ngSubmit)="onUpdateStatus()">
                                            <div class="field">
                                                <label htmlFor="statut">Mettre à jour votre statut</label>
                                                <p-dropdown [options]="statutList" placeholder="Sélectionnez votre nouveau statut"
                                                    [showClear]="true" formControlName="statut"></p-dropdown>
                                            </div>
                                            <div class="field">
                                                <button pButton type="submit" label="Valider" class="p-button-outlined"></button>
                                            </div>
                                        </form>
                                        <hr>
                                    </div>
                                    <!-- end dialogue -->
                                    <span style="color: green; font-weight: bolder;">{{userConnected?.statut}}</span>
                                </h5>
            
                            </div>
                            <div class="col-6 md:col-3" style="text-align: center">
                                <img [src]="imageToShow" alt="Profil" width="150" height="150" style="border-radius: 50px;" />
                                <!--<h6 style="font-style: italic;">{{userConnected?.mention}}</h6>-->
                                <h6 *ngIf="userConnected?.service_id">Service: <i>{{userConnected?.service_id?.label}}</i></h6>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="showFormAddCra">
                        <div class="add-button-div mb-2">
                            <i class="pi pi-times-circle" pTooltip="Fermer" (click)="showFormAddCra = false;"
                                style="color: red; font-size: 20px; float: right; cursor: pointer;"></i>
                        </div>
                        <div style="clear: both;"></div>

                        <form class="p-fluid" [formGroup]="formAddCra" (ngSubmit)="onAddCra()">
                            <div formArrayName="cras"
                                *ngFor="let cra of getCras().controls; let i = index; let c = count">
                                <div class="p-formgrid grid" [formGroupName]="i">
                                    <div class="field col-12 md:col-5">
                                        <input pInputText type="text" id="tache" formControlName="tache"
                                            placeholder="Veuillez décrire la tâche">
                                    </div>
                                    <div class="field col-12 md:col-5">
                                        <input pInputText type="number" id="duration" formControlName="duration"
                                            placeholder="Durée en minute">
                                    </div>
                                    <div class="field col-12 md:col-2" *ngIf="c > 1">
                                        <button pButton pRipple pTooltip="Supprimer la ligne" type="button"
                                            icon="pi pi-trash" class="p-button-outlined p-button-danger mb-2"
                                            (click)="onDeleteCraField()"></button>
                                    </div>
                                </div>
                            </div>
                            <button pButton pRipple type="button" icon="pi pi-plus"
                                class="p-button-outlined p-button-success mb-2" (click)="onAddCraField()"></button>

                            <div class="col-2">
                                <button pButton pRipple type="submit" label="Ajouter" class="p-button-primary mb-2"
                                    [disabled]="formAddCra.invalid"></button>
                            </div>
                        </form>
                    </div>

                    <button pButton pRipple label="Ajouter" class="p-button-primary p-button-outlined mb-2"
                        style="float: right;" (click)="showFormAddCra = true;"
                        *ngIf="dailyCheck != null && !showFormAddCra"></button>
                    <div style="clear: both;"></div>
                    <p-table [value]="dailyCheck?.cra" dataKey="_id" editMode="row" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Durée</th>
                                <th>Tâche</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-cra let-editing="editing" let-ri="rowIndex">
                            <tr [pEditableRow]="cra">
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="number" [(ngModel)]="cra.number_minutes">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.number_minutes}} mn
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="text" [(ngModel)]="cra.task">
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{cra.task}}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                                        icon="pi pi-pencil" (click)="onRowEditInit(cra)"
                                        class="p-button-rounded p-button-text"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow
                                        icon="pi pi-check" (click)="onRowEditSave(cra)"
                                        class="p-button-rounded p-button-text p-button-success mr-2"></button>
                                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow
                                        icon="pi pi-times" (click)="onRowEditCancel(cra, ri)"
                                        class="p-button-rounded p-button-text p-button-danger"></button>
                                    <button pButton pRipple type="button" icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="onDeleteCra(cra._id)"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3">Aucun CRA pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="3">Chargement des CRA, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>
                <p-tabPanel header="Actualités">
                    <p-table [value]="actualites" dataKey="_id" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Date</th>
                                <th>Titre de l'actualité</th>
                                <th>Contenu de l'actualité</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-actualite>
                            <tr>
                                <td>
                                    {{actualite?.date_creation | date :'medium' }}
                                </td>
                                <td>
                                    {{actualite?.titre}}
                                </td>
                                <td>
                                    {{actualite?.description}}
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3">Aucune information pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="3">Chargement des informations, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>

                

                <p-tabPanel header="Suivre mon assiduité">
                    <div class="grid">
                        <div class="col-6">
                            <div>
                                <label htmlFor="">Choisissez un mois et une année</label> <br>
                                <input pInputText type="month"
                                    (input)="dateChoose=$event.target.value;OnCalcAssiduite()">
                            </div>
                            <h6>Nombre de jours de congés payés: <strong>{{stats.conges_pay}} jrs</strong></h6>
                            <h6>Nombre de jours de congés sans solde: <strong>{{stats.conges_ss}} jrs</strong></h6>
                            <h6>Nombre de jours de congés maladie: <strong>{{stats.maladie}} jrs</strong></h6>
                            <h6>Nombre de jours en absences justifies: <strong>{{stats.absence_justifie}} jrs</strong>
                            </h6>
                            <h6>Nombre de jours en absences non justifies:
                                <strong>{{22-stats.assiduite-stats.absence_justifie-stats.maladie-stats.conges_ss-stats.conges_pay}}
                                    jrs</strong>
                            </h6>

                        </div>
                        <div class="col-6 flex justify-content-center align-items-center">
                            <h6>Taux d'assiduité: <strong>{{(stats.assiduite/22)*100 | number:'1.0-2'}} %</strong></h6>
                        </div>

                    </div>

                </p-tabPanel>

                <!--<p-tabPanel header="Mes demandes">
                    <button pButton pRipple label="Ajouter" class="p-button-primary p-button-outlined mb-2"
                        (click)="AddTicket()" style="float: right;"></button>
                    <div style="clear: both;"></div>
                    <p-table #dt1 dataKey="_id" [rows]="8" [rowHover]="true" [paginator]="true" [value]="tickets"
                        [paginator]="true" rowExpandMode="single" [pageLinks]="5" selectionMode="single" class="col-12"
                        [globalFilterFields]="['customid', 'prenom', 'nom','email']" responsiveLayout="scroll"
                        styleClass="p-datatable-gridlines">
                        <ng-template pTemplate="caption">
                            <div class="flex justify-content-between flex-column sm:flex-row">
                                <input pInputText type="text" #filter
                                    (input)="dt1.filterGlobal($event.target.value, 'contains')"
                                    placeholder="Recherche" />
                                <!-- <p-dropdown [style]="{'margin':'5px'}" [options]="filterPays" filter="true"
                                (onChange)="dt1.filter($event.value, 'pays_residence', 'equals');"
                                emptyFilterMessage="Pas de pays trouvé" filterPlaceholder="Choisissez un pays"></p-dropdown>
            
                            <p-dropdown [style]="{'margin':'5px'}" [options]="filterSource" filter="true"
                                (onChange)="dt1.filter($event.value, 'source', 'equals');" emptyFilterMessage="Pas de source trouvé"
                                filterPlaceholder="Choisissez une source"></p-dropdown>
            
                            <p-dropdown [style]="{'margin':'5px'}" [options]="filterOperation" filter="true"
                                (onChange)="dt1.filter($event.value, 'operation', 'equals');"
                                emptyFilterMessage="Pas d'opération trouvé"
                                filterPlaceholder="Choisissez une operation"></p-dropdown>-->
                            <!--</div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem"></th>
                                <th pSortableColumn="customid" style="text-align:center"> ID Ticket <p-sortIcon
                                        field="customid">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="date_ajout" style="text-align:center"> Date de création <p-sortIcon
                                        field="date_ajout">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="createur_id.lastname" style="text-align:center"> Crée par
                                    <p-sortIcon field="user_id">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="service" style="text-align:center"> Service <p-sortIcon
                                        field="service">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="sujet" style="text-align:center"> Sujet <p-sortIcon field="sujet">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="priorite" style="text-align:center"> Priorité <p-sortIcon
                                        field="priorite">
                                    </p-sortIcon>
                                </th>
                                <th pSortableColumn="statut" style="text-align:center"> Etat de traitement <p-sortIcon
                                        field="statut">
                                    </p-sortIcon>
                                </th>
                                <th style="text-align:center">
                                    Délai de traitement
                                </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-ticket let-expanded="expanded" let-ri="rowIndex">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="ticket"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
                                    </button>
                                </td>
                                <td>
                                    {{ticket.customid}}
                                </td>
                                <td>
                                    {{ticket.date_ajout | date:'mediumDate'}}
                                </td>
                                <td>
                                    {{ticket?.createur_id?.firstname | titlecase}} {{ticket?.createur_id?.lastname |
                                    uppercase}}
                                </td>
                                <td>
                                    {{ticket?.sujet_id?.service_id?.label}}
                                </td>
                                <td>
                                    {{ticket?.sujet_id?.label}}
                                </td>
                                <td>
                                    {{ticket.priorite}}
                                </td>
                                <td>
                                    <p-tag *ngIf="ticket.statut == null" icon="pi pi-times" severity="danger"
                                        [value]="'Aucun status définit'">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En attente de traitement'" icon="pi pi-eye-slash"
                                        severity="info" [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En cours de traitement'" icon="pi pi-eye"
                                        severity="warning" [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'En suspension'" icon="pi pi-pause" severity="danger"
                                        [value]="ticket.statut">
                                    </p-tag>
                                    <p-tag *ngIf="ticket.statut == 'Traité'" icon="pi pi-check-square"
                                        severity="success" [value]="ticket.statut">
                                    </p-tag>
                                </td>
                                <td>
                                    {{getDelaiTraitrement(ticket)}}
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-ticket>
                            <tr>
                                <td colspan="9">
                                    <p-table [value]="['']" class="col-12" styleClass="p-datatable-gridlines">
                                        <ng-template pTemplate="header">
                            <tr>
                                <th> Description </th>
                                <th> Date de traitement </th>
                                <th> Note du Service qui traite </th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body">
                            <tr>
                                <td>{{ticket.description}}</td>
                                <td>{{ticket.date_fin_traitement| date:'mediumDate'}}</td>
                                <td>{{ticket.note}}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                    </td>

                    </tr>

                    <tr>
                        <td colspan="10">
                            <h5>Documents</h5>
                            <p-table dataKey="_id" [value]="ticket.documents" class="col-12"
                                styleClass="p-datatable-gridlines">
                                <ng-template pTemplate="header">
                    <tr>
                        <th> Nom </th>
                        <th>Lien </th> <!--TODO-->
                       <!-- <th> Action </th>
                    </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-document let-idx="rowIndex">
                        <tr>
                            <td>{{document.path}}</td>
                            <td>
                                <a (click)="downloadFile(idx,ticket)">Télécharger le document</a>
                            </td>
                            <td>
                                <i pTooltip="Supprimer le document" tooltipPosition="bottom" class="pi pi-trash mr-2"
                                    aria-hidden="true" (click)="deleteFile(idx,ticket)"> </i>
                            </td>
                        </tr>
                    </ng-template>
                    </p-table>
                    </td>
                    </tr>
                    <tr>
                        <td colspan="10">
                            <h5>Documents du service</h5>
                            <p-table dataKey="_id" [value]="ticket.documents_service" class="col-12"
                                styleClass="p-datatable-gridlines">
                                <ng-template pTemplate="header">
                    <tr>
                        <th> Nom </th>
                        <th>Lien </th> <!--TODO-->
                       <!-- <th> Action </th>
                    </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-document let-idx="rowIndex">
                        <tr>
                            <td>{{document.path}}</td>
                            <td>
                                <a (click)="downloadFileService(idx,ticket)">Télécharger le document</a>
                            </td>
                            <td>
                                <i pTooltip="Supprimer le document" tooltipPosition="bottom" class="pi pi-trash mr-2"
                                    aria-hidden="true" (click)="deleteFileService(idx,ticket)"> </i>
                            </td>
                        </tr>
                    </ng-template>
                    </p-table>
                    </td>
                    </tr>

                    </ng-template>
                    </p-table>
                </p-tabPanel>

                <p-tabPanel header="Mes documents" *ngIf="user">

                    <p-table [value]="user.documents_rh" dataKey="_id" [rows]="4" [rowHover]="true"
                        styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Date de délivrance</th>
                                <th>Nom du document</th>
                                <th>Lien de téléchargement</th>
                                <th>Note</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-rowData>
                            <tr>
                                <td>{{rowData?.date | date:'mediumDate'}}</td>
                                <td>{{rowData?.filename}}</td>
                                <td>
                                    <a style="cursor: pointer;" (click)="downloadRHFile(rowData)">Télécharger</a>
                                </td>
                                <td>{{rowData?.note}}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="4">Vous n'avez aucun document pour le moment.</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="loadingbody">
                            <tr>
                                <td colspan="4">Chargement de vos documents, merci de patienter...</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </p-tabPanel>-->

                <p-tabPanel header="Demande de congé / autorisation" id="departAnticipe">*
                    <!-- formulaire de modification d'une demande de congé 
                    <div *ngIf="showUpdateCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showUpdateCongeForm = false; showOtherTextArea = false"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Modifier une demande de congé</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formUpdateConge"
                            (ngSubmit)="onUpdateConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="type du congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>

                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formUpdateConge.invalid"></button>
                        </form>
                    </div>

                    <!-- formulaire de demande de congé -->
                    <div *ngIf="showAddCongeForm">
                        <i class="pi pi-times-circle"
                            style="color: red; font-size: 20px; cursor: pointer; float: right;"
                            (click)="showAddCongeForm = false; showOtherTextArea = false;"></i>
                        <div style="float: right"></div>

                        <h3 class="text-center">Nouvelle demande de congé</h3>
                        <form class="p-formgrid grid p-fluid" [formGroup]="formAddConge" (ngSubmit)="onAskConge()">
                            <div class="field col-12">
                                <label>Type de congé <span style="color: red">*</span></label>
                                <p-dropdown formControlName="type" [options]="congeStatutList" filter="true"
                                    placeholder="Choisissez un type de congé" [showClear]="true"
                                    (onChange)="onShowOtherTextArea($event)"></p-dropdown>
                            </div>

                            <div class="field col-12" *ngIf="showOtherTextArea">
                                <label htmlFor="other"></label>
                                <textarea formControlName="other" pInputTextarea placeholder="Préciser le motif"
                                    autoResize rows="4" cols="30"></textarea>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label htmlFor="debut">Début <span style="color: red">*</span></label>
                                <p-calendar formControlName="debut" [showIcon]="true" (onInput)="onCalcNumberDay()"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"
                                    [showButtonBar]="true"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-6">
                                <label htmlFor="fin">Fin <span style="color: red">*</span></label>
                                <p-calendar formControlName="fin" [showIcon]="true" [showButtonBar]="true"
                                    (onBlur)="onCalcNumberDay()" (onSelect)="onCalcNumberDay()"></p-calendar>
                            </div>
                            <div class="field col-12 md:col-4">
                                <label htmlFor="nb_jour">Nombre de jours <span style="color: red">*</span></label>
                                <input formControlName="nb_jour" pInputText type="number" id="nb_jour">
                            </div>
                            <div class="field col-12 md:col-8">
                                <label htmlFor="motif">Motif de la demande <span style="color: red">*</span></label>
                                <textarea formControlName="motif" pInputTextarea
                                    placeholder="Merci de décrire les raisons de votre demande de congé" autoResize
                                    rows="4" cols="30"></textarea>
                            </div>
                            <div class="field col-12">
                                <input type="file" pInputText (change)="onSelectFile($event)" accept="application/pdf">
                            </div>

                            <button pButton pRipple type="submit" class="my-2" label="Envoyer"
                                [disabled]="formAddConge.invalid"></button>
                        </form>
                    </div>

                    <button pButton pRipple label="Nouvelle demande" style="float: right;"
                        class="p-button-outlined mb-2" (click)="showAddCongeForm = true"></button>
                    <div style="clear: both"></div>
                    <p-table [value]="conges" [expandedRowKeys]="expandedRows" dataKey="_id" [rows]="4"
                        [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true"
                        responsiveLayout="scroll">
                        <ng-template pTemplate="header">
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>Date de la demande</th>
                                <th>Type</th>
                                <th>Période</th>
                                <th>Nombre de jours</th>
                                <th>Justificatif</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-conge let-expanded="expanded">
                            <tr>
                                <td>
                                    <button type="button" pButton pRipple [pRowToggler]="conge"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <td>{{conge._id.substring(conge._id.length-6, conge._id.length)}}</td>
                                <td>{{conge.date_demande | date: 'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.type_conge == 'Autre motif'">{{ conge.other_motif}}</td>
                                <td *ngIf="conge.type_conge != 'Autre motif'">{{ conge.type_conge}}</td>

                                <td>du {{conge.date_debut | date: 'd/MM/YYYY'}} <br> au {{conge.date_fin | date:
                                    'd/MM/YYYY'}}</td>

                                <td *ngIf="conge.nombre_jours > 1">{{conge.nombre_jours}} jours</td>
                                <td *ngIf="conge.nombre_jours <= 1">{{conge.nombre_jours}} jour</td>

                                <td *ngIf="conge.justificatif == null">--</td>
                                <td *ngIf="conge.justificatif != null">
                                    <i class="pi pi-file" pTooltip="Télécharger le justificatif"
                                        (click)="onDonwloadJustificatif(conge._id)"
                                        style="cursor: pointer; font-size: 20px; color: rgba(0, 0, 0, 0.622)"></i>
                                </td>

                                <td>
                                    <span *ngIf="conge.statut == 'En attente'"><p-tag icon="pi pi-spin pi-spinner"
                                            severity="warning" value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Refusé'"><p-tag icon="pi pi-times" severity="danger"
                                            value={{conge.statut}}></p-tag></span>
                                    <span *ngIf="conge.statut == 'Validé'"><p-tag icon="pi pi-check" severity="success"
                                            value={{conge.statut}}></p-tag></span>
                                </td>
                                <td>
                                    <button pButton pRipple icon="pi pi-pencil" pTooltip="Mettre à jour la demande"
                                        (click)="onPachCongeData(conge)"
                                        class="p-button-primary p-button-rounded p-button-outlined mb-2"></button>
                                    <button pButton pRipple pTooltip="Supprimer la demande" icon="pi pi-trash"
                                        (click)="onDeleteConge(conge._id)"
                                        class="p-button-danger p-button-rounded p-button-outlined ml-2 mb-2"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="rowexpansion" let-conge>
                            <tr>
                                <td colspan="9">
                                    <div class="p-3">
                                        <p-table responsiveLayout="scroll">
                                            <ng-template pTemplate="header">
                            <tr>
                                <th>Motif</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td>{{conge.motif}}</td>
                            </tr>
                        </ng-template>
                    </p-table>
        </div>

        <div class="p-3">
            <p-table responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Note decideur</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td>{{conge.note_decideur}}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        </td>
        </tr>
        </ng-template>
        </p-table>
        </p-tabPanel>

        <p-tabPanel header="Historique de pointage et CRA">
            <!-- affichage du CRA d'un historique de pointage -->
            <i class="pi pi-times-circle" style="color: red; font-size: 20px; cursor: pointer; float: right;"
                *ngIf="showDailySelectedCra" (click)="showDailySelectedCra = false"></i>
            <div style="clear: both;"></div>

            <p-table *ngIf="showDailySelectedCra" [value]="historiqueCraSelected.cra" dataKey="_id" [rows]="4"
                [rowHover]="true" styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Cra du {{historiqueCraSelected.today}}</th>
                    </tr>
                    <tr>
                        <th>Durée</th>
                        <th>Tâche</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-cra>
                    <tr>
                        <td>{{cra.number_minutes}}mn</td>
                        <td>{{cra.task}}</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="2">Vous n'avez aucun CRA enregistré pour le jour sélectionné.</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="loadingbody">
                    <tr>
                        <td colspan="2">Chargement de votre CRA, merci de patienter...</td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- affichage de l'historique de pointage -->
            <h5 class="mt-5">Historique de pointage et CRA</h5>
            <div class="m-2">
                <label htmlFor="">Choisissez un mois et une année</label> <br>
                <input pInputText type="month" (input)="getHistoPointage($event.target.value)">
            </div>
            <p-table [value]="historiqueCra" dataKey="_id" [rows]="4" [rowHover]="true"
                styleClass="p-datatable-gridlines" [paginator]="true" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Date</th>
                        <th>Heure Check in Online</th>
                        <th>Heure Check in Pointeuse</th>
                        <th>Heure Check out Online</th>
                        <th>Heure Check out Pointeuse</th>
                        <th>Heures pauses</th>
                        <th>Taux CRA</th>
                        <th>Action</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-cra>
                    <tr>
                        <td>{{cra.today}}</td>
                        <td>{{cra.check_in | date:'H:mm'}}</td>
                        <td>En dévéloppement</td>
                        <td>{{cra.check_out | date:'H:mm'}}</td>
                        <td>En dévéloppement</td>
                        <td *ngIf="cra.pause_timing">
                            <ul>
                                <li *ngFor="let pause of cra.pause; let i = index">
                                    de {{ pause.in | date:'H:mm' }} à {{ pause.out | date:'H:mm' }}
                                </li>
                            </ul>
                            <br>Total: {{ cra.pause_timing }}mn
                        </td>
                        <td *ngIf="!cra.pause_timing">
                            0mn
                        </td>
                        <td>{{ cra.taux_cra }}%</td>
                        <td>
                            <button pButton pRipple label="Afficher CRA" class="p-button-success p-button-outlined mb-2"
                                (click)="historiqueCraSelected = cra; showDailySelectedCra = true"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8">Vous n'avez aucun pointage enregistré pour le moment.</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="loadingbody">
                    <tr>
                        <td colspan="8">Chargement de votre historique, merci de patienter...</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-tabPanel>
        <p-tabPanel header="Calendrier">
            <p-fullCalendar #calendar [events]="eventsRH" [options]="optionsRH">
            </p-fullCalendar>
            <p-dialog class="grid" header="Détails de l'événement" [(visible)]="displayData" [modal]="true"
                [style]="{width: '75vw'}">
                <div class="col-12 grid">
                    <div class="col-12">
                        <p>
                            {{dataEvent?.note}}
                        </p>
                    </div>
                </div>
            </p-dialog>
        </p-tabPanel>
        <p-tabPanel header="Mes favoris">
            <div class="card" *ngIf="showForm">
                <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
                    (click)="showForm=false;addLinkForm.reset()" aria-hidden="true"> </i>
                <h4 style="text-align: center;">Ajouter un lien</h4>
                <div style="text-align: center;">
                    <small>Tous les champs marqués d'un astérisque <span style="color: red;"> * </span> sont
                        obligatoires</small><br>
                </div>
                <br>
                <form class="p-fluid p-formgrid grid" [formGroup]="addLinkForm" (ngSubmit)="saveLink()">
                    <div class="field col-12 md:col-6">
                        <label for="libelle">Libellé <span style="color: red;"> * </span></label>
                        <input pInputText id="libelle" type="text" formControlName="libelle" placeholder="Google" />
                    </div>
                    <div class="field col-12 md:col-6">
                        <label for="link">Lien <span style="color: red;"> * </span></label>
                        <input pInputText id="link" type="text" formControlName="link" placeholder="google.fr" />
                    </div>
                    <div style="justify-content: right;">
                        <button pButton label="Ajouter" type="submit" [disabled]="addLinkForm.invalid"></button>
                    </div>
                </form>
            </div>
            <div class="card">
                <button (click)="showForm=true;addLinkForm.reset()" pButton icon="pi pi-plus"
                    label="Ajouter un nouveau lien" style="width:auto;float:right"></button>
                <div class="grid" *ngIf="dashboard">
                    <div class="field col-12 md:col-3 grid" *ngFor="let link of dashboard.links; let i = index">
                        <a class="col-11" href="{{link.link}}" target="_blank">{{link.label}}</a>
                        <i class="col-1 pi pi-trash"
                            style="font-size: 20px; color: red; cursor: pointer; margin-left: 1%;"
                            (click)="deleteLink(i)" aria-hidden="true"> </i>
                    </div>
                </div>
            </div>
        </p-tabPanel>
        </p-tabView>
    </div>
</div>


<!--<div *ngIf="dashboard">
    <div class="card" *ngIf="showForm">
        <i class="pi pi-times-circle" style="float:right; font-size: 20px; color: red; cursor: pointer;"
            (click)="showForm=false;addLinkForm.reset()" aria-hidden="true"> </i>
        <h4 style="text-align: center;">Ajouter un lien</h4>
        <div style="text-align: center;">
            <small>Tous les champs marqués d'un astérisque <span style="color: red;"> * </span> sont
                obligatoires</small><br>
        </div>
        <br>
        <form class="p-fluid p-formgrid grid" [formGroup]="addLinkForm" (ngSubmit)="saveLink()">
            <div class="field col-12 md:col-6">
                <label for="libelle">Libellé <span style="color: red;"> * </span></label>
                <input pInputText id="libelle" type="text" formControlName="libelle" placeholder="Google" />
            </div>
            <div class="field col-12 md:col-6">
                <label for="link">Lien <span style="color: red;"> * </span></label>
                <input pInputText id="link" type="text" formControlName="link" placeholder="google.fr" />
            </div>
            <div style="justify-content: right;">
                <button pButton label="Ajouter" type="submit" [disabled]="addLinkForm.invalid"></button>
            </div>
        </form>
    </div>
    <div class="card">
        <button (click)="showForm=true;addLinkForm.reset()" pButton icon="pi pi-plus" label="Ajouter un nouveau lien"
            style="width:auto;float:right"></button>
        <h2>Tableau de bord personnel</h2>
        <div class="grid">
            <div class="field col-12 md:col-3 grid" *ngFor="let link of dashboard.links; let i = index">
                <a class="col-11" href="{{link.link}}" target="_blank">{{link.label}}</a>
                <i class="col-1 pi pi-trash" style="font-size: 20px; color: red; cursor: pointer; margin-left: 1%;"
                    (click)="deleteLink(i)" aria-hidden="true"> </i>
            </div>
        </div>
    </div>
</div>-->