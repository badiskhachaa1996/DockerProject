<div class="p-grid mt-2" *ngIf="showFormUpdate">
    <div class="xl:col-8 xl:col-offset-2 col-12" *ngIf="isModify">
        <p-card>
            <div class="p-grid">
                <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="toggleFormUpdate()"></i>
                <form class="col-8 col-offset-2" [formGroup]="TicketForm">
                    <!--<div class="text-center"><img src="assets/layout/images/logo.png" class="logo"></div>-->
                    <h3 class="text-center">Modification d'un ticket</h3>
                    <div class="grid">
                        <div class="field col mt-2 mb-2 col-lg-6 col-6">
                            <label style="color: #3da827; font-weight: bold;">Service:</label>

                            <select formControlName="service" class="form-control col-12" >
                                <option [ngValue]="null" disabled>Choissisez un service</option>
                                <option *ngFor="let service of listServices" [ngValue]="service">
                                    {{ service.label }}
                                </option>
                            </select>
                        </div>
                        <div class="field col mt-2 mb-2 col-lg-6 col-6">
                            <label style="color: #3da827; font-weight: bold;">Sujet:</label>
                            <select [disabled]="!TicketForm.value.service" formControlName="sujet"
                                class="form-control col-12">
                                <option [ngValue]="null" disabled>Choissisez un sujet</option>
                                <option *ngFor="let sujet of listSujetSelected[TicketForm.value.service._id]"
                                    [ngValue]="sujet">{{ sujet.label }}</option>
                            </select>
                        </div>
                        <div class="col-offset-5 md:col-offset-5 sm:col-offset-4">
                            <button pButton class="ui-button-raised ui-button-success" [disabled]="TicketForm.invalid"
                                label="Enregistrer" (click)="modifyTicket()"></button>
                        </div>
                    </div>
                </form>
            </div>
        </p-card>
    </div>
</div>
<div class="p-grid mt-2" *ngIf="showFormAddComment">
    <div class="xl:col-8 xl:col-offset-2 col-12">
        <p-card>
            <div class="p-grid">
                <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="toggleFormCancel()"> </i>
                <form class="col-10 col-offset-1" [formGroup]="commentForm" enctype="multipart/form-data">
                    <h3 class="text-center" style="color: #3da827; font-weight: bold;">Envoyer un message</h3>
                    <div class="text-center">
                        <textarea formControlName="description" rows="5" cols="100" pInputTextarea
                            autoResize="autoResize" placeholder="Saisir un message"></textarea>
                    </div><br>
                    <label style="color: #3da827; font-weight: bold; margin-left: 710px;">Statut du ticket :     </label>
                    <div style="margin-left: 130px;">
                        <p-fileUpload #fubauto (uploadHandler)="onFileChange($event)" mode="basic" chooseLabel="Joindre un fichier"
                            customUpload="true" fileLimit="1" accept=".docx,.pdf,.doc,.jpg,.png,.jpeg"
                            maxFileSize="20000000" [auto]="true" >
                        </p-fileUpload>
                        <span style="margin-left: 370px;">
                            <p-dropdown formControlName="statut" [options]="statutList" optionLabel="value"></p-dropdown>
                        </span>
                    </div>
                    <div *ngIf="value.invalid">
                        <span class="error" *ngIf="value.errors?.maxlength">*Le fichier est trop volumineux (20MB max).</span>
                    </div><br>
                    <div class="text-center">
                        <button [disabled]="commentForm.invalid || loading" pButton class="ui-button-raised ui-button-success" label="Envoyer" (click)="SendComment()"></button>
                    </div>
                </form>
            </div>
        </p-card>
    </div>
</div>
<div class="p-grid mt-2" *ngIf="showRevert!=null">
    <div class="xl:col-8 xl:col-offset-2 col-12">
        <p-card>
            <div class="p-grid">
                <i class="pi pi-times" style="float:right; font-size: 20px;" (click)="showRevert=null"> </i>
                <form class="col-10 col-offset-1" [formGroup]="RevertForm" enctype="multipart/form-data">
                    <h3 class="text-center" style="color: #3da827; font-weight: bold;">Renvoyer un ticket à la queue d'entrée</h3><br>
                    <label style="color: #3da827; font-weight: bold; margin-left: 135px;">Justificatif</label>
                    <div class="text-center"><br>
                        <textarea formControlName="justificatif" rows="5" cols="100" pInputTextarea autoResize="autoResize" placeholder="Saisir un message" placeholder="Expliquer la raison de votre renvoie"></textarea>
                    </div><br>
                    <div class="text-center">
                        <button class="col-offset-5 xl:col-offset-5 sm:col-offset-4" [disabled]="RevertForm.invalid" pButton class="ui-button-raised ui-button-success" label="Envoyer" (click)="revert()"></button>
                    </div>
                </form>
            </div>
        </p-card>
    </div>
</div>
<div class="grid">
    <div class="col-10 col-offset-1">
        <h3>Queue d'entrée</h3>
        <div class="col-12 card shadow-lg my-5">
            <p-table #dt1 
            *ngIf="queueList" 
            [columns]="cols" 
            [value]="queueList" 
            dataKey="_id" 
            [rows]="4" 
            [paginator]="true"
            [pageLinks]="5" 
            [responsive]="true" 
            rowExpandMode="single" 
            [totalRecords]="queueList.length"
            [globalFilterFields]="['sujet_id','description','date_ajout']"
            (sortFunction)="customSort($event)" [customSort]="true">

            <ng-template pTemplate="caption">
                <div class="p-d-flex" style="text-align: right">
                    <span class="p-input-icon-left p-ml-auto">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Recherche" />
                    </span>
                </div>
            </ng-template>
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th style="width: 3rem"> </th>

                        <th style="text-decoration: underline;" pSortableColumn="service"> Service <p-sortIcon field="service"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;">  Sujet
                        </th>
                        <th style="text-decoration: underline;" pSortableColumn="date_ajout">  Date de création <p-sortIcon field="date_ajout"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;">  Temps d'attente
                        </th>
                        <th style="text-decoration: underline;">
                            Action
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
                    <tr (onDragStart)="dragStart($event, rowData)" (onDragEnd)="dragEnd($event)"
                        *ngIf="sujetList[rowData.sujet_id]">
                        <td>
                            <button type="button" pButton [pRowToggler]="rowData" class="expanded"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        </td>
                        <td>
                            {{serviceList[sujetList[rowData.sujet_id].service_id]}}
                        </td>
                        <td>
                            {{sujetList[rowData.sujet_id].label}}
                        </td>
                        <td>
                            {{rowData.date_ajout | date:'dd/MM/yyyy HH:mm'}}
                        </td>
                        <td>
                            {{showWaitingTime(rowData)}}
                        </td>
                        <td>
                            <i pTooltip="Accepter" tooltipPosition="bottom" class="pi pi-check"
                                (click)="QueueToAccAff(rowData)"></i>
                                <!--*ngIf="rowData.createur_id!=token['id']"-->
                            <i pTooltip="Modifier" tooltipPosition="bottom" style="margin-left: 5%;"
                                class="pi pi-pencil" (click)="modify(rowData)"></i>
                            <i pTooltip="Affecter" tooltipPosition="bottom" style="margin-left: 5%;"
                                *ngIf="isReponsable" class="pi pi-user-plus" (click)="showDropdownUser(rowData)"></i>
                            <p-dropdown *ngIf="showDropDown && showDropDown==rowData" [options]="userList"
                                optionLabel="firstname" (onChange)="Affected($event)"
                                placeholder="Choissisez un agent">
                            </p-dropdown>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="rowexpansion" let-rowData>
                    <tr style="text-align: left; margin-left: 2em; background-color:white;">
                        <td [attr.colspan]="6">
                            <p-fieldset legend="Informations du ticket"
                                [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal;">
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Statut:</b>
                                        </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.statut}} </div>
                                    </div>
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b
                                                style="text-align:left !important;">Description:</b> </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.description}}</div>
                                    </div>
                                </div>
                            </p-fieldset>

                            <p-fieldset legend="Créateur du ticket" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal">
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Nom et
                                                    Prénom:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].firstname |
                                                titlecase }} {{userDic[rowData.createur_id].lastname | titlecase
                                                }}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Téléphone:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].phone}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    mail:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].email}}</div>
                                        </div>
                                    </div>
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    postale:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].adresse}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Rôle:</b>
                                            </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{(userDic[rowData.createur_id].role=='user')?'Utilisateur':userDic[rowData.createur_id].role}}</div>
                                        </div>
                                        <div *ngIf="userDic[rowData.createur_id].service_id" class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Service:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{serviceDic[userDic[rowData.createur_id]?.service_id]?.label}}</div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset *ngIf="rowData.isReverted" legend="Informations du renvoie"
                                [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal;">
                                    <div class="ui-g-4 ui-md-4">
                                        <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Envoyeur:</b>
                                        </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{userDic[rowData.user_revert].firstname |
                                                titlecase }} {{userDic[rowData.user_revert].lastname | titlecase
                                                }} </div>
                                    </div>
                                    <div class="ui-g-4 ui-md-4">
                                        <div class="ui-g-6 ui-md-6"><b
                                                style="text-align:left !important;">Justificatif:</b> </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.justificatif}}</div>
                                    </div>
                                    <div class="ui-g-4 ui-md-4">
                                        <div class="ui-g-6 ui-md-6"><b
                                                style="text-align:left !important;">Date:</b> </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.date_revert | date:'dd/MM/yyyy HH:mm'}}</div>
                                    </div>
                                </div>
                            </p-fieldset>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>
<div class="grid">
    <div class="col-10 col-offset-1">
        <h3>Mes tickets </h3>
        <div class="col-12 card shadow-lg my-5">
            <p-table 
            #dt2 
            *ngIf="AccAffList" 
            [columns]="cols" 
            [value]="AccAffList" 
            pDroppable="QueueToAccAff"
                (onDrop)="dragQueueToAccAff($event)" 
                dataKey="_id" 
                rowExpandMode="single" 
                [rows]="4" 
                [paginator]="true"
                [pageLinks]="5" 
                [responsive]="true" 
                [totalRecords]="AccAffList.length" 
                [globalFilterFields]="['sujet_id','description','date_affec_accep','statut']"  
                (sortFunction)="customSort($event)" [customSort]="true">
    
                <ng-template pTemplate="caption">
                    <div class="p-d-flex" style="text-align: right">
                        <span class="p-input-icon-left p-ml-auto">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt2.filterGlobal($event.target.value, 'contains')" placeholder="Recherche"/>
                        </span>
                    </div>
                </ng-template>

               <div id="top">
                <ng-template pTemplate="header" let-columns >
                    <tr>
                        <th style="width: 3rem"></th>
                        <th style="text-decoration: underline;" pSortableColumn="service">
                            Service <p-sortIcon field="service"></p-sortIcon>
                            <p-dropdown filter="true" placeholder="Tous" [options]="dropdownService"  ></p-dropdown>
                        </th>
                        <th style="text-decoration: underline;">  Sujet
                        </th>
                        <th style="text-decoration: underline;"pSortableColumn="date_affec_accep">  Date d'acceptation
                            
                            <p-sortIcon field="date_affec_accep"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;">
                            Temps de traitement
                        </th>
                        <th style="text-decoration: underline;" pSortableColumn="isAffected">
                            Désignation <p-sortIcon field="isAffected"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;">
                        
                            <span>
                                Statut

                            </span>
                        </th>
                        <th style="text-decoration: underline;">
                            Action
                        </th>
                    </tr>
                    
                </ng-template>
            </div>
                <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
                    <tr (onDragStart)="dragStart($event, rowData)" (onDragEnd)="dragEnd($event)"
                        *ngIf="sujetList[rowData.sujet_id]"  [pSelectableRow]="rowData">
                        <td>
                            <button type="button" pButton [pRowToggler]="rowData" class="expanded"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                (click)='loadMessages(rowData)'></button>
                        </td>
                        <td>
                            {{serviceList[sujetList[rowData.sujet_id].service_id]}}
                        </td>
                        <td>
                            {{sujetList[rowData.sujet_id].label}}
                        </td>
                        <td>
                            {{rowData.date_affec_accep | date:'dd/MM/yyyy HH:mm'}}
                        </td>
                        <td>
                            {{showWorkingTime(rowData)}}
                        </td>

                        <td *ngIf="rowData.isAffected">
                            Affecté
                        </td>
                        <td *ngIf="!rowData.isAffected">
                            Accepté
                        </td>
                        <td  [pSelectableRow]="rowData">
                            {{rowData.statut}}
                        </td>
                        <td>
                            <!--<i style="margin-left: 30%;" class="pi pi-arrow-right"
                                (click)="ListToPreInscrit(rowData)"></i>-->
                            <i pTooltip="Traiter" class="pi pi-cog" (click)="toggleFormCommentAdd(rowData) "> </i>
                            <i pTooltip="Renvoyer le ticket  dans la queue d'entrée" class="pi pi-replay" (click)="toggleRevertForm(rowData)"></i>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-rowData>
                    <tr style="text-align: left; margin-left: 2em; background-color:white;">
                        <td [attr.colspan]="7">
                            <p-fieldset legend="Informations du ticket"
                                [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal;">
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Statut:</b>
                                        </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.statut}} </div>
                                    </div>
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b
                                                style="text-align:left !important;">Description:</b> </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.description}}</div>
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset legend="Créateur du ticket" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal">
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Nom et
                                                    Prénom:</b></div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].firstname | titlecase }}
                                                {{userDic[rowData.createur_id].lastname | titlecase}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Téléphone:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].phone}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;"> Adresse
                                                    mail:</b></div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].email}}</div>
                                        </div>
                                    </div>
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    postale:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].adresse}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Rôle:</b>
                                            </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{(userDic[rowData.createur_id].role=='user')?'Utilisateur':userDic[rowData.createur_id].role}}</div>
                                        </div>
                                        <div *ngIf="userDic[rowData.createur_id].service_id" class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                <b
                                                    style="text-align:left !important;">Service:</b> 
                                            </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{serviceDic[userDic[rowData.createur_id]?.service_id]?.label}}</div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset *ngIf="comments && comments.length!=0" legend="Messages" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="badyT">

                                    <p-table
                                    [value]="comments" dataKey="id">
                                        <ng-template pTemplate="body" let-message>
                    <tr *ngIf="message.user_id!=token['id']">
                        <td>
                            <span class="ui-g-6 ui-md-6">
                                <div class="ui-g-12 ui-md-12">

                                    <button *ngIf="message.document" class="pi pi-paperclip ui-g-1 ui-md-1" id="charger2"
                                        (click)="downloadFile(message)"><i class="fa fa-spinner fa-spin fa-fw"
                                            *ngIf="loadingMessage==message._id"></i></button>

                                    <span class="ui-g-11 ui-md-11" id="messageUser"> {{message.description}} </span>

                                </div>

                                <span id="soustitre" class="ui-g-11 ui-md-11" >
                                    {{userDic[message.user_id].firstname}} {{userDic[message.user_id].lastname}} : {{(userDic[message.user_id].role=='user')?'Utilisateur':userDic[message.user_id].role}} {{message.date_ajout | date:'dd/MM/yyyy HH:mm'}}                      
                                </span>
                            </span>
                        </td>
                    </tr>

                    <tr *ngIf="message.user_id==token['id']">
                        <td>
                            <span class="ui-g-6 ui-md-6" style="float: right;">
                                <div class="ui-g-12 ui-md-12">
                                    <button *ngIf="message.document" class="pi pi-paperclip ui-g-1 ui-md-1"
                                        id="charger2" (click)="downloadFile(message)">
                                        <i class="fa fa-spinner fa-spin fa-fw" *ngIf="loadingMessage==message._id">
                                        </i>
                                    </button>
                                    <span class="ui-g-12 ui-md-11" id="messageAgent"> {{message.description}} </span>
                                </div>
                                <span id="soustitre" class=" ui-g-11 ui-md-11">
                                    {{userDic[message.user_id].firstname}} {{userDic[message.user_id].lastname}} :  {{(userDic[message.user_id].role=='user')?'Utilisateur':userDic[message.user_id].role}}   {{message.date_ajout | date:'dd/MM/yyyy HH:mm'}} 
                                   
                                </span>

                            </span>
                        </td>
                    </tr>

                </ng-template>

            </p-table>
        </div>
        </p-fieldset>
        </td>
        </tr>
        </ng-template>
        </p-table>
    </div>
</div>
</div>

<div class="grid">
    <div class="col-10 col-offset-1">
        <h3 *ngIf="token['role']!='Admin'">Les tickets de mon service</h3>
        <h3 *ngIf="token['role']=='Admin'">Les tickets de tous les services</h3>
        <div class="col-12 card shadow-lg my-5">
            <p-table #dt3 *ngIf="AccAffList" 
            [columns]="cols" 
            [value]="allTickets" 
            dataKey="_id" 
            rowExpandMode="single"
            [rows]="4" [paginator]="true"
            [pageLinks]="5" 
            [responsive]="true" 
            [totalRecords]="allTickets.length"  
            [globalFilterFields]="['sujet_id','statut','date_ajout','description','createur_id']"  
            (sortFunction)="customSort($event)" [customSort]="true">

            <ng-template pTemplate="caption"> 
                <div class="p-input-icon-left p-ml-auto" id="container">
                    <div id="left">
                    <p-dropdown filter="true" [options]="statutList"  optionLabel="value" (onChange)="testFilter($event)" >
                    </p-dropdown>
                    </div>
                    <div id="right" >
                        <i class="pi pi-search" ></i>
                        <input pInputText type="text" (input)="dt3.filterGlobal($event.target.value, 'contains')" placeholder="Recherche" />
                    </div>
                    </div>  
                </ng-template>
            
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th style="width: 3rem"></th>
                        <th style="text-decoration: underline;" pSortableColumn="service">
                            Service <p-sortIcon field="service"></p-sortIcon>
                            
                        </th>
                        <th style="text-decoration: underline;">  Sujet
                        </th>
                        <th style="text-decoration: underline;"pSortableColumn="date_affec_accep">  Date d'acceptation <p-sortIcon field="date_affec_accep"></p-sortIcon>

                        </th>
                        <th style="text-decoration: underline;">
                            Temps de traitement
                        </th>
                        <th style="text-decoration: underline;" pSortableColumn="agent">
                            Agent <p-sortIcon field="agent"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;" pSortableColumn="isAffected">
                            Désignation <p-sortIcon field="isAffected"></p-sortIcon>
                        </th>
                        <th style="text-decoration: underline;">
                            Statut
                        </th>
                        <th *ngIf="token['role']!='Agent'">
                            Action
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
                    <tr *ngIf="sujetList[rowData.sujet_id]">
                        <td>
                            <button type="button" pButton [pRowToggler]="rowData" class="expanded"
                                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                (click)='loadMessages(rowData)'></button>
                        </td>
                        <td>
                            {{serviceList[sujetList[rowData.sujet_id].service_id]}}
                        </td>
                        <td>
                            {{sujetList[rowData.sujet_id].label}}
                        </td>
                        <td>
                            {{rowData.date_affec_accep | date:'dd/MM/yyyy HH:mm'}}
                        </td>
                        <td>
                            {{showWorkingTime(rowData)}}
                        </td>
                        <td *ngIf="userDic[rowData.agent_id]">
                            {{userDic[rowData.agent_id].firstname}} {{userDic[rowData.agent_id].lastname}}
                        </td>
                        <td *ngIf="rowData.isAffected">
                            Affecté
                        </td>
                        <td *ngIf="!rowData.isAffected">
                            Accepté
                        </td>
                        <td>
                            {{rowData.statut}}
                        </td>
                        <td *ngIf="token['role']!='Agent'">
                            <i pTooltip="Renvoyer le ticket dans la queue d'entrée" class=" pi pi-replay" (click)="toggleRevertForm(rowData)"></i>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-rowData>
                    <tr style="text-align: left; margin-left: 2em; background-color:white;">
                        <td [attr.colspan]="(token['role']!='Agent')? 9 : 8">
                            <p-fieldset legend="Informations du ticket"
                                [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal;">
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Statut:</b>
                                        </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.statut}} </div>
                                    </div>
                                    <div class="ui-g-6 ui-md-6">
                                        <div class="ui-g-6 ui-md-6"><b
                                                style="text-align:left !important;">Description:</b> </div>
                                        <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                            {{rowData.description}}</div>
                                      
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset legend="Créateur du ticket" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal">
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Nom
                                                    et Prénom:</b></div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].firstname | titlecase }}
                                                {{userDic[rowData.createur_id].lastname | titlecase}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Téléphone:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].phone}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    mail:</b></div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].email}}</div>
                                        </div>
                                    </div>
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    postale:</b></div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.createur_id].adresse}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Rôle:</b>
                                            </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{(userDic[rowData.createur_id].role=='user')?'Utilisateur':userDic[rowData.createur_id].role}}</div>
                                        </div>
                                        <div *ngIf="userDic[rowData.createur_id].service_id" class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Service:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{serviceDic[userDic[rowData.createur_id]?.service_id].label}}</div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset legend="Agent du ticket" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="p-grid ui-fluid" style="color: black;font-weight:normal">
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Nom et
                                                    Prénom:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.agent_id].firstname | titlecase }}
                                                {{userDic[rowData.agent_id].lastname | titlecase}}
                                            </div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Téléphone:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.agent_id].phone}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    mail:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.agent_id].email}}</div>
                                        </div>
                                    </div>
                                    <div class="ui-g-12 ui-md-12">
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Adresse
                                                    postale:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.agent_id].adresse}}</div>
                                        </div>
                                        <div class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b style="text-align:left !important;">Rôle:</b>
                                            </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{userDic[rowData.agent_id].role}}</div>
                                        </div>
                                        <div *ngIf="serviceDic[userDic[rowData.agent_id].service_id]"
                                            class="ui-g-12 ui-md-4">
                                            <div class="ui-g-6 ui-md-6"><b
                                                    style="text-align:left !important;">Service:</b> </div>
                                            <div class="ui-g-6 ui-md-6" style="text-align:left !important;">
                                                {{serviceDic[userDic[rowData.agent_id]?.service_id].label}}</div>
                                        </div>
                                    </div>
                                </div>
                            </p-fieldset>
                            <p-fieldset *ngIf="comments && comments.length!=0" legend="Messages" [style]="{'color':'green','font-weight': 'bold'}">
                                <div class="badyT">

                                    <p-table [value]="comments" dataKey="id">
                                        <ng-template pTemplate="body" let-message>
                    <tr *ngIf="message.user_id==rowData.createur_id">
                        <td>
                            <span class="ui-g-6 ui-md-6">
                                <div class="ui-g-12 ui-md-12">

                                    <button *ngIf="message.document" class="pi pi-paperclip ui-g-1 ui-md-1" id="charger2"
                                        (click)="downloadFile(message)"><i class="fa fa-spinner fa-spin fa-fw"
                                            *ngIf="loadingMessage==message._id"></i></button>

                                    <span class="ui-g-11 ui-md-11" id="messageUser"> {{message.description}} </span>

                                </div>

                                <span id="soustitre" class="ui-g-11 ui-md-11" >
                                    {{userDic[message.user_id].firstname}} {{userDic[message.user_id].lastname}} : {{(userDic[message.user_id].role=='user')?'Utilisateur':userDic[message.user_id].role}} {{message.date_ajout | date:'dd/MM/yyyy HH:mm'}}                      
                                </span>
                            </span>
                        </td>
                    </tr>

                    <tr *ngIf="message.user_id!=rowData.createur_id">
                        <td>
                            <span class="ui-g-6 ui-md-6" style="float: right;">
                                <div class="ui-g-12 ui-md-12">
                                    <button *ngIf="message.document" class="pi pi-paperclip ui-g-1 ui-md-1"
                                        id="charger2" (click)="downloadFile(message)">
                                        <i class="fa fa-spinner fa-spin fa-fw" *ngIf="loadingMessage==message._id">
                                        </i>
                                    </button>
                                    <span class="ui-g-12 ui-md-11" id="messageAgent"> {{message.description}} </span>
                                </div>
                                <span id="soustitre" class=" ui-g-11 ui-md-11">
                                    {{userDic[message.user_id].firstname}} {{userDic[message.user_id].lastname}} :  {{(userDic[message.user_id].role=='user')?'Utilisateur':userDic[message.user_id].role}}   {{message.date_ajout | date:'dd/MM/yyyy HH:mm'}} 
                                   
                                </span>

                            </span>
                        </td>
                    </tr>

                </ng-template>

            </p-table>
        </div>
        </p-fieldset>
            </td>
            </tr>
            </ng-template>
            </p-table>
        </div>
    </div>
</div>